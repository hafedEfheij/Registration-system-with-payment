<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة كروت الدفع المسبق - جامعة الحاضرة</title>
    <link rel="stylesheet" href="../css/styles.css">
    <!-- Bootstrap RTL CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="../css/responsive.css">
    <style>
        .card-number {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background-color: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
        }
        .card-value {
            font-weight: 600;
            color: #28a745;
            background: rgba(40, 167, 69, 0.08);
            padding: 5px 12px;
            border-radius: 18px;
            border: 1px solid rgba(40, 167, 69, 0.25);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            min-width: 75px;
            justify-content: center;
            line-height: 1.3;
        }
        .card-status-used {
            color: #dc3545;
            font-weight: 600;
            background: rgba(220, 53, 69, 0.08);
            padding: 5px 12px;
            border-radius: 18px;
            border: 1px solid rgba(220, 53, 69, 0.25);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            min-width: 75px;
            justify-content: center;
            line-height: 1.3;
        }
        .card-status-available {
            color: #28a745;
            font-weight: 600;
            background: rgba(40, 167, 69, 0.08);
            padding: 5px 12px;
            border-radius: 18px;
            border: 1px solid rgba(40, 167, 69, 0.25);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            min-width: 75px;
            justify-content: center;
            line-height: 1.3;
        }
        .card-status-sold {
            color: #28a745;
            font-weight: 600;
            background: rgba(40, 167, 69, 0.08);
            padding: 5px 12px;
            border-radius: 18px;
            border: 1px solid rgba(40, 167, 69, 0.25);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            min-width: 75px;
            justify-content: center;
            line-height: 1.3;
        }

        .card-status-not-sold {
            color: #6c757d;
            font-weight: 600;
            background: rgba(108, 117, 125, 0.08);
            padding: 5px 12px;
            border-radius: 18px;
            border: 1px solid rgba(108, 117, 125, 0.25);
            text-decoration: line-through;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            min-width: 75px;
            justify-content: center;
            line-height: 1.3;
            white-space: nowrap;
        }

        /* Search and Filter Styles */
        #search-filter-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        #search-filter-section .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        #search-filter-section .form-control,
        #search-filter-section .form-select {
            border: 1px solid #ced4da;
            border-radius: 6px;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        #search-filter-section .form-control:focus,
        #search-filter-section .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        #filter-results-summary {
            margin-bottom: 0;
            border: 1px solid #b8daff;
            background-color: #d1ecf1;
            color: #0c5460;
        }

        #filter-results-summary .fas {
            color: #007bff;
        }

        .btn-outline-secondary {
            border-color: #6c757d;
            color: #6c757d;
        }

        .btn-outline-secondary:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: #fff;
        }

        /* Professional Button Styles */
        .btn-professional {
            font-weight: 600;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            min-width: 140px;
            height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-professional:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-professional:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-professional.btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border-color: #007bff;
            color: white;
        }

        .btn-professional.btn-primary:hover {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
            border-color: #0056b3;
        }

        .btn-professional.btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            border-color: #28a745;
            color: white;
        }

        .btn-professional.btn-success:hover {
            background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
            border-color: #1e7e34;
        }

        .btn-professional.btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border-color: #dc3545;
            color: white;
        }

        .btn-professional.btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
            border-color: #c82333;
        }

        .btn-professional.btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            border-color: #ffc107;
            color: #212529;
        }

        .btn-professional.btn-warning:hover {
            background: linear-gradient(135deg, #e0a800 0%, #d39e00 100%);
            border-color: #e0a800;
        }

        .btn-professional.btn-light {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-color: #f8f9fa;
            color: #495057;
        }

        .btn-professional.btn-light:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border-color: #e9ecef;
            color: #495057;
        }

        .btn-professional.btn-outline-light {
            background: transparent;
            border-color: rgba(255,255,255,0.5);
            color: white;
        }

        .btn-professional.btn-outline-light:hover {
            background: rgba(255,255,255,0.1);
            border-color: white;
            color: white;
        }

        .btn-professional.btn-outline-secondary {
            background: transparent;
            border-color: #6c757d;
            color: #6c757d;
        }

        .btn-professional.btn-outline-secondary:hover {
            background: #6c757d;
            border-color: #6c757d;
            color: white;
        }

        /* Button Groups */
        .btn-group-professional .btn-professional {
            margin-right: 8px;
        }

        .btn-group-professional .btn-professional:last-child {
            margin-right: 0;
        }

        /* Small buttons for headers and table actions */
        .btn-professional.btn-sm {
            padding: 8px 16px;
            font-size: 13px;
            min-width: 100px;
            height: 36px;
        }

        /* Medium buttons for secondary actions */
        .btn-professional.btn-md {
            padding: 10px 20px;
            font-size: 14px;
            min-width: 130px;
            height: 42px;
        }

        /* Large buttons for main actions */
        .btn-professional.btn-lg {
            padding: 14px 28px;
            font-size: 15px;
            min-width: 150px;
            height: 50px;
        }

        /* Extra small buttons for table actions */
        .btn-professional.btn-xs {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 80px;
            height: 32px;
        }

        /* Override all button styles to use professional styling */
        .btn:not(.btn-professional) {
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn:not(.btn-professional):hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .generate-cards-section {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border-radius: 15px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0,123,255,0.15);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .settings-section {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            border-radius: 15px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(40,167,69,0.15);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Generation type styles */
        .generation-section {
            transition: all 0.5s ease-in-out;
            opacity: 1;
        }

        .generation-section.d-none {
            opacity: 0;
            transform: translateY(-20px);
        }

        .btn-check:checked + .btn-professional.btn-outline-light {
            background: rgba(255, 255, 255, 0.25);
            border-color: white;
            color: white;
            box-shadow: 0 4px 15px rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .btn-professional.btn-outline-light:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: white;
            color: white;
        }

        /* Enhanced Generation Type Buttons */
        .btn-group .btn-professional {
            flex: 1;
            padding: 1.5rem;
            text-align: center;
        }

        .btn-group .btn-professional .d-flex {
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-group .btn-professional small {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        #custom-numbers-input {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .validation-success {
            background-color: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            border-radius: 0.375rem;
            padding: 0.75rem;
            color: #155724;
        }

        .validation-error {
            background-color: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            border-radius: 0.375rem;
            padding: 0.75rem;
            color: #721c24;
        }

        .validation-warning {
            background-color: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            border-radius: 0.375rem;
            padding: 0.75rem;
            color: #856404;
        }

        /* منع الوميض عند تحميل الصفحة */
        .admin-only, .student-only, .financial-only {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.1s ease-in-out;
        }

        /* إظهار العناصر بعد تحديد الدور */
        .admin-only.show, .student-only.show, .financial-only.show {
            visibility: visible;
            opacity: 1;
        }

        /* إخفاء عناصر الأدمن من البداية للمشرف المالي */
        .admin-only:not(.financial-only) {
            display: none !important;
        }

        /* إظهار عناصر المشرف المالي دائماً */
        .financial-only {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Enhanced Card Styles */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.12);
        }

        .card-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            padding: 1.5rem;
        }

        .card-body {
            padding: 2rem;
        }

        /* Enhanced Form Controls */
        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 12px 16px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.15);
            transform: translateY(-1px);
        }

        .input-group-text {
            border-radius: 0 8px 8px 0;
            border: 2px solid #e9ecef;
            border-left: none;
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        /* Enhanced Labels */
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }

        /* Enhanced Table */
        .table {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .table thead th {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            border: none;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.3px;
            padding: 0.9rem 0.7rem;
            color: white;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            line-height: 1.3;
        }

        .table tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid #f1f3f4;
        }

        .table tbody tr:hover {
            background: linear-gradient(135deg, rgba(0,123,255,0.03) 0%, rgba(0,123,255,0.08) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.1);
        }

        .table tbody tr:last-child {
            border-bottom: none;
        }

        .table tbody td {
            padding: 0.7rem 0.5rem;
            vertical-align: middle;
            border: none;
            text-align: center;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Enhanced Status Badges - Already defined above */

        /* Action Buttons in Table */
        .table .btn-professional.btn-xs {
            padding: 4px 8px;
            font-size: 11px;
            min-width: 55px;
            height: 26px;
            margin: 1px;
            border-radius: 5px;
            line-height: 1.2;
        }

        /* Card Number Styling */
        .card-number {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            color: #495057;
            font-size: 12px;
            letter-spacing: 0.3px;
            line-height: 1.3;
        }

        /* Card Value Styling - Already defined above */

        /* Enhanced Alerts */
        .alert {
            border: none;
            border-radius: 10px;
            padding: 1rem 1.5rem;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
        }

        .alert-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
        }

        /* Loading Spinner Enhancement */
        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }

        /* Professional Table Styling */
        .table-compact {
            font-size: 13px;
        }

        .table-compact .card-number {
            font-size: 12px;
            padding: 5px 10px;
        }

        .table-compact .card-value,
        .table-compact .card-status-used,
        .table-compact .card-status-available,
        .table-compact .card-status-sold,
        .table-compact .card-status-not-sold {
            font-size: 12px;
            padding: 5px 12px;
            min-width: 75px;
            gap: 5px;
        }

        .table-compact .btn-professional.btn-xs {
            padding: 4px 8px;
            font-size: 11px;
            min-width: 55px;
            height: 26px;
        }

        /* Date and text styling */
        .text-muted-small {
            color: #6c757d !important;
            font-size: 11px;
            line-height: 1.3;
        }

        .text-truncate-custom {
            max-width: 130px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Responsive Improvements */
        @media (max-width: 768px) {
            .btn-group-professional {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .btn-group-professional .btn-professional {
                margin-right: 0;
                width: 100%;
            }

            .generate-cards-section,
            .card-body {
                padding: 1.5rem;
            }

            .btn-professional.btn-lg {
                padding: 12px 20px;
                font-size: 14px;
                min-width: 100%;
                height: 48px;
            }

            .btn-professional.btn-md {
                padding: 10px 16px;
                font-size: 13px;
                min-width: 100%;
                height: 42px;
            }

            .btn-professional.btn-sm {
                padding: 8px 14px;
                font-size: 12px;
                min-width: 100%;
                height: 36px;
            }

            .btn-professional.btn-xs {
                padding: 4px 8px;
                font-size: 10px;
                min-width: 60px;
                height: 26px;
            }

            /* Stack table action buttons vertically on mobile */
            .table td .btn-professional {
                display: block;
                width: 100%;
                margin: 2px 0;
            }

            /* Adjust button group in generation type selection */
            .btn-group .btn-professional {
                padding: 1rem;
                font-size: 14px;
            }

            .btn-group .btn-professional small {
                font-size: 0.7rem;
            }
        }

        /* Extra small screens */
        @media (max-width: 576px) {
            .btn-professional.btn-lg {
                padding: 10px 16px;
                font-size: 13px;
                height: 44px;
            }

            .btn-professional.btn-md {
                padding: 8px 14px;
                font-size: 12px;
                height: 38px;
            }

            .btn-professional.btn-sm {
                padding: 6px 12px;
                font-size: 11px;
                height: 32px;
            }

            .btn-professional.btn-xs {
                padding: 4px 8px;
                font-size: 10px;
                min-width: 60px;
                height: 28px;
            }

            /* Mobile-specific improvements */
            .generate-cards-section {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .card-header {
                padding: 1rem;
            }

            .card-body {
                padding: 1rem;
            }

            /* Mobile table improvements */
            .table-responsive {
                border-radius: 8px;
                overflow-x: auto;
            }

            .table {
                font-size: 12px;
                min-width: 600px;
            }

            .table thead th {
                padding: 0.5rem 0.3rem;
                font-size: 11px;
                white-space: nowrap;
            }

            .table tbody td {
                padding: 0.5rem 0.3rem;
                font-size: 12px;
            }

            /* Mobile card number styling */
            .card-number {
                font-size: 11px;
                padding: 3px 6px;
                max-width: 80px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* Mobile status badges */
            .card-value,
            .card-status-used,
            .card-status-available,
            .card-status-sold,
            .card-status-not-sold {
                font-size: 10px;
                padding: 3px 8px;
                min-width: 60px;
            }

            /* Mobile form improvements */
            .form-control,
            .form-select {
                padding: 10px 12px;
                font-size: 14px;
            }

            .input-group-text {
                padding: 10px 12px;
                font-size: 14px;
            }

            /* Mobile generation type buttons */
            .btn-group .btn-professional {
                padding: 0.75rem;
                font-size: 13px;
            }

            .btn-group .btn-professional .d-flex {
                flex-direction: column;
                gap: 0.25rem;
            }

            .btn-group .btn-professional small {
                font-size: 0.65rem;
            }

            /* Mobile textarea */
            #custom-numbers-input {
                font-size: 13px;
                rows: 4;
            }

            /* Mobile search and filter section */
            #search-filter-section {
                padding: 15px;
            }

            /* Mobile dropdown improvements */
            .dropdown-menu {
                font-size: 14px;
            }

            /* Mobile header improvements */
            .d-flex.justify-content-between.flex-wrap.flex-md-nowrap {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 1rem;
            }

            .btn-toolbar {
                width: 100%;
            }

            .dropdown {
                width: 100%;
            }

            .dropdown .btn {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* Landscape mobile improvements */
        @media (max-width: 768px) and (orientation: landscape) {
            .generate-cards-section {
                padding: 1.5rem;
            }

            .btn-professional.btn-lg {
                height: 42px;
                font-size: 13px;
            }

            .table {
                font-size: 13px;
            }
        }

        /* Tablet improvements */
        @media (min-width: 577px) and (max-width: 991px) {
            .btn-professional.btn-lg {
                min-width: 120px;
                height: 46px;
            }

            .btn-professional.btn-md {
                min-width: 110px;
                height: 40px;
            }

            .btn-professional.btn-sm {
                min-width: 90px;
                height: 34px;
            }

            .generate-cards-section {
                padding: 2rem;
            }

            .table {
                font-size: 13px;
            }

            .table thead th {
                padding: 0.7rem 0.5rem;
                font-size: 12px;
            }

            .table tbody td {
                padding: 0.6rem 0.4rem;
            }
        }

        /* Print styles */
        @media print {
            .sidebar,
            .btn-toolbar,
            .btn-group-professional,
            .generate-cards-section,
            #search-filter-section {
                display: none !important;
            }

            .card {
                border: 1px solid #000 !important;
                box-shadow: none !important;
            }

            .card-header {
                background: #f8f9fa !important;
                color: #000 !important;
            }

            .table {
                font-size: 12px;
            }

            .table thead th {
                background: #f8f9fa !important;
                color: #000 !important;
                border: 1px solid #000 !important;
            }

            .table tbody td {
                border: 1px solid #000 !important;
            }

            .card-number {
                background: #f8f9fa !important;
                border: 1px solid #000 !important;
                color: #000 !important;
            }

            .btn-professional {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../images/images.jpg" alt="شعار الجامعة" class="img-fluid mb-3" style="max-height: 80px;">
                        <h5 class="text-white">جامعة الحاضرة</h5>
                        <p class="text-white fw-bold" id="user-role-title">لوحة تحكم المشرف المالي</p>
                    </div>
                    <ul class="nav flex-column">
                        <!-- Enlaces visibles solo para administradores -->
                        <li class="nav-item admin-only" id="dashboard-nav">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i>
                                لوحة التحكم
                            </a>
                        </li>
                        <li class="nav-item admin-only" id="students-nav">
                            <a class="nav-link" href="students.html">
                                <i class="fas fa-user-graduate"></i>
                                إدارة الطلبة
                            </a>
                        </li>
                        <li class="nav-item admin-only" id="departments-nav">
                            <a class="nav-link" href="departments.html">
                                <i class="fas fa-building"></i>
                                إدارة التخصصات
                            </a>
                        </li>
                        <li class="nav-item admin-only" id="courses-nav">
                            <a class="nav-link" href="courses.html">
                                <i class="fas fa-book"></i>
                                إدارة المواد
                            </a>
                        </li>
                        <li class="nav-item admin-only" id="statistics-nav">
                            <a class="nav-link" href="course-statistics.html">
                                <i class="fas fa-chart-bar"></i>
                                إحصائيات المواد
                            </a>
                        </li>
                        <!-- Enlace visible para administradores y supervisores financieros -->
                        <li class="nav-item admin-only financial-only">
                            <a class="nav-link" href="payment-management.html">
                                <i class="fas fa-money-bill-wave"></i>
                                إدارة حالة الدفع
                            </a>
                        </li>
                        <li class="nav-item admin-only financial-only">
                            <a class="nav-link active" href="prepaid-cards.html">
                                <i class="fas fa-credit-card"></i>
                                كروت الدفع المسبق
                            </a>
                        </li>

                        <li class="nav-item financial-only" id="locked-accounts-nav">
                            <a class="nav-link" href="payment-management.html#locked-accounts-section" onclick="showLockedAccountsSection()">
                                <i class="fas fa-lock"></i>
                                الحسابات المجمدة
                            </a>
                        </li>
                        <li class="nav-item admin-only" id="profile-nav">
                            <a class="nav-link" href="profile.html">
                                <i class="fas fa-user-cog"></i>
                                إعدادات الحساب
                            </a>
                        </li>
                        <li class="nav-item mt-5">
                            <a class="nav-link text-danger" href="#" id="sidebar-logout-button">
                                <i class="fas fa-sign-out-alt"></i>
                                تسجيل الخروج
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main content -->
            <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-credit-card me-2"></i>
                        إدارة كروت الدفع المسبق
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="dropdown">
                            <button class="btn btn-professional btn-outline-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user"></i>
                                <span id="user-name">المشرف</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                                <li><a class="dropdown-item" href="profile.html">إعدادات الحساب</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logout-button">تسجيل الخروج</a></li>
                            </ul>
                        </div>
                    </div>
                </div>



                <!-- Generate Cards Section -->
                <div class="generate-cards-section text-white">
                    <h4 class="mb-3">
                        <i class="fas fa-plus-circle me-2"></i>
                        توليد كروت دفع جديدة
                    </h4>

                    <!-- Generation Type Selection -->
                    <div class="row mb-5">
                        <div class="col-12">
                            <label class="form-label fw-bold text-white mb-3">
                                <i class="fas fa-cogs me-2"></i>نوع التوليد:
                            </label>
                            <div class="btn-group w-100" role="group" aria-label="Generation type">
                                <input type="radio" class="btn-check" name="generation-type" id="auto-generation" value="auto" checked>
                                <label class="btn btn-professional btn-outline-light btn-lg" for="auto-generation">
                                    <i class="fas fa-magic me-2"></i>
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold">توليد تلقائي</span>
                                        <small class="opacity-75">أرقام عشوائية</small>
                                    </div>
                                </label>

                                <input type="radio" class="btn-check" name="generation-type" id="custom-generation" value="custom">
                                <label class="btn btn-professional btn-outline-light btn-lg" for="custom-generation">
                                    <i class="fas fa-edit me-2"></i>
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold">أرقام مخصصة</span>
                                        <small class="opacity-75">أرقام محددة مسبقاً</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Auto Generation Section -->
                    <div id="auto-generation-section" class="generation-section">
                        <div class="row g-3 g-md-4">
                            <div class="col-12 col-sm-6 col-lg-3">
                                <label for="cards-count-input" class="form-label">
                                    <i class="fas fa-hashtag me-1"></i>عدد الكروت
                                </label>
                                <input type="number" class="form-control" id="cards-count-input" min="1" max="100" value="10" placeholder="1-100">
                                <div class="form-text text-light">
                                    <small>الحد الأقصى: 100 كرت</small>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-lg-3">
                                <label for="cards-value-input" class="form-label">
                                    <i class="fas fa-coins me-1"></i>قيمة الكرت (بالدينار)
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="cards-value-input" min="1" value="5" placeholder="5">
                                    <span class="input-group-text">دينار</span>
                                </div>
                                <div class="form-text text-light">
                                    <small>الحد الأدنى: 1 دينار</small>
                                </div>
                            </div>
                            <div class="col-12 col-lg-6">
                                <label class="form-label d-none d-lg-block">&nbsp;</label>
                                <div class="btn-group-professional w-100 d-flex flex-column flex-sm-row gap-2">
                                    <button class="btn btn-professional btn-success btn-lg flex-fill" id="generate-cards-btn">
                                        <i class="fas fa-magic me-2"></i>
                                        <span class="d-none d-sm-inline">توليد الكروت</span>
                                        <span class="d-sm-none">توليد</span>
                                    </button>
                                    <button class="btn btn-professional btn-danger btn-lg" id="delete-all-cards-btn" style="min-width: 120px;">
                                        <i class="fas fa-trash-alt me-2"></i>
                                        <span class="d-none d-sm-inline">حذف الكل</span>
                                        <span class="d-sm-none">حذف</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Generation Section -->
                    <div id="custom-generation-section" class="generation-section d-none">
                        <div class="row g-3 g-md-4">
                            <div class="col-12 col-lg-8">
                                <label for="custom-numbers-input" class="form-label">
                                    <i class="fas fa-list-ol me-2"></i>أرقام الكروت المخصصة
                                </label>
                                <textarea class="form-control" id="custom-numbers-input" rows="6"
                                          placeholder="أدخل أرقام الكروت، كل رقم في سطر منفصل&#10;&#10;أمثلة:&#10;12345&#10;67890&#10;CARD001&#10;CARD002&#10;STUDENT_001"></textarea>
                                <div class="form-text text-light">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>تعليمات:</strong> أدخل كل رقم كرت في سطر منفصل. يمكن استخدام أرقام أو حروف أو مزيج منهما (3-50 حرف).
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="mb-3 mb-lg-4">
                                    <label for="custom-cards-value-input" class="form-label">
                                        <i class="fas fa-coins me-1"></i>قيمة الكرت (بالدينار)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="custom-cards-value-input" min="1" value="5" placeholder="5">
                                        <span class="input-group-text">دينار</span>
                                    </div>
                                    <div class="form-text text-light">
                                        <small>نفس القيمة لجميع الكروت</small>
                                    </div>
                                </div>

                                <div class="d-grid gap-2 gap-lg-3">
                                    <button class="btn btn-professional btn-success btn-lg" id="generate-custom-cards-btn">
                                        <i class="fas fa-plus-circle me-2"></i>
                                        <span class="d-none d-sm-inline">إنشاء الكروت</span>
                                        <span class="d-sm-none">إنشاء</span>
                                    </button>
                                    <button class="btn btn-professional btn-warning btn-lg" id="validate-numbers-btn">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <span class="d-none d-sm-inline">التحقق من الأرقام</span>
                                        <span class="d-sm-none">تحقق</span>
                                    </button>
                                </div>

                                <div id="validation-result" class="mt-3 d-none">
                                    <!-- Validation results will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cards List -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-3">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list me-2"></i>
                                <span class="d-none d-sm-inline">قائمة كروت الدفع المسبق</span>
                                <span class="d-sm-none">قائمة الكروت</span>
                            </h5>
                            <div class="btn-group-professional d-flex flex-column flex-sm-row gap-2">
                                <button type="button" class="btn btn-professional btn-light btn-sm" id="print-all-cards-btn">
                                    <i class="fas fa-print me-1"></i>
                                    <span class="d-none d-md-inline">طباعة التقرير</span>
                                    <span class="d-md-none">طباعة</span>
                                </button>
                                <button type="button" class="btn btn-professional btn-outline-light btn-sm" id="export-cards-pdf-btn">
                                    <i class="fas fa-file-pdf me-1"></i>
                                    <span class="d-none d-md-inline">تصدير PDF</span>
                                    <span class="d-md-none">PDF</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Loading Indicator -->
                        <div id="loading-indicator" class="text-center my-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                            <p class="mt-2">جاري تحميل بيانات الكروت...</p>
                        </div>

                        <!-- Error Message -->
                        <div id="error-message" class="alert alert-danger my-3 d-none" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="error-text">حدث خطأ أثناء تحميل البيانات</span>
                        </div>

                        <!-- Search and Filter Section -->
                        <div id="search-filter-section" class="mb-4 d-none">
                            <div class="row g-3">
                                <!-- Search Input -->
                                <div class="col-12 col-md-6 col-lg-4">
                                    <label for="search-input" class="form-label">
                                        <i class="fas fa-search me-1"></i>البحث في الكروت
                                    </label>
                                    <input type="text" class="form-control" id="search-input"
                                           placeholder="ابحث برقم الكرت أو اسم الطالب...">
                                </div>

                                <!-- Usage Status Filter -->
                                <div class="col-6 col-md-3 col-lg-2">
                                    <label for="usage-filter" class="form-label">
                                        <i class="fas fa-filter me-1"></i>
                                        <span class="d-none d-sm-inline">حالة الاستخدام</span>
                                        <span class="d-sm-none">الاستخدام</span>
                                    </label>
                                    <select class="form-select" id="usage-filter">
                                        <option value="all">الكل</option>
                                        <option value="used">مستخدم</option>
                                        <option value="unused">غير مستخدم</option>
                                    </select>
                                </div>

                                <!-- Sale Status Filter -->
                                <div class="col-6 col-md-3 col-lg-2">
                                    <label for="sale-filter" class="form-label">
                                        <i class="fas fa-shopping-cart me-1"></i>
                                        <span class="d-none d-sm-inline">حالة البيع</span>
                                        <span class="d-sm-none">البيع</span>
                                    </label>
                                    <select class="form-select" id="sale-filter">
                                        <option value="all">الكل</option>
                                        <option value="sold">مباع</option>
                                        <option value="not-sold">غير مباع</option>
                                    </select>
                                </div>

                                <!-- Clear Filters -->
                                <div class="col-12 col-lg-4 d-flex align-items-end">
                                    <button type="button" class="btn btn-professional btn-outline-secondary w-100" id="clear-filters-btn">
                                        <i class="fas fa-times me-1"></i>
                                        <span class="d-none d-sm-inline">مسح الفلاتر</span>
                                        <span class="d-sm-none">مسح</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Results Summary -->
                            <div class="mt-3">
                                <div class="alert alert-info" id="filter-results-summary">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <span id="results-text">جاري تحميل البيانات...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Cards Table -->
                        <div id="cards-container" class="d-none">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-compact">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 12%;">رقم الكرت</th>
                                            <th style="width: 10%;">القيمة</th>
                                            <th style="width: 12%;">حالة الاستخدام</th>
                                            <th style="width: 12%;">حالة البيع</th>
                                            <th style="width: 18%;">مستخدم بواسطة</th>
                                            <th style="width: 14%;">تاريخ الاستخدام</th>
                                            <th style="width: 14%;">تاريخ الإنشاء</th>
                                            <th style="width: 8%;">الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cards-table-body">
                                        <!-- Cards will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- No Cards Message -->
                        <div id="no-cards" class="alert alert-info my-3 d-none" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            لا توجد كروت دفع مسبق في النظام. يمكنك توليد كروت جديدة باستخدام النموذج أعلاه.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- html2pdf library for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- QRCode.js library for QR code generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Responsive JS -->
    <script src="../js/responsive.js"></script>
    <!-- Modal Fixes JS -->
    <script src="../js/modal-fixes.js"></script>
    <script src="../js/main.js"></script>
    <!-- Auto Logout JS -->
    <script src="../js/auto-logout.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Global variable to store cards data for printing/export
            let allCardsData = [];

            // Check if user is logged in first
            console.log('Checking user authentication...');
            fetch('/api/user')
                .then(response => {
                    if (!response.ok) {
                        console.log('User not authenticated, redirecting to login...');
                        window.location.href = '/login.html';
                        return null;
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data || !data.user) {
                        console.log('No user data, redirecting to login...');
                        window.location.href = '/login.html';
                        return;
                    }

                    console.log('User authenticated:', data.user);

                    if (data.user.role !== 'admin' && data.user.role !== 'financial_supervisor') {
                        console.log('User does not have required permissions');
                        alert('ليس لديك صلاحيات للوصول لهذه الصفحة');
                        window.location.href = '/';
                        return;
                    }

                    // User is authorized, initialize the page
                    initializePage();
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                    window.location.href = '/login.html';
                });

            function initializePage() {
                console.log('Initializing prepaid cards page...');

            // Global variables for filtering and searching
            let originalCardsData = []; // Store original data
            let filteredCardsData = []; // Store filtered data

            // Helper function to format date in Arabic style
            function formatDateArabic(dateString, includeTime = true) {
                if (!dateString) return 'غير محدد';

                try {
                    const date = new Date(dateString);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');

                    if (!includeTime) {
                        return `${year}/${month}/${day}`;
                    }

                    const hours = date.getHours();
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');

                    // Convert to 12-hour format with Arabic AM/PM
                    const hour12 = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
                    const ampm = hours >= 12 ? 'م' : 'ص';

                    return `${year}/${month}/${day} ${String(hour12).padStart(2, '0')}:${minutes}:${seconds} ${ampm}`;
                } catch (e) {
                    console.error('Error formatting date:', e);
                    return dateString;
                }
            }

            // Debounce function for search input
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Apply filters and search
            function applyFilters() {
                console.log('Applying filters...');

                const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
                const usageStatus = usageFilter ? usageFilter.value : 'all';
                const saleStatus = saleFilter ? saleFilter.value : 'all';

                console.log('Search term:', searchTerm);
                console.log('Usage status:', usageStatus);
                console.log('Sale status:', saleStatus);

                // Filter the original data
                filteredCardsData = originalCardsData.filter(card => {
                    // Search filter
                    let matchesSearch = true;
                    if (searchTerm) {
                        const cardNumber = (card.card_number || '').toLowerCase();
                        const studentName = (card.used_by_student_name || '').toLowerCase();
                        const studentReg = (card.used_by_student_registration || '').toLowerCase();

                        matchesSearch = cardNumber.includes(searchTerm) ||
                                       studentName.includes(searchTerm) ||
                                       studentReg.includes(searchTerm);
                    }

                    // Usage status filter
                    let matchesUsage = true;
                    if (usageStatus !== 'all') {
                        const isUsed = Boolean(card.is_used);
                        matchesUsage = (usageStatus === 'used' && isUsed) ||
                                      (usageStatus === 'unused' && !isUsed);
                    }

                    // Sale status filter
                    let matchesSale = true;
                    if (saleStatus !== 'all') {
                        const isSold = Boolean(card.is_sold);
                        matchesSale = (saleStatus === 'sold' && isSold) ||
                                     (saleStatus === 'not-sold' && !isSold);
                    }

                    return matchesSearch && matchesUsage && matchesSale;
                });

                console.log('Filtered cards:', filteredCardsData.length);

                // Update the display
                displayCards(filteredCardsData);
                updateFilterSummary();
            }

            // Clear all filters
            function clearAllFilters() {
                console.log('Clearing all filters...');

                if (searchInput) searchInput.value = '';
                if (usageFilter) usageFilter.value = 'all';
                if (saleFilter) saleFilter.value = 'all';

                // Reset to show all cards
                filteredCardsData = [...originalCardsData];
                displayCards(filteredCardsData);
                updateFilterSummary();
            }

            // Update filter results summary
            function updateFilterSummary() {
                if (!resultsText) return;

                const total = originalCardsData.length;
                const filtered = filteredCardsData.length;
                const used = filteredCardsData.filter(card => Boolean(card.is_used)).length;
                const unused = filteredCardsData.filter(card => !Boolean(card.is_used)).length;
                const sold = filteredCardsData.filter(card => Boolean(card.is_sold)).length;
                const notSold = filteredCardsData.filter(card => !Boolean(card.is_sold)).length;

                let summaryText = `عرض ${filtered} من أصل ${total} كرت`;

                if (filtered > 0) {
                    summaryText += ` | مستخدم: ${used} | غير مستخدم: ${unused} | مباع: ${sold} | غير مباع: ${notSold}`;
                }

                resultsText.textContent = summaryText;
            }

            // Elements
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const cardsContainer = document.getElementById('cards-container');
            const noCards = document.getElementById('no-cards');
            const cardsTableBody = document.getElementById('cards-table-body');
            const generateCardsBtn = document.getElementById('generate-cards-btn');
            const deleteAllCardsBtn = document.getElementById('delete-all-cards-btn');
            const cardsCountInput = document.getElementById('cards-count-input');
            const cardsValueInput = document.getElementById('cards-value-input');

            // Search and filter elements
            const searchFilterSection = document.getElementById('search-filter-section');
            const searchInput = document.getElementById('search-input');
            const usageFilter = document.getElementById('usage-filter');
            const saleFilter = document.getElementById('sale-filter');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            const filterResultsSummary = document.getElementById('filter-results-summary');
            const resultsText = document.getElementById('results-text');

            // Update user role title
            fetch('/api/user')
                .then(response => response.json())
                .then(data => {
                    const userRoleTitle = document.getElementById('user-role-title');
                    if (userRoleTitle && data.user) {
                        if (data.user.role === 'financial_supervisor') {
                            // النص افتراضي صحيح، لا حاجة لتغييره
                            document.title = 'كروت الدفع المسبق - المشرف المالي';
                        } else if (data.user.role === 'admin') {
                            userRoleTitle.textContent = 'لوحة تحكم المشرف';

                            // إظهار عناصر الأدمن العادي
                            const adminOnlyElements = document.querySelectorAll('.admin-only:not(.financial-only)');
                            adminOnlyElements.forEach(element => {
                                element.style.display = 'block';
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching user info:', error);
                });

            // Load cards
            loadCards();

            // Event listeners
            generateCardsBtn.addEventListener('click', generateCards);
            deleteAllCardsBtn.addEventListener('click', deleteAllCards);

            // Generation type switching
            const autoGenerationRadio = document.getElementById('auto-generation');
            const customGenerationRadio = document.getElementById('custom-generation');
            const autoGenerationSection = document.getElementById('auto-generation-section');
            const customGenerationSection = document.getElementById('custom-generation-section');
            const generateCustomCardsBtn = document.getElementById('generate-custom-cards-btn');
            const validateNumbersBtn = document.getElementById('validate-numbers-btn');
            const customNumbersInput = document.getElementById('custom-numbers-input');
            const customCardsValueInput = document.getElementById('custom-cards-value-input');

            autoGenerationRadio.addEventListener('change', function() {
                if (this.checked) {
                    autoGenerationSection.classList.remove('d-none');
                    customGenerationSection.classList.add('d-none');
                }
            });

            customGenerationRadio.addEventListener('change', function() {
                if (this.checked) {
                    autoGenerationSection.classList.add('d-none');
                    customGenerationSection.classList.remove('d-none');
                }
            });

            // Check if elements exist before adding event listeners
            if (generateCustomCardsBtn) {
                generateCustomCardsBtn.addEventListener('click', generateCustomCards);
            } else {
                console.error('generateCustomCardsBtn element not found');
            }

            if (validateNumbersBtn) {
                validateNumbersBtn.addEventListener('click', validateCustomNumbers);
            } else {
                console.error('validateNumbersBtn element not found');
            }

            // Print and export buttons
            const printAllCardsBtn = document.getElementById('print-all-cards-btn');
            const exportCardsPdfBtn = document.getElementById('export-cards-pdf-btn');

            if (printAllCardsBtn) {
                printAllCardsBtn.addEventListener('click', function() {
                    // Prevent multiple clicks
                    if (this.disabled) return;

                    this.disabled = true;
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>جاري التحضير...';

                    setTimeout(() => {
                        printAllCardsReport();
                        this.disabled = false;
                        this.innerHTML = originalText;
                    }, 500);
                });
            }

            if (exportCardsPdfBtn) {
                exportCardsPdfBtn.addEventListener('click', function() {
                    // Prevent multiple clicks
                    if (this.disabled) return;
                    exportCardsToPdf();
                });
            }

            // Search and filter event listeners
            if (searchInput) {
                searchInput.addEventListener('input', debounce(applyFilters, 300));
            }

            if (usageFilter) {
                usageFilter.addEventListener('change', applyFilters);
            }

            if (saleFilter) {
                saleFilter.addEventListener('change', applyFilters);
            }

            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', clearAllFilters);
            }





            // Generate cards
            function generateCards() {
                const count = parseInt(cardsCountInput.value);
                const value = parseInt(cardsValueInput.value);

                if (!count || count < 1 || count > 100) {
                    alert('عدد الكروت يجب أن يكون بين 1 و 100');
                    return;
                }

                if (!value || value < 1) {
                    alert('قيمة الكرت يجب أن تكون أكبر من صفر');
                    return;
                }

                if (!confirm(`هل أنت متأكد من توليد ${count} كرت بقيمة ${value} دينار لكل كرت؟`)) {
                    return;
                }

                generateCardsBtn.disabled = true;
                generateCardsBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري التوليد...';

                fetch('/api/admin/prepaid-cards/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ count: count, value: value })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        loadCards(); // Reload cards list to get fresh data
                        cardsCountInput.value = 10; // Reset to default
                    } else {
                        alert('حدث خطأ: ' + (data.error || 'خطأ غير معروف'));
                    }
                })
                .catch(error => {
                    console.error('Error generating cards:', error);
                    alert('حدث خطأ أثناء توليد الكروت');
                })
                .finally(() => {
                    generateCardsBtn.disabled = false;
                    generateCardsBtn.innerHTML = '<i class="fas fa-magic me-2"></i>توليد الكروت';
                });
            }

            // Delete all cards function
            function deleteAllCards() {
                console.log('=== DELETE ALL CARDS FUNCTION CALLED ===');

                // Check if button is already disabled to prevent multiple calls
                if (deleteAllCardsBtn.disabled) {
                    console.log('Button already disabled, preventing multiple calls');
                    return;
                }

                // First confirmation
                if (!confirm('⚠️ تحذير: هل أنت متأكد من حذف جميع كروت الدفع المسبق؟\n\nهذا الإجراء لا يمكن التراجع عنه!')) {
                    console.log('User cancelled first confirmation');
                    return;
                }

                // Second confirmation with more details
                if (!confirm('🚨 تأكيد نهائي: سيتم حذف جميع الكروت نهائياً!\n\n• سيتم حذف جميع الكروت المستخدمة وغير المستخدمة\n• سيتم حذف جميع البيانات المرتبطة بها\n• لا يمكن استرداد البيانات بعد الحذف\n\nهل تريد المتابعة؟')) {
                    console.log('User cancelled second confirmation');
                    return;
                }

                console.log('User confirmed deletion, proceeding...');
                deleteAllCardsBtn.disabled = true;
                deleteAllCardsBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الحذف...';

                console.log('Sending DELETE request to /api/admin/prepaid-cards/delete-all');

                fetch('/api/admin/prepaid-cards/delete-all', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    console.log('Delete all response status:', response.status);
                    console.log('Delete all response ok:', response.ok);

                    if (!response.ok) {
                        return response.text().then(text => {
                            console.log('Delete all error response text:', text);
                            try {
                                const errorData = JSON.parse(text);
                                throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                            } catch (parseError) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText} - ${text}`);
                            }
                        });
                    }

                    return response.json();
                })
                .then(data => {
                    console.log('Delete all response data:', data);

                    if (data.success) {
                        alert('✅ تم حذف جميع كروت الدفع المسبق بنجاح!\n\nعدد الكروت المحذوفة: ' + (data.deletedCount || 0));
                        loadCards(); // Reload cards list to show empty state
                    } else {
                        console.error('Delete all server error:', data.error);
                        alert('❌ حدث خطأ أثناء حذف الكروت: ' + (data.error || 'خطأ غير معروف'));
                    }
                })
                .catch(error => {
                    console.error('Delete all error details:', error);
                    console.error('Delete all error message:', error.message);
                    alert('❌ حدث خطأ أثناء حذف جميع الكروت: ' + error.message);
                })
                .finally(() => {
                    deleteAllCardsBtn.disabled = false;
                    deleteAllCardsBtn.innerHTML = '<i class="fas fa-trash-alt me-2"></i>حذف الكل';
                });
            }

            // Validate custom numbers
            function validateCustomNumbers() {
                console.log('validateCustomNumbers called');

                if (!customNumbersInput) {
                    console.error('customNumbersInput element not found');
                    alert('خطأ: عنصر إدخال الأرقام غير موجود');
                    return;
                }

                const numbersText = customNumbersInput.value.trim();
                const validationResult = document.getElementById('validation-result');

                if (!validationResult) {
                    console.error('validation-result element not found');
                    alert('خطأ: عنصر عرض النتائج غير موجود');
                    return;
                }

                if (!numbersText) {
                    showValidationResult('يرجى إدخال أرقام الكروت', 'error');
                    return;
                }

                const numbers = numbersText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);

                if (numbers.length === 0) {
                    showValidationResult('لا توجد أرقام صحيحة للتحقق منها', 'error');
                    return;
                }

                // Check for duplicates within the input
                const duplicates = [];
                const seen = new Set();
                const validNumbers = [];
                const invalidNumbers = [];

                numbers.forEach((number, index) => {
                    // Basic validation - check if number is not empty and reasonable length
                    if (number.length < 3 || number.length > 50) {
                        invalidNumbers.push(`السطر ${index + 1}: "${number}" - طول غير صحيح (يجب أن يكون بين 3-50 حرف)`);
                        return;
                    }

                    // Check for special characters that might cause issues
                    if (!/^[a-zA-Z0-9\-_]+$/.test(number)) {
                        invalidNumbers.push(`السطر ${index + 1}: "${number}" - يحتوي على رموز غير مسموحة (استخدم حروف وأرقام و - و _ فقط)`);
                        return;
                    }

                    if (seen.has(number)) {
                        duplicates.push(`السطر ${index + 1}: "${number}" - مكرر`);
                    } else {
                        seen.add(number);
                        validNumbers.push(number);
                    }
                });

                // Show validation results
                let resultHtml = '';
                let resultType = 'success';

                if (validNumbers.length > 0) {
                    resultHtml += `<div class="mb-2"><strong><i class="fas fa-check-circle me-1"></i>أرقام صحيحة:</strong> ${validNumbers.length}</div>`;
                }

                if (duplicates.length > 0) {
                    resultType = 'warning';
                    resultHtml += `<div class="mb-2"><strong><i class="fas fa-exclamation-triangle me-1"></i>أرقام مكررة:</strong></div>`;
                    resultHtml += `<ul class="mb-2">`;
                    duplicates.forEach(dup => {
                        resultHtml += `<li><small>${dup}</small></li>`;
                    });
                    resultHtml += `</ul>`;
                }

                if (invalidNumbers.length > 0) {
                    resultType = 'error';
                    resultHtml += `<div class="mb-2"><strong><i class="fas fa-times-circle me-1"></i>أرقام غير صحيحة:</strong></div>`;
                    resultHtml += `<ul class="mb-2">`;
                    invalidNumbers.forEach(invalid => {
                        resultHtml += `<li><small>${invalid}</small></li>`;
                    });
                    resultHtml += `</ul>`;
                }

                if (validNumbers.length > 0 && duplicates.length === 0 && invalidNumbers.length === 0) {
                    resultHtml += `<div class="text-success"><i class="fas fa-thumbs-up me-1"></i>جميع الأرقام صحيحة وجاهزة للإنشاء!</div>`;
                }

                showValidationResult(resultHtml, resultType);

                // Check against existing cards in database
                if (validNumbers.length > 0) {
                    checkNumbersInDatabase(validNumbers);
                }
            }

            // Check if numbers already exist in database
            function checkNumbersInDatabase(numbers) {
                fetch('/api/admin/prepaid-cards/check-numbers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ numbers: numbers })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.existing && data.existing.length > 0) {
                        const validationResult = document.getElementById('validation-result');
                        let existingHtml = `<div class="mt-2"><strong><i class="fas fa-database me-1"></i>أرقام موجودة مسبقاً في النظام:</strong></div>`;
                        existingHtml += `<ul class="mb-0">`;
                        data.existing.forEach(existing => {
                            existingHtml += `<li><small>${existing}</small></li>`;
                        });
                        existingHtml += `</ul>`;

                        validationResult.innerHTML += existingHtml;
                        validationResult.className = 'mt-3 validation-warning';
                    }
                })
                .catch(error => {
                    console.error('Error checking numbers in database:', error);
                });
            }

            // Show validation result
            function showValidationResult(message, type) {
                const validationResult = document.getElementById('validation-result');
                validationResult.innerHTML = message;
                validationResult.className = `mt-3 validation-${type}`;
                validationResult.classList.remove('d-none');
            }

            // Generate custom cards
            function generateCustomCards() {
                console.log('generateCustomCards called');

                if (!customNumbersInput) {
                    console.error('customNumbersInput element not found');
                    alert('خطأ: عنصر إدخال الأرقام غير موجود');
                    return;
                }

                if (!customCardsValueInput) {
                    console.error('customCardsValueInput element not found');
                    alert('خطأ: عنصر إدخال القيمة غير موجود');
                    return;
                }

                const numbersText = customNumbersInput.value.trim();
                const value = parseInt(customCardsValueInput.value);

                if (!numbersText) {
                    alert('يرجى إدخال أرقام الكروت');
                    return;
                }

                if (!value || value < 1) {
                    alert('قيمة الكرت يجب أن تكون أكبر من صفر');
                    return;
                }

                const numbers = numbersText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);

                if (numbers.length === 0) {
                    alert('لا توجد أرقام صحيحة لإنشاء الكروت');
                    return;
                }

                if (numbers.length > 100) {
                    alert('لا يمكن إنشاء أكثر من 100 كرت في المرة الواحدة');
                    return;
                }

                // Basic validation
                const invalidNumbers = numbers.filter(number => {
                    return number.length < 3 || number.length > 50 || !/^[a-zA-Z0-9\-_]+$/.test(number);
                });

                if (invalidNumbers.length > 0) {
                    alert(`توجد أرقام غير صحيحة. يرجى استخدام زر "التحقق من الأرقام" أولاً`);
                    return;
                }

                if (!confirm(`هل أنت متأكد من إنشاء ${numbers.length} كرت بقيمة ${value} دينار لكل كرت؟`)) {
                    return;
                }

                generateCustomCardsBtn.disabled = true;
                generateCustomCardsBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الإنشاء...';

                fetch('/api/admin/prepaid-cards/generate-custom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        numbers: numbers,
                        value: value
                    })
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);
                    console.log('Response statusText:', response.statusText);

                    if (!response.ok) {
                        // Try to get error message from response
                        return response.text().then(text => {
                            console.log('Error response text:', text);
                            try {
                                const errorData = JSON.parse(text);
                                throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                            } catch (parseError) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText} - ${text}`);
                            }
                        });
                    }

                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);

                    if (data.success) {
                        alert(data.message);
                        loadCards(); // Reload cards list to get fresh data
                        customNumbersInput.value = ''; // Clear input
                        document.getElementById('validation-result').classList.add('d-none'); // Hide validation
                    } else {
                        console.error('Server error:', data.error);
                        alert('حدث خطأ: ' + (data.error || 'خطأ غير معروف'));
                    }
                })
                .catch(error => {
                    console.error('Full error details:', error);
                    console.error('Error message:', error.message);
                    console.error('Error stack:', error.stack);
                    alert('حدث خطأ أثناء إنشاء الكروت: ' + error.message);
                })
                .finally(() => {
                    generateCustomCardsBtn.disabled = false;
                    generateCustomCardsBtn.innerHTML = '<i class="fas fa-plus-circle me-2"></i>إنشاء الكروت';
                });
            }

            // Load cards
            function loadCards() {
                // Show loading indicator
                loadingIndicator.classList.remove('d-none');
                cardsContainer.classList.add('d-none');
                searchFilterSection.classList.add('d-none');
                errorMessage.classList.add('d-none');
                noCards.classList.add('d-none');

                fetch('/api/admin/prepaid-cards')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('فشل في تحميل البيانات');
                        }
                        return response.json();
                    })
                    .then(data => {
                        loadingIndicator.classList.add('d-none');

                        if (data.cards && data.cards.length > 0) {
                            // Store original data
                            originalCardsData = data.cards;
                            filteredCardsData = [...data.cards];

                            // Show search and filter section
                            searchFilterSection.classList.remove('d-none');

                            // Display cards and update summary
                            displayCards(data.cards);
                            updateFilterSummary();
                        } else {
                            // No cards found
                            originalCardsData = [];
                            filteredCardsData = [];
                            noCards.classList.remove('d-none');
                        }
                    })
                    .catch(error => {
                        loadingIndicator.classList.add('d-none');
                        errorText.textContent = error.message;
                        errorMessage.classList.remove('d-none');
                    });
            }

            // Display cards
            function displayCards(cards) {
                console.log('=== FRONTEND CARDS DEBUG ===');
                console.log('Displaying cards:', cards.length);

                // Store cards data globally for printing/export
                allCardsData = cards;

                cardsTableBody.innerHTML = '';

                cards.forEach(card => {
                    const row = document.createElement('tr');

                    // Convert is_used to boolean if it's not already
                    const isUsed = Boolean(card.is_used);
                    const isSold = Boolean(card.is_sold);

                    console.log(`Card ${card.id} (${card.card_number}): isUsed=${isUsed}, isSold=${isSold}, is_used=${card.is_used}, is_sold=${card.is_sold}`);
                    console.log(`Raw card data:`, card);

                    // Usage status
                    const usageStatusClass = isUsed ? 'card-status-used' : 'card-status-available';
                    const usageStatusIcon = isUsed ? 'fas fa-times-circle' : 'fas fa-check-circle';
                    const usageStatusText = isUsed ? 'مستخدم' : 'متاح';

                    // Sale status
                    const saleStatusClass = isSold ? 'card-status-sold' : 'card-status-not-sold';
                    const saleStatusIcon = isSold ? 'fas fa-check-circle' : 'fas fa-times-circle';
                    const saleStatusText = isSold ? 'مباع' : '❌ غير مباع';

                    // Format "used by" information
                    let usedBy = '-';
                    if (isUsed && card.used_by_student_name) {
                        const studentReg = card.used_by_student_registration || 'غير محدد';
                        usedBy = `<div class="text-truncate-custom" title="${card.used_by_student_name} (${studentReg})">${card.used_by_student_name}<br><small class="text-muted-small">${studentReg}</small></div>`;
                    }

                    // Format "used at" date
                    let usedAt = '-';
                    if (isUsed && card.used_at) {
                        const fullDate = formatDateArabic(card.used_at);
                        const shortDate = formatDateArabic(card.used_at, false); // Date only
                        usedAt = `<div class="text-muted-small" title="${fullDate}">${shortDate}</div>`;
                    }

                    // Format created date
                    const fullCreatedDate = formatDateArabic(card.created_at);
                    const shortCreatedDate = formatDateArabic(card.created_at, false); // Date only
                    let createdAt = `<div class="text-muted-small" title="${fullCreatedDate}">${shortCreatedDate}</div>`;

                    // Generate action buttons based on card status
                    let actionButtons = '';

                    // Debug logging
                    console.log(`Card ${card.id}: isUsed=${isUsed}, isSold=${isSold}`);

                    // Print button is always available
                    actionButtons += `
                        <button class="btn btn-professional btn-primary btn-xs me-1 print-card"
                                data-id="${card.id}"
                                data-number="${card.card_number}"
                                data-value="${card.value}">
                            <i class="fas fa-print"></i> طباعة
                        </button>
                    `;

                    if (isUsed) {
                        // Card is used - show delete option
                        actionButtons += `
                            <button class="btn btn-professional btn-danger btn-xs delete-used-card"
                                    data-id="${card.id}"
                                    data-number="${card.card_number}"
                                    data-student-name="${card.used_by_student_name || 'غير محدد'}"
                                    data-student-registration="${card.used_by_student_registration || 'غير محدد'}">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        `;
                        console.log(`Card ${card.id}: Used - showing delete option`);
                    } else if (isSold) {
                        // Card is sold but not used - can mark as not sold
                        actionButtons += `
                            <button class="btn btn-professional btn-success btn-xs me-1 mark-not-sold-card"
                                    data-id="${card.id}"
                                    data-number="${card.card_number}">
                                <i class="fas fa-undo"></i> إلغاء البيع
                            </button>
                        `;
                        console.log(`Card ${card.id}: Sold - showing 'عدم بيعه' button`);
                    } else {
                        // Card is available - can mark as sold or delete
                        actionButtons += `
                            <button class="btn btn-professional btn-warning btn-xs me-1 mark-sold-card"
                                    data-id="${card.id}"
                                    data-number="${card.card_number}">
                                <i class="fas fa-shopping-cart"></i> بيع
                            </button>
                            <button class="btn btn-professional btn-danger btn-xs delete-card"
                                    data-id="${card.id}"
                                    data-number="${card.card_number}">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        `;
                        console.log(`Card ${card.id}: Available - showing 'تم بيعه' and 'حذف' buttons`);
                    }

                    row.innerHTML = `
                        <td><span class="card-number">${card.card_number}</span></td>
                        <td>
                            <span class="card-value">
                                <i class="fas fa-coins"></i>
                                ${card.value}
                            </span>
                        </td>
                        <td>
                            <span class="${usageStatusClass}">
                                <i class="${usageStatusIcon}"></i>
                                ${usageStatusText}
                            </span>
                        </td>
                        <td>
                            <span class="${saleStatusClass}">
                                ${isSold ? '<i class="fas fa-check-circle"></i>' : ''} ${saleStatusText}
                            </span>
                        </td>
                        <td>${usedBy}</td>
                        <td>${usedAt}</td>
                        <td>${createdAt}</td>
                        <td>
                            <div style="display: flex; flex-wrap: wrap; gap: 2px; justify-content: center;">
                                ${actionButtons}
                            </div>
                        </td>
                    `;

                    cardsTableBody.appendChild(row);
                });

                // Add event listeners for print buttons
                document.querySelectorAll('.print-card').forEach(button => {
                    button.addEventListener('click', function() {
                        const cardId = this.getAttribute('data-id');
                        const cardNumber = this.getAttribute('data-number');
                        const cardValue = this.getAttribute('data-value');
                        printCard(cardId, cardNumber, cardValue);
                    });
                });

                // Add event listeners for mark sold buttons
                document.querySelectorAll('.mark-sold-card').forEach(button => {
                    button.addEventListener('click', function() {
                        const cardId = this.getAttribute('data-id');
                        const cardNumber = this.getAttribute('data-number');
                        markCardAsSold(cardId, cardNumber);
                    });
                });

                // Add event listeners for mark not sold buttons
                const notSoldButtons = document.querySelectorAll('.mark-not-sold-card');
                console.log(`Found ${notSoldButtons.length} 'mark-not-sold-card' buttons`);
                notSoldButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const cardId = this.getAttribute('data-id');
                        const cardNumber = this.getAttribute('data-number');
                        console.log(`'عدم بيعه' button clicked for card ${cardId} (${cardNumber})`);
                        markCardAsNotSold(cardId, cardNumber);
                    });
                });

                // Add event listeners for delete buttons
                document.querySelectorAll('.delete-card').forEach(button => {
                    button.addEventListener('click', function() {
                        const cardId = this.getAttribute('data-id');
                        const cardNumber = this.getAttribute('data-number');
                        deleteCard(cardId, cardNumber);
                    });
                });

                // Add event listeners for delete used card buttons
                document.querySelectorAll('.delete-used-card').forEach(button => {
                    button.addEventListener('click', function() {
                        const cardId = this.getAttribute('data-id');
                        const cardNumber = this.getAttribute('data-number');
                        const studentName = this.getAttribute('data-student-name');
                        const studentRegistration = this.getAttribute('data-student-registration');
                        deleteUsedCard(cardId, cardNumber, studentName, studentRegistration);
                    });
                });

                cardsContainer.classList.remove('d-none');
            }

            // Function to navigate to receipts section
            window.showReceiptsSection = function() {
                // Store that we're navigating to receipts section
                sessionStorage.setItem('activeSection', 'receipts');
                window.location.href = 'payment-management.html#receipts-section';
            };

            // Print card using hidden iframe method
            function printCard(cardId, cardNumber, cardValue) {
                console.log('Printing card:', cardId, cardNumber, cardValue);

                // Try iframe method first (cleaner, no popup)
                if (printCardWithIframe(cardId, cardNumber, cardValue)) {
                    return;
                }

                // Fallback to popup method
                printCardWithPopup(cardId, cardNumber, cardValue);
            }

            // Print card using hidden iframe (preferred method)
            function printCardWithIframe(cardId, cardNumber, cardValue) {
                try {
                    // Remove any existing print iframe
                    const existingIframe = document.getElementById('print-iframe');
                    if (existingIframe) {
                        existingIframe.remove();
                    }

                    // Create hidden iframe
                    const iframe = document.createElement('iframe');
                    iframe.id = 'print-iframe';
                    iframe.style.position = 'absolute';
                    iframe.style.left = '-9999px';
                    iframe.style.top = '-9999px';
                    iframe.style.width = '0px';
                    iframe.style.height = '0px';
                    iframe.style.border = 'none';

                    document.body.appendChild(iframe);

                    // Get iframe document
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                    // Create print content
                    const printContent = createCardPrintContent(cardNumber, cardValue);

                    // Write content to iframe
                    iframeDoc.open();
                    iframeDoc.write(printContent);
                    iframeDoc.close();

                    // Wait for content to load, generate QR code, then print
                    setTimeout(() => {
                        try {
                            // Generate QR code in the iframe
                            generateQRCodeInDocument(iframe.contentDocument, cardNumber);

                            // Wait a bit more for QR code to render, then print
                            setTimeout(() => {
                                iframe.contentWindow.focus();
                                iframe.contentWindow.print();

                                // Remove iframe after printing
                                setTimeout(() => {
                                    if (iframe.parentNode) {
                                        iframe.parentNode.removeChild(iframe);
                                    }
                                }, 1000);
                            }, 800);
                        } catch (e) {
                            console.error('Error printing with iframe:', e);
                            // Remove iframe and try popup method
                            if (iframe.parentNode) {
                                iframe.parentNode.removeChild(iframe);
                            }
                            printCardWithPopup(cardId, cardNumber, cardValue);
                        }
                    }, 500);

                    return true;
                } catch (e) {
                    console.error('Iframe method failed:', e);
                    return false;
                }
            }

            // Generate QR code in a specific document
            function generateQRCodeInDocument(doc, cardNumber) {
                try {
                    const qrContainer = doc.getElementById(`qrcode-${cardNumber}`);
                    if (qrContainer && typeof QRCode !== 'undefined') {
                        // Clear any existing QR code
                        qrContainer.innerHTML = '';

                        // Create QR code with card number
                        new QRCode(qrContainer, {
                            text: cardNumber,
                            width: 60,
                            height: 60,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.M
                        });

                        console.log('QR code generated for card:', cardNumber);
                    } else {
                        console.warn('QR container not found or QRCode library not loaded');
                    }
                } catch (e) {
                    console.error('Error generating QR code:', e);
                }
            }

            // Create card print content
            function createCardPrintContent(cardNumber, cardValue) {
                return `
                    <!DOCTYPE html>
                    <html dir="rtl" lang="ar">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>كرت دفع مسبق - ${cardNumber}</title>
                        <style>
                            @page {
                                size: A6 landscape;
                                margin: 5mm;
                            }

                            * {
                                box-sizing: border-box;
                            }

                            body {
                                font-family: Arial, sans-serif;
                                margin: 0;
                                padding: 8px;
                                background: #ffffff;
                                color: #000;
                                text-align: center;
                                direction: rtl;
                            }

                            .card-container {
                                width: 100%;
                                max-width: 350px;
                                margin: 0 auto;
                                border: 3px solid #007bff;
                                border-radius: 12px;
                                padding: 15px;
                                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                position: relative;
                                min-height: 200px;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            }

                            .card-header {
                                font-size: 16px;
                                font-weight: bold;
                                margin-bottom: 12px;
                                color: #007bff;
                                border-bottom: 2px solid #007bff;
                                padding-bottom: 8px;
                                text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
                            }

                            .card-number-section {
                                margin: 12px 0;
                                padding: 12px;
                                background: #ffffff;
                                border: 2px solid #007bff;
                                border-radius: 8px;
                                box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
                            }

                            .card-number-label {
                                font-size: 11px;
                                color: #007bff;
                                font-weight: bold;
                                margin-bottom: 4px;
                            }

                            .card-number {
                                font-size: 16px;
                                font-weight: bold;
                                letter-spacing: 1px;
                                color: #000;
                                font-family: 'Courier New', monospace;
                                word-break: break-all;
                                line-height: 1.1;
                                padding: 2px;
                            }

                            .card-value-section {
                                margin: 12px 0;
                                padding: 10px;
                                background: #d4edda;
                                border: 2px solid #28a745;
                                border-radius: 8px;
                                box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                            }

                            .card-value-label {
                                font-size: 11px;
                                color: #155724;
                                font-weight: bold;
                                margin-bottom: 3px;
                            }

                            .card-value {
                                font-size: 18px;
                                font-weight: bold;
                                color: #155724;
                            }

                            .qr-section {
                                margin: 12px 0;
                                padding: 10px;
                                background: #ffffff;
                                border: 2px solid #6c757d;
                                border-radius: 8px;
                                text-align: center;
                            }

                            .qr-label {
                                font-size: 9px;
                                color: #6c757d;
                                font-weight: bold;
                                margin-bottom: 5px;
                            }

                            .qr-code {
                                display: inline-block;
                                margin: 0 auto;
                            }

                            .qr-code canvas,
                            .qr-code img {
                                max-width: 60px !important;
                                max-height: 60px !important;
                                width: 60px !important;
                                height: 60px !important;
                            }

                            .instructions {
                                font-size: 9px;
                                margin-top: 12px;
                                line-height: 1.3;
                                background: #fff3cd;
                                padding: 8px;
                                border-radius: 6px;
                                border: 1px solid #ffc107;
                                text-align: right;
                                color: #856404;
                            }

                            .instructions strong {
                                color: #000;
                                display: block;
                                margin-bottom: 6px;
                                text-align: center;
                                font-size: 10px;
                            }

                            .instructions ul {
                                margin: 0;
                                padding-right: 15px;
                                list-style-type: disc;
                            }

                            .instructions li {
                                margin-bottom: 3px;
                            }

                            .footer {
                                margin-top: 12px;
                                font-size: 8px;
                                color: #666;
                                border-top: 1px solid #ddd;
                                padding-top: 6px;
                                line-height: 1.2;
                            }

                            .university-logo {
                                position: absolute;
                                top: 8px;
                                left: 8px;
                                font-size: 20px;
                                color: #007bff;
                                opacity: 0.3;
                            }

                            .security-pattern {
                                position: absolute;
                                bottom: 8px;
                                right: 8px;
                                font-size: 7px;
                                color: #ccc;
                                transform: rotate(-45deg);
                                font-weight: bold;
                            }

                            .decorative-corner {
                                position: absolute;
                                width: 20px;
                                height: 20px;
                                border: 2px solid #007bff;
                            }

                            .corner-top-right {
                                top: 6px;
                                right: 6px;
                                border-left: none;
                                border-bottom: none;
                                border-radius: 0 8px 0 0;
                            }

                            .corner-bottom-left {
                                bottom: 6px;
                                left: 6px;
                                border-right: none;
                                border-top: none;
                                border-radius: 0 0 0 8px;
                            }

                            @media print {
                                body {
                                    background: #ffffff !important;
                                    -webkit-print-color-adjust: exact !important;
                                    color-adjust: exact !important;
                                    print-color-adjust: exact !important;
                                }

                                .card-container {
                                    border: 4px solid #007bff !important;
                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
                                    box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
                                }

                                .card-number-section {
                                    background: #ffffff !important;
                                    border: 3px solid #007bff !important;
                                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1) !important;
                                }

                                .card-value-section {
                                    background: #d4edda !important;
                                    border: 3px solid #28a745 !important;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
                                }

                                .instructions {
                                    background: #fff3cd !important;
                                    border: 2px solid #ffc107 !important;
                                }

                                .decorative-corner {
                                    border: 3px solid #007bff !important;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="card-container">
                            <div class="university-logo">🎓</div>
                            <div class="security-pattern">HADHARA-UNIV</div>
                            <div class="decorative-corner corner-top-right"></div>
                            <div class="decorative-corner corner-bottom-left"></div>

                            <div class="card-header">
                                🎓 كرت دفع مسبق - جامعة الحاضرة
                            </div>

                            <div class="card-number-section">
                                <div class="card-number-label">رقم الكرت:</div>
                                <div class="card-number">${cardNumber}</div>
                            </div>

                            <div class="card-value-section">
                                <div class="card-value-label">القيمة:</div>
                                <div class="card-value">${cardValue} دينار</div>
                            </div>

                            <div class="qr-section">
                                <div class="qr-label">رمز QR للمسح السريع:</div>
                                <div class="qr-code" id="qrcode-${cardNumber}"></div>
                            </div>

                            <div class="instructions">
                                <strong>تعليمات:</strong>
                                <ul>
                                    <li>احتفظ بالكرت في مكان آمن</li>
                                    <li>استخدم الرقم لدفع رسوم المواد</li>
                                    <li>الكرت صالح لاستخدام واحد فقط</li>
                                    <li>في حالة الفقدان اتصل بالإدارة</li>
                                </ul>
                            </div>

                            <div class="footer">
                                تاريخ الإصدار: ${formatDateArabic(new Date(), false)}<br>
                                جامعة الحاضرة - نظام التسجيل
                            </div>
                        </div>
                    </body>
                    </html>
                `;
            }

            // Print card using popup window (fallback method)
            function printCardWithPopup(cardId, cardNumber, cardValue) {
                console.log('Using popup method for printing');

                // Create print content
                const printContent = createCardPrintContent(cardNumber, cardValue);

                // Open print window with smaller dimensions to minimize visibility
                const printWindow = window.open('', '_blank', 'width=400,height=300,left=9999,top=9999');

                if (!printWindow) {
                    alert('تم حظر النافذة المنبثقة. يرجى السماح بالنوافذ المنبثقة وإعادة المحاولة.');
                    return;
                }

                // Write content and close document
                printWindow.document.write(printContent);
                printWindow.document.close();

                // Wait for content to load, generate QR code, then print and close
                printWindow.onload = function() {
                    // Small delay to ensure content is fully loaded
                    setTimeout(() => {
                        console.log('Starting print process with popup...');

                        // Generate QR code in the popup window
                        generateQRCodeInDocument(printWindow.document, cardNumber);

                        // Wait for QR code to render, then print
                        setTimeout(() => {
                            // Focus on print window to ensure print dialog appears
                            printWindow.focus();

                            // Start printing
                            printWindow.print();

                            // Close window immediately after print dialog opens
                            setTimeout(() => {
                                try {
                                    printWindow.close();
                                } catch (e) {
                                    console.log('Window already closed or closing');
                                }
                            }, 100);
                        }, 800);

                    }, 500);
                };

                // Fallback in case onload doesn't fire
                setTimeout(() => {
                    if (printWindow && !printWindow.closed) {
                        try {
                            printWindow.focus();
                            printWindow.print();
                            setTimeout(() => {
                                printWindow.close();
                            }, 100);
                        } catch (e) {
                            console.error('Error in fallback print:', e);
                        }
                    }
                }, 1500);
            }

            // Global flag to prevent multiple print windows
            let isPrintWindowOpen = false;

            // Print all cards report
            function printAllCardsReport() {
                if (!allCardsData || allCardsData.length === 0) {
                    alert('لا توجد كروت للطباعة');
                    return;
                }

                // Prevent multiple print windows
                if (isPrintWindowOpen) {
                    alert('نافذة طباعة مفتوحة بالفعل. يرجى إغلاقها أولاً أو استخدامها للطباعة.');
                    return;
                }

                console.log('🖨️ Starting print report for', allCardsData.length, 'cards');

                try {
                    // Use filtered data if available, otherwise use all data
                    const cardsToReport = filteredCardsData && filteredCardsData.length > 0 ? filteredCardsData : allCardsData;

                    console.log('Using cards data:', cardsToReport.length, 'cards');

                    // Create comprehensive report HTML
                    const reportHtml = createCardsReportHtml(cardsToReport);

                    // Check if a print window is already open
                    if (window.printReportWindow && !window.printReportWindow.closed) {
                        window.printReportWindow.close();
                        isPrintWindowOpen = false;
                    }

                    // Open print window
                    window.printReportWindow = window.open('', 'printReport', 'width=1000,height=800,scrollbars=yes,resizable=yes');

                    if (!window.printReportWindow) {
                        alert('تم حظر النافذة المنبثقة. يرجى السماح بالنوافذ المنبثقة وإعادة المحاولة.');
                        isPrintWindowOpen = false;
                        return;
                    }

                    // Set flag that print window is open
                    isPrintWindowOpen = true;

                    window.printReportWindow.document.write(reportHtml);
                    window.printReportWindow.document.close();

                    // Wait for content to load, then focus the window (NO AUTO-PRINT)
                    window.printReportWindow.onload = function() {
                        setTimeout(() => {
                            try {
                                window.printReportWindow.focus();
                                console.log('✅ Print window loaded and focused. NO auto-print triggered.');
                                console.log('📝 User can click "طباعة التقرير" button or use Ctrl+P to print.');

                                // Add a message to the window title to indicate it's ready
                                window.printReportWindow.document.title = 'تقرير كروت الدفع المسبق - جاهز للطباعة';

                            } catch (e) {
                                console.error('Error focusing print window:', e);
                            }
                        }, 500);
                    };

                    // Prevent any accidental auto-print
                    window.printReportWindow.onbeforeprint = function() {
                        console.log('🖨️ Print dialog opened by user action');
                    };

                    window.printReportWindow.onafterprint = function() {
                        console.log('✅ Print dialog closed');
                    };

                    // Handle print window close
                    window.printReportWindow.onbeforeunload = function() {
                        isPrintWindowOpen = false;
                        console.log('🔄 Print window closed, flag reset');
                    };

                    // Handle print window errors
                    window.printReportWindow.onerror = function(error) {
                        console.error('Print window error:', error);
                        isPrintWindowOpen = false;
                    };

                    // Check periodically if window is closed (fallback)
                    const checkWindowClosed = setInterval(() => {
                        if (window.printReportWindow && window.printReportWindow.closed) {
                            isPrintWindowOpen = false;
                            clearInterval(checkWindowClosed);
                            console.log('🔄 Print window detected as closed, flag reset');
                        }
                    }, 1000);

                } catch (error) {
                    console.error('Error in printAllCardsReport:', error);
                    alert('حدث خطأ أثناء إنشاء التقرير: ' + error.message);
                }
            }

            // Export cards to PDF
            function exportCardsToPdf() {
                if (!allCardsData || allCardsData.length === 0) {
                    alert('لا توجد كروت للتصدير');
                    return;
                }

                const exportBtn = document.getElementById('export-cards-pdf-btn');

                // Prevent multiple simultaneous exports
                if (exportBtn.disabled) {
                    return;
                }

                const originalText = exportBtn.innerHTML;

                exportBtn.disabled = true;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>جاري التصدير...';

                try {
                    // Use filtered data if available, otherwise use all data
                    const cardsToExport = filteredCardsData && filteredCardsData.length > 0 ? filteredCardsData : allCardsData;

                    console.log('Starting PDF export with cards data:', cardsToExport.length, 'cards');

                    // Create simplified report content for PDF
                    const reportContent = createSimplifiedReportContent(cardsToExport);

                    // Create temporary element with proper structure
                    const element = document.createElement('div');
                    element.style.direction = 'rtl';
                    element.style.fontFamily = 'Arial, sans-serif';
                    element.style.fontSize = '12px';
                    element.style.lineHeight = '1.4';
                    element.style.color = '#000';
                    element.style.backgroundColor = '#fff';
                    element.style.padding = '20px';
                    element.innerHTML = reportContent;

                    // Add to DOM temporarily
                    document.body.appendChild(element);

                    console.log('Element created and added to DOM');

                    // Generate PDF with better options
                    const filename = `تقرير_كروت_الدفع_المسبق_${new Date().toISOString().slice(0,10)}.pdf`;

                    const opt = {
                        margin: [10, 10, 10, 10],
                        filename: filename,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: {
                            scale: 1.5,
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: '#ffffff'
                        },
                        jsPDF: {
                            unit: 'mm',
                            format: 'a4',
                            orientation: 'portrait',
                            compress: true
                        }
                    };

                    console.log('Starting html2pdf conversion...');

                    html2pdf().set(opt).from(element).save().then(() => {
                        console.log('PDF generated successfully');
                        document.body.removeChild(element);
                        alert('تم تصدير التقرير بنجاح');
                        exportBtn.disabled = false;
                        exportBtn.innerHTML = originalText;
                    }).catch(error => {
                        console.error('Error generating PDF:', error);
                        if (document.body.contains(element)) {
                            document.body.removeChild(element);
                        }
                        alert('حدث خطأ أثناء تصدير PDF. يرجى المحاولة مرة أخرى أو استخدام زر "طباعة التقرير" بدلاً من ذلك.');

                        exportBtn.disabled = false;
                        exportBtn.innerHTML = originalText;
                    });

                } catch (error) {
                    console.error('Error in PDF export:', error);
                    alert('حدث خطأ أثناء تصدير PDF: ' + error.message);
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = originalText;
                }
            }

            // Create simplified report content for PDF
            function createSimplifiedReportContent(cards) {
                console.log('Creating simplified report for', cards.length, 'cards');

                const currentDate = formatDateArabic(new Date(), false);
                const totalCards = cards.length;
                const usedCards = cards.filter(card => Boolean(card.is_used)).length;
                const availableCards = totalCards - usedCards;
                const soldCards = cards.filter(card => Boolean(card.is_sold)).length;

                // Calculate total value
                const totalValue = cards.reduce((sum, card) => sum + (parseFloat(card.value) || 0), 0);
                const usedValue = cards.filter(card => Boolean(card.is_used))
                    .reduce((sum, card) => sum + (parseFloat(card.value) || 0), 0);

                let tableRows = '';
                cards.forEach((card, index) => {
                    const isUsed = Boolean(card.is_used);
                    const isSold = Boolean(card.is_sold);

                    const usageStatus = isUsed ? 'مستخدم' : 'متاح';
                    const saleStatus = isSold ? 'مباع' : 'غير مباع';

                    let usedBy = '-';
                    if (isUsed && card.used_by_student_name) {
                        const studentReg = card.used_by_student_registration || 'غير محدد';
                        usedBy = `${card.used_by_student_name} (${studentReg})`;
                    }

                    let usedAt = '-';
                    if (isUsed && card.used_at) {
                        usedAt = formatDateArabic(card.used_at, false);
                    }

                    let createdAt = formatDateArabic(card.created_at, false);

                    tableRows += `
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${index + 1}</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center; font-family: monospace; font-weight: bold;">${card.card_number}</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${card.value} دينار</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center; color: ${isUsed ? '#dc3545' : '#28a745'};">${usageStatus}</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center; color: ${isSold ? '#fd7e14' : '#6c757d'};">${saleStatus}</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${usedBy}</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${usedAt}</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${createdAt}</td>
                        </tr>
                    `;
                });

                return `
                    <div style="direction: rtl; font-family: Arial, sans-serif; color: #000;">
                        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #007bff; padding-bottom: 20px;">
                            <h1 style="color: #007bff; margin-bottom: 10px;">🎓 تقرير كروت الدفع المسبق</h1>
                            <h2 style="margin: 10px 0;">جامعة الحاضرة</h2>
                            <p style="margin: 5px 0;">تاريخ التقرير: ${currentDate}</p>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #007bff;">
                                <h3 style="margin: 0 0 10px 0; color: #007bff;">إجمالي الكروت</h3>
                                <div style="font-size: 24px; font-weight: bold; color: #333;">${totalCards}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #dc3545;">
                                <h3 style="margin: 0 0 10px 0; color: #dc3545;">الكروت المستخدمة</h3>
                                <div style="font-size: 24px; font-weight: bold; color: #333;">${usedCards}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #28a745;">
                                <h3 style="margin: 0 0 10px 0; color: #28a745;">الكروت المتاحة</h3>
                                <div style="font-size: 24px; font-weight: bold; color: #333;">${availableCards}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #fd7e14;">
                                <h3 style="margin: 0 0 10px 0; color: #fd7e14;">الكروت المباعة</h3>
                                <div style="font-size: 24px; font-weight: bold; color: #333;">${soldCards}</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #007bff; border-bottom: 1px solid #ddd; padding-bottom: 10px;">تفاصيل الكروت:</h3>
                        </div>

                        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                            <thead>
                                <tr style="background-color: #007bff; color: white;">
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">#</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">رقم الكرت</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">القيمة</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">حالة الاستخدام</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">حالة البيع</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">مستخدم بواسطة</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">تاريخ الاستخدام</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">تاريخ الإنشاء</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>

                        <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666; border-top: 1px solid #ddd; padding-top: 15px;">
                            <p>تم إنشاء هذا التقرير بواسطة نظام إدارة التسجيل الجامعي - جامعة الحاضرة</p>
                            <p>تاريخ الطباعة: ${formatDateArabic(new Date())}</p>
                        </div>
                    </div>
                `;
            }

            // Create cards report HTML (for print window)
            function createCardsReportHtml(cards, forPdf = false) {
                console.log('Creating report HTML for', cards.length, 'cards');

                const currentDate = formatDateArabic(new Date(), false);
                const totalCards = cards.length;
                const usedCards = cards.filter(card => Boolean(card.is_used)).length;
                const availableCards = totalCards - usedCards;
                const soldCards = cards.filter(card => Boolean(card.is_sold)).length;
                const notSoldCards = totalCards - soldCards;

                // Calculate total value
                const totalValue = cards.reduce((sum, card) => sum + (parseFloat(card.value) || 0), 0);
                const usedValue = cards.filter(card => Boolean(card.is_used))
                    .reduce((sum, card) => sum + (parseFloat(card.value) || 0), 0);
                const availableValue = totalValue - usedValue;

                // Generate table rows
                const tableRows = cards.map((card, index) => {
                    const isUsed = Boolean(card.is_used);
                    const isSold = Boolean(card.is_sold);

                    const usageStatus = isUsed ? 'مستخدم' : 'متاح';
                    const usageClass = isUsed ? 'status-used' : 'status-available';

                    const saleStatus = isSold ? 'مباع' : 'غير مباع';
                    const saleClass = isSold ? 'status-sold' : 'status-not-sold';

                    let usedBy = '-';
                    if (isUsed && card.used_by_student_name) {
                        const studentReg = card.used_by_student_registration || 'غير محدد';
                        usedBy = `${card.used_by_student_name} (${studentReg})`;
                    }

                    let usedAt = '-';
                    if (isUsed && card.used_at) {
                        usedAt = formatDateArabic(card.used_at, false);
                    }

                    let createdAt = formatDateArabic(card.created_at, false);

                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td><span class="card-number">${card.card_number}</span></td>
                            <td>${card.value} دينار</td>
                            <td><span class="${usageClass}">${usageStatus}</span></td>
                            <td><span class="${saleClass}">${saleStatus}</span></td>
                            <td>${usedBy}</td>
                            <td>${usedAt}</td>
                            <td>${createdAt}</td>
                        </tr>
                    `;
                }).join('');

                return `
                    <!DOCTYPE html>
                    <html dir="rtl" lang="ar">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>تقرير كروت الدفع المسبق</title>
                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                margin: 20px;
                                direction: rtl;
                                color: #333;
                                background: white;
                            }
                            .header {
                                text-align: center;
                                margin-bottom: 30px;
                                border-bottom: 2px solid #007bff;
                                padding-bottom: 20px;
                            }
                            .header h1 {
                                color: #007bff;
                                margin-bottom: 10px;
                            }
                            .summary {
                                display: grid;
                                grid-template-columns: repeat(4, 1fr);
                                gap: 15px;
                                margin-bottom: 30px;
                            }
                            .summary-card {
                                background: #f8f9fa;
                                padding: 15px;
                                border-radius: 8px;
                                border-left: 4px solid #007bff;
                                text-align: center;
                            }
                            .summary-card h3 {
                                margin: 0 0 10px 0;
                                color: #007bff;
                                font-size: 14px;
                            }
                            .summary-card .number {
                                font-size: 20px;
                                font-weight: bold;
                                color: #333;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-top: 20px;
                                font-size: 11px;
                            }
                            th, td {
                                border: 1px solid #ddd;
                                padding: 6px;
                                text-align: center;
                            }
                            th {
                                background-color: #007bff;
                                color: white;
                                font-weight: bold;
                            }
                            tr:nth-child(even) {
                                background-color: #f9f9f9;
                            }
                            .status-used { color: #dc3545; font-weight: bold; }
                            .status-available { color: #28a745; font-weight: bold; }
                            .status-sold { color: #fd7e14; font-weight: bold; }
                            .status-not-sold { color: #6c757d; font-weight: bold; }
                            .card-number {
                                font-family: 'Courier New', monospace;
                                font-weight: bold;
                                background-color: #f8f9fa;
                                padding: 2px 4px;
                                border-radius: 3px;
                            }
                            .footer {
                                margin-top: 30px;
                                text-align: center;
                                font-size: 12px;
                                color: #666;
                                border-top: 1px solid #ddd;
                                padding-top: 15px;
                            }
                            @media print {
                                body { font-family: Arial, sans-serif; }
                                .no-print { display: none !important; }
                            }

                            /* Button styles */
                            .print-button {
                                background-color: #007bff;
                                color: white;
                                border: none;
                                padding: 15px 30px;
                                border-radius: 5px;
                                font-size: 16px;
                                cursor: pointer;
                                margin: 0 10px;
                                transition: background-color 0.3s;
                            }

                            .print-button:hover {
                                background-color: #0056b3;
                            }

                            .close-button {
                                background-color: #6c757d;
                                color: white;
                                border: none;
                                padding: 15px 30px;
                                border-radius: 5px;
                                font-size: 16px;
                                cursor: pointer;
                                margin: 0 10px;
                                transition: background-color 0.3s;
                            }

                            .close-button:hover {
                                background-color: #545b62;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>🎓 تقرير كروت الدفع المسبق</h1>
                            <h2>جامعة الحاضرة</h2>
                            <p>تاريخ التقرير: ${currentDate}</p>
                        </div>

                        <div class="summary">
                            <div class="summary-card">
                                <h3>إجمالي الكروت</h3>
                                <div class="number">${totalCards}</div>
                            </div>
                            <div class="summary-card">
                                <h3>الكروت المستخدمة</h3>
                                <div class="number">${usedCards}</div>
                            </div>
                            <div class="summary-card">
                                <h3>الكروت المتاحة</h3>
                                <div class="number">${availableCards}</div>
                            </div>
                            <div class="summary-card">
                                <h3>الكروت المباعة</h3>
                                <div class="number">${soldCards}</div>
                            </div>
                        </div>

                        <div class="summary">
                            <div class="summary-card">
                                <h3>الكروت غير المباعة</h3>
                                <div class="number">${notSoldCards}</div>
                            </div>
                            <div class="summary-card">
                                <h3>إجمالي القيمة</h3>
                                <div class="number">${totalValue.toLocaleString()} دينار</div>
                            </div>
                            <div class="summary-card">
                                <h3>القيمة المستخدمة</h3>
                                <div class="number">${usedValue.toLocaleString()} دينار</div>
                            </div>
                            <div class="summary-card">
                                <h3>القيمة المتاحة</h3>
                                <div class="number">${availableValue.toLocaleString()} دينار</div>
                            </div>
                        </div>

                        <h3>تفاصيل الكروت:</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>رقم الكرت</th>
                                    <th>القيمة</th>
                                    <th>حالة الاستخدام</th>
                                    <th>حالة البيع</th>
                                    <th>مستخدم بواسطة</th>
                                    <th>تاريخ الاستخدام</th>
                                    <th>تاريخ الإنشاء</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>

                        <div class="footer">
                            <p>تم إنشاء هذا التقرير بواسطة نظام إدارة التسجيل الجامعي - جامعة الحاضرة</p>
                            <p>تاريخ الطباعة: ${formatDateArabic(new Date())}</p>
                        </div>

                        <!-- Print Button -->
                        <div style="text-align: center; margin: 20px 0; padding: 20px; border-top: 2px solid #007bff;" class="no-print">
                            <button onclick="window.print()" class="print-button">
                                <i class="fas fa-print"></i> طباعة التقرير
                            </button>
                            <button onclick="window.close()" class="close-button">
                                <i class="fas fa-times"></i> إغلاق
                            </button>
                            <div style="margin-top: 15px; font-size: 14px; color: #666;">
                                <p><i class="fas fa-info-circle"></i> اضغط على "طباعة التقرير" لطباعة هذا التقرير</p>
                                <p>أو استخدم <kbd>Ctrl+P</kbd> من لوحة المفاتيح</p>
                            </div>
                        </div>
                    </body>
                    </html>
                `;
            }

            // Mark card as sold
            function markCardAsSold(cardId, cardNumber) {
                if (!confirm(`هل أنت متأكد من تغيير حالة الكرت ${cardNumber} إلى "تم بيعه"؟\n\nملاحظة: يمكن التراجع عن هذا الإجراء لاحقاً.`)) {
                    return;
                }

                fetch(`/api/admin/prepaid-cards/${cardId}/mark-sold`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('تم تغيير حالة الكرت إلى "تم بيعه" بنجاح');
                        // Update the card in original data
                        const cardIndex = originalCardsData.findIndex(card => card.id == cardId);
                        if (cardIndex !== -1) {
                            originalCardsData[cardIndex].is_sold = 1;
                        }
                        // Reapply filters
                        applyFilters();
                    } else {
                        alert('حدث خطأ: ' + (data.error || 'خطأ غير معروف'));
                    }
                })
                .catch(error => {
                    console.error('Error marking card as sold:', error);
                    alert('حدث خطأ أثناء تغيير حالة الكرت');
                });
            }

            // Mark card as not sold
            function markCardAsNotSold(cardId, cardNumber) {
                console.log(`markCardAsNotSold called with cardId: ${cardId}, cardNumber: ${cardNumber}`);

                if (!confirm(`هل أنت متأكد من تغيير حالة الكرت ${cardNumber} إلى "غير مباع"؟\n\nسيصبح الكرت متاحاً للبيع مرة أخرى.`)) {
                    console.log('User cancelled the operation');
                    return;
                }

                console.log('Sending request to mark card as not sold...');
                fetch(`/api/admin/prepaid-cards/${cardId}/mark-not-sold`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    console.log('Response received:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.success) {
                        alert('تم تغيير حالة الكرت إلى "غير مباع" بنجاح');
                        // Update the card in original data
                        const cardIndex = originalCardsData.findIndex(card => card.id == cardId);
                        if (cardIndex !== -1) {
                            originalCardsData[cardIndex].is_sold = 0;
                        }
                        // Reapply filters
                        applyFilters();
                    } else {
                        alert('حدث خطأ: ' + (data.error || 'خطأ غير معروف'));
                    }
                })
                .catch(error => {
                    console.error('Error marking card as not sold:', error);
                    alert('حدث خطأ أثناء تغيير حالة الكرت: ' + error.message);
                });
            }

            // Delete card
            function deleteCard(cardId, cardNumber) {
                if (!confirm(`هل أنت متأكد من حذف الكرت ${cardNumber}؟`)) {
                    return;
                }

                fetch(`/api/admin/prepaid-cards/${cardId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('تم حذف الكرت بنجاح');
                        // Remove the card from original data
                        originalCardsData = originalCardsData.filter(card => card.id != cardId);
                        // Reapply filters
                        applyFilters();
                    } else {
                        alert('حدث خطأ: ' + (data.error || 'خطأ غير معروف'));
                    }
                })
                .catch(error => {
                    console.error('Error deleting card:', error);
                    alert('حدث خطأ أثناء حذف الكرت');
                });
            }

            // Delete used card
            function deleteUsedCard(cardId, cardNumber, studentName, studentRegistration) {
                console.log(`deleteUsedCard called with cardId: ${cardId}, cardNumber: ${cardNumber}, studentName: ${studentName}, studentRegistration: ${studentRegistration}`);

                // Show detailed confirmation with warning
                const confirmMessage = `⚠️ تحذير: حذف كرت مستخدم ⚠️

هل أنت متأكد من حذف الكرت المستخدم؟

تفاصيل الكرت:
• رقم الكرت: ${cardNumber}
• استخدمه الطالب: ${studentName}
• رقم القيد: ${studentRegistration}

⚠️ تنبيه مهم:
• هذا الإجراء لا يمكن التراجع عنه
• سيتم حذف الكرت نهائياً من النظام
• تأكد من أن هذا الإجراء ضروري

هل تريد المتابعة؟`;

                if (!confirm(confirmMessage)) {
                    console.log('User cancelled the delete operation');
                    return;
                }

                console.log('Sending request to delete used card...');
                fetch(`/api/admin/prepaid-cards/${cardId}/delete-used`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    console.log('Response received:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.success) {
                        alert(`✅ تم حذف الكرت المستخدم بنجاح\n\nتفاصيل الكرت المحذوف:\n• رقم الكرت: ${data.deletedCard?.card_number || cardNumber}\n• القيمة: ${data.deletedCard?.value || 'غير محدد'} دينار\n• استخدمه: ${data.deletedCard?.used_by_student_name || studentName}\n• رقم القيد: ${data.deletedCard?.used_by_student_registration || studentRegistration}`);
                        // Remove the card from original data
                        originalCardsData = originalCardsData.filter(card => card.id != cardId);
                        // Reapply filters
                        applyFilters();
                    } else {
                        alert('حدث خطأ: ' + (data.error || 'خطأ غير معروف'));
                    }
                })
                .catch(error => {
                    console.error('Error deleting used card:', error);
                    alert('حدث خطأ أثناء حذف الكرت المستخدم: ' + error.message);
                });
            }

            } // End of initializePage function

            // Ensure the prepaid cards nav item stays active
            function setActiveNavItem() {
                // Remove active class from all nav links
                document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                    link.classList.remove('active');
                });

                // Add active class to prepaid cards nav link
                const prepaidCardsLink = document.querySelector('a[href="prepaid-cards.html"]');
                if (prepaidCardsLink) {
                    prepaidCardsLink.classList.add('active');
                    console.log('✅ Set prepaid cards nav item as active');
                }
            }

            // Set active nav item on page load
            setActiveNavItem();

            // Also set it after a short delay to override any other scripts
            setTimeout(setActiveNavItem, 100);
            setTimeout(setActiveNavItem, 500);
        });
    </script>
</body>
</html>
