<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة حالة الدفع - جامعة الحاضرة</title>
    <link rel="stylesheet" href="../css/styles.css">
    <!-- Bootstrap RTL CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="../css/responsive.css">
    <style>
        /* Payment status styles */
        .payment-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            width: 220px; /* Fixed width for the container */
        }
        .payment-status-badge {
            font-size: 0.85rem;
            padding: 0.375rem 0;
            width: 100px;
            height: 32px;
            line-height: 1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            flex: 1;
            border-radius: 0.25rem;
        }
        .payment-toggle-btn {
            width: 100px;
            height: 32px;
            font-size: 0.85rem;
            padding: 0.375rem 0;
            text-align: center;
            margin: 0;
            flex: 1;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .payment-status-badge i, .payment-toggle-btn i {
            margin-right: 4px;
            font-size: 0.85rem;
        }

        /* Card styles */
        .student-card {
            margin-bottom: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .student-card .card-header {
            border-radius: 10px 10px 0 0;
        }
        .course-item {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        .course-item:last-child {
            border-bottom: none;
        }
        .course-item .d-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .course-info {
            flex-grow: 1;
            padding-left: 0.5rem;
        }
        .search-container {
            margin-bottom: 1.5rem;
        }
        .student-info {
            font-size: 0.9rem;
            color: #333;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .student-reg-number, .student-department {
            display: inline-block;
            background-color: rgba(255, 255, 255, 0.5);
            padding: 3px 10px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            font-weight: 500;
            color: #000;
        }
        .no-courses-message {
            padding: 1rem;
            text-align: center;
            color: #666;
        }

        /* Responsive styles */
        @media (max-width: 767.98px) {
            .course-item {
                padding: 0.5rem;
            }
            .course-item .d-flex {
                flex-direction: column;
                align-items: flex-start !important;
            }
            .payment-actions {
                margin-top: 0.5rem;
                width: 220px; /* Keep the same width as desktop */
                justify-content: space-between;
            }
            .payment-status-badge, .payment-toggle-btn {
                width: 100px;
                height: 32px;
                font-size: 0.85rem;
                padding: 0.375rem 0;
            }
            .student-card .card-header h5 {
                font-size: 1rem;
            }
            .student-info {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 5px;
            }
            .student-info span {
                margin: 0.1rem 0;
                margin-left: 0 !important;
                flex: 1 1 auto;
                min-width: 150px;
            }
            .student-reg-number, .student-department {
                display: inline-block;
                background-color: rgba(255, 255, 255, 0.5);
                padding: 3px 10px;
                border-radius: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
                font-weight: 500;
                color: #000;
            }
            .student-card .card-header .btn-sm {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
        }

        /* منع الوميض عند تحميل الصفحة */
        .admin-only, .student-only, .financial-only {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.1s ease-in-out;
        }

        /* إظهار العناصر بعد تحديد الدور */
        .admin-only.show, .student-only.show, .financial-only.show {
            visibility: visible;
            opacity: 1;
        }

        /* إخفاء عناصر الأدمن من البداية للمشرف المالي */
        .admin-only:not(.financial-only) {
            display: none !important;
        }

        /* إظهار عناصر المشرف المالي دائماً */
        .financial-only {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../images/images.jpg" alt="شعار الجامعة" class="img-fluid mb-3" style="max-height: 80px;">
                        <h5 class="text-white">جامعة الحاضرة</h5>
                        <p class="text-white fw-bold" id="user-role-title">لوحة تحكم المشرف المالي</p>
                    </div>
                    <ul class="nav flex-column">
                        <!-- Enlaces visibles solo para administradores -->
                        <li class="nav-item admin-only">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i>
                                لوحة التحكم
                            </a>
                        </li>
                        <li class="nav-item admin-only">
                            <a class="nav-link" href="students.html">
                                <i class="fas fa-user-graduate"></i>
                                إدارة الطلبة
                            </a>
                        </li>
                        <li class="nav-item admin-only">
                            <a class="nav-link" href="departments.html">
                                <i class="fas fa-building"></i>
                                إدارة التخصصات
                            </a>
                        </li>
                        <li class="nav-item admin-only">
                            <a class="nav-link" href="courses.html">
                                <i class="fas fa-book"></i>
                                إدارة المواد
                            </a>
                        </li>
                        <li class="nav-item admin-only">
                            <a class="nav-link" href="course-statistics.html">
                                <i class="fas fa-chart-bar"></i>
                                إحصائيات المواد
                            </a>
                        </li>
                        <!-- Enlace visible para administradores y supervisores financieros -->
                        <li class="nav-item admin-only financial-only" id="payment-management-nav">
                            <a class="nav-link active" href="payment-management.html">
                                <i class="fas fa-money-bill-wave"></i>
                                إدارة حالة الدفع
                            </a>
                        </li>
                        <li class="nav-item financial-only" id="prepaid-cards-nav">
                            <a class="nav-link" href="prepaid-cards.html">
                                <i class="fas fa-credit-card"></i>
                                كروت الدفع المسبق
                            </a>
                        </li>

                        <li class="nav-item financial-only" id="locked-accounts-nav">
                            <a class="nav-link" href="payment-management.html#locked-accounts-section" onclick="showLockedAccountsSection()">
                                <i class="fas fa-lock"></i>
                                الحسابات المجمدة
                            </a>
                        </li>
                        <li class="nav-item admin-only">
                            <a class="nav-link" href="profile.html">
                                <i class="fas fa-user-cog"></i>
                                إعدادات الحساب
                            </a>
                        </li>
                        <li class="nav-item mt-5">
                            <a class="nav-link text-danger" href="#" id="sidebar-logout-button">
                                <i class="fas fa-sign-out-alt"></i>
                                تسجيل الخروج
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main content -->
            <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">إدارة حالة الدفع</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user"></i>
                                <span id="user-name">المشرف</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                                <li><a class="dropdown-item" href="profile.html">إعدادات الحساب</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logout-button">تسجيل الخروج</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="row search-container">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="search-input" placeholder="ابحث عن طالب (الاسم أو رقم القيد)">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-end">
                            <button id="show-filtered-payment-report" class="btn btn-success">
                                <i class="fas fa-file-alt"></i> تقرير حسب التصنيف
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Advanced Filters -->
                <div class="row mt-3 mb-3">
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-university"></i>
                            </span>
                            <select class="form-select" id="filter-payment-department-select">
                                <option value="">جميع التخصصات</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-layer-group"></i>
                            </span>
                            <select class="form-select" id="filter-payment-semester-select">
                                <option value="">جميع الفصول الدراسية</option>
                                <option value="الأول">الفصل الأول</option>
                                <option value="الثاني">الفصل الثاني</option>
                                <option value="الثالث">الفصل الثالث</option>
                                <option value="الرابع">الفصل الرابع</option>
                                <option value="الخامس">الفصل الخامس</option>
                                <option value="السادس">الفصل السادس</option>
                                <option value="السابع">الفصل السابع</option>
                                <option value="الثامن">الفصل الثامن</option>
                                <option value="التاسع">الفصل التاسع</option>
                                <option value="العاشر">الفصل العاشر</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-users"></i>
                            </span>
                            <select class="form-select" id="filter-payment-group-select">
                                <option value="">جميع المجموعات</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-money-bill-wave"></i>
                            </span>
                            <select class="form-select" id="filter-payment-status-select">
                                <option value="">جميع حالات الدفع</option>
                                <option value="خالص">خالص</option>
                                <option value="غير خالص">غير خالص</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" id="reset-payment-filters">
                            <i class="fas fa-sync"></i> إعادة تعيين
                        </button>
                    </div>
                    <div class="col-md-9">
                        <div id="current-payment-filters" class="alert alert-info d-none">
                            <i class="fas fa-filter"></i> <span id="current-payment-filter-text">عرض جميع الطلبة</span>
                        </div>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loading-indicator" class="text-center my-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                    <p class="mt-2">جاري تحميل بيانات الطلبة والمواد...</p>
                </div>

                <!-- Error Message -->
                <div id="error-message" class="alert alert-danger my-3 d-none" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="error-text">حدث خطأ أثناء تحميل البيانات</span>
                </div>

                <!-- Students List -->
                <div id="students-container" class="d-none">
                    <!-- Students will be loaded here -->
                </div>

                <!-- No Results Message -->
                <div id="no-results" class="alert alert-info my-3 d-none" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="no-results-message">لا توجد نتائج مطابقة لبحثك</span>
                    <div class="mt-2">
                        <small>يمكنك تجربة:</small>
                        <ul class="mb-0 mt-1">
                            <li><small>تغيير معايير البحث أو الفلترة</small></li>
                            <li><small>إعادة تعيين الفلاتر بالضغط على زر "إعادة تعيين"</small></li>
                            <li><small>التأكد من وجود طلاب مسجلين في النظام</small></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Locked Accounts Section -->
    <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4 d-none" id="locked-accounts-section">
        <div class="container-fluid mt-4">
            <div class="row">
                <div class="col-12">
                    <!-- Back Button -->
                    <button class="btn btn-secondary mb-3" onclick="hideLockedAccountsSection()">
                        <i class="fas fa-arrow-right me-2"></i>العودة إلى إدارة الدفع
                    </button>

                    <div class="card shadow-sm">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-lock me-2"></i>
                                إدارة الحسابات المجمدة
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Search and Refresh -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" class="form-control" id="locked-accounts-search-input"
                                               placeholder="البحث عن طالب مجمد...">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-success" id="refresh-locked-accounts-btn">
                                        <i class="fas fa-sync-alt me-1"></i>
                                        تحديث القائمة
                                    </button>
                                </div>
                            </div>

                            <!-- Locked Accounts Table -->
                            <div id="locked-accounts-loading" class="text-center">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">جاري التحميل...</span>
                                </div>
                                <p>جاري تحميل بيانات الحسابات المجمدة...</p>
                            </div>

                            <div id="locked-accounts-error" class="alert alert-danger d-none">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span id="locked-accounts-error-text">حدث خطأ أثناء تحميل البيانات</span>
                            </div>

                            <div id="locked-accounts-container" class="d-none">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-warning">
                                            <tr>
                                                <th style="width: 30%;">
                                                    <i class="fas fa-user me-1"></i>الطالب
                                                </th>
                                                <th style="width: 20%;">
                                                    <i class="fas fa-building me-1"></i>التخصص
                                                </th>
                                                <th style="width: 25%;">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>سبب التجميد
                                                </th>
                                                <th style="width: 15%;">
                                                    <i class="fas fa-calendar me-1"></i>التاريخ
                                                </th>
                                                <th style="width: 10%;">
                                                    <i class="fas fa-tools me-1"></i>الإجراءات
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="locked-accounts-table-body">
                                            <!-- Locked accounts will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div id="no-locked-accounts" class="text-center py-5 d-none">
                                <i class="fas fa-unlock fa-3x text-success mb-3"></i>
                                <h5 class="text-success">لا توجد حسابات مجمدة</h5>
                                <p class="text-muted">جميع حسابات الطلبة نشطة</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Unlock Account Modal -->
    <div class="modal fade" id="unlockAccountModal" tabindex="-1" aria-labelledby="unlockAccountModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="unlockAccountModalLabel">
                        <i class="fas fa-unlock me-2"></i>
                        إلغاء تجميد الحساب
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>إلغاء تجميد حساب الطالب</strong><br>
                        <small>سيتم إلغاء تجميد الحساب وإعادة تفعيله للاستخدام</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">معلومات الطالب:</label>
                        <div id="unlock-student-info" class="p-3 bg-light rounded">
                            <!-- Student info will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>إلغاء
                    </button>
                    <button type="button" class="btn btn-success" id="confirmUnlockBtn">
                        <i class="fas fa-unlock me-1"></i>إلغاء التجميد
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Number Modal -->
    <div class="modal fade" id="receiptNumberModal" tabindex="-1" aria-labelledby="receiptNumberModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="receiptNumberModalLabel">
                        <i class="fas fa-money-check-alt me-2"></i>
                        تأكيد عملية الدفع
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="stopQRCamera()"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>تغيير حالة الدفع إلى "خالص"</strong><br>
                        <small>يرجى إدخال رقم الإيصال لتأكيد عملية الدفع</small>
                    </div>

                    <div class="mb-3">
                        <label for="receiptNumberInput" class="form-label fw-bold">
                            <i class="fas fa-receipt me-2"></i>
                            رقم الإيصال <span class="text-danger">*</span>
                        </label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">
                                <i class="fas fa-hashtag"></i>
                            </span>
                            <input type="text" class="form-control" id="receiptNumberInput"
                                   placeholder="أدخل رقم الإيصال (مثال: 12345)"
                                   required autocomplete="off">
                            <button class="btn btn-outline-primary" type="button" id="scanQRButton"
                                    title="مسح QR Code أو Barcode">
                                <i class="fas fa-qrcode me-1"></i>
                                <span class="d-none d-md-inline">مسح الكود</span>
                            </button>
                        </div>
                        <div class="form-text mt-2">
                            <i class="fas fa-lightbulb me-1"></i>
                            يمكنك إدخال رقم الإيصال يدوياً أو استخدام زر المسح لقراءة QR Code أو Barcode
                        </div>
                    </div>

                    <div id="receiptError" class="alert alert-danger d-none">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="receiptErrorText"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="stopQRCamera()">
                        <i class="fas fa-times me-2"></i>إلغاء
                    </button>
                    <button type="button" class="btn btn-success btn-lg" id="confirmReceiptButton" onclick="handleConfirmPayment()">
                        <i class="fas fa-check-circle me-2"></i>تأكيد الدفع
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtered Payment Report Modal -->
    <div class="modal fade" id="filteredPaymentReportModal" tabindex="-1" aria-labelledby="filteredPaymentReportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="filteredPaymentReportModalLabel">تقرير حالة الدفع حسب التصنيف</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="filtered-payment-report-loading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                        <p>جاري تحميل بيانات التقرير...</p>
                    </div>
                    <div id="filtered-payment-report-error" class="alert alert-danger d-none" role="alert">
                        حدث خطأ أثناء تحميل بيانات التقرير
                    </div>
                    <div id="filtered-payment-report-content" class="d-none">
                        <!-- تقرير الدفع حسب التصنيف سيتم تحميله هنا -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="print-filtered-payment-report">
                        <i class="fas fa-print"></i> طباعة التقرير
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- QR Code Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <!-- Barcode Scanner Library - Alternative CDN -->
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <!-- Responsive JS -->
    <script src="../js/responsive.js"></script>
    <!-- Modal Fixes JS -->
    <script src="../js/modal-fixes.js"></script>
    <script src="../js/main.js"></script>
    <!-- Auto Logout JS -->
    <script src="../js/auto-logout.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const searchInput = document.getElementById('search-input');
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const studentsContainer = document.getElementById('students-container');
            const noResults = document.getElementById('no-results');

            // Actualizar el título según el rol del usuario
            fetch('/api/user')
                .then(response => response.json())
                .then(data => {
                    const userRoleTitle = document.getElementById('user-role-title');
                    if (userRoleTitle && data.user) {
                        if (data.user.role === 'financial_supervisor') {
                            // النص افتراضي صحيح، لا حاجة لتغييره
                            document.title = 'إدارة حالة الدفع - المشرف المالي';
                        } else if (data.user.role === 'admin') {
                            userRoleTitle.textContent = 'لوحة تحكم المشرف';
                        }
                    }

                    // إظهار العناصر حسب دور المستخدم
                    if (data.user && data.user.role === 'admin') {
                        // إظهار عناصر الأدمن العادي
                        const adminOnlyElements = document.querySelectorAll('.admin-only:not(.financial-only)');
                        adminOnlyElements.forEach(element => {
                            element.style.display = 'block';
                        });
                    }

                    // التحقق من القسم النشط
                    const activeSection = sessionStorage.getItem('activeSection');
                    if (activeSection === 'receipts') {
                        // إزالة النشاط من "إدارة حالة الدفع"
                        const paymentManagementLink = document.querySelector('a[href="payment-management.html"]');
                        if (paymentManagementLink) {
                            paymentManagementLink.classList.remove('active');
                        }

                        // إضافة النشاط لـ "حالة الإيصالات"
                        const receiptsLink = document.querySelector('a[href="payment-management.html#receipts-section"]');
                        if (receiptsLink) {
                            receiptsLink.classList.add('active');
                        }

                        // مسح القيمة من sessionStorage
                        sessionStorage.removeItem('activeSection');

                        // التمرير إلى قسم الإيصالات
                        setTimeout(() => {
                            const receiptsSection = document.getElementById('receipts-section');
                            if (receiptsSection) {
                                receiptsSection.scrollIntoView({ behavior: 'smooth' });
                            }
                        }, 500);
                    }
                })
                .catch(error => {
                    console.error('Error fetching user info:', error);
                });

            // Variables para almacenar los filtros actuales
            let currentPaymentFilters = {
                department: '',
                semester: '',
                group: '',
                paymentStatus: '',
                search: ''
            };

            // Load students with their enrollments
            function loadStudentsEnrollments(filterDepartment = '', filterSemester = '', filterGroup = '', filterPaymentStatus = '', searchTerm = '') {
                // Show loading indicator and hide other elements
                loadingIndicator.classList.remove('d-none');
                studentsContainer.classList.add('d-none');
                errorMessage.classList.add('d-none');
                noResults.classList.add('d-none'); // Ocultar mensaje de "no hay resultados"

                // Actualizar los filtros actuales
                currentPaymentFilters = {
                    department: filterDepartment,
                    semester: filterSemester,
                    group: filterGroup,
                    paymentStatus: filterPaymentStatus,
                    search: searchTerm
                };

                // Fetch data from API
                fetch('/api/admin/students-enrollments')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('فشل في تحميل البيانات');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Hide loading indicator
                        loadingIndicator.classList.add('d-none');

                        // Filtrar los estudiantes según los criterios
                        let filteredStudents = data.students;

                        // Filtrar por departamento
                        if (filterDepartment) {
                            console.log('Filtrando por departamento:', filterDepartment, 'Tipo:', typeof filterDepartment);
                            console.log('Estudiantes antes del filtro de departamento:', filteredStudents.length);

                            // Mostrar información de departamentos disponibles
                            const departamentosDisponibles = new Set();
                            const departamentosInfo = [];

                            filteredStudents.forEach(student => {
                                if (student.department_id) {
                                    const deptId = String(student.department_id);
                                    departamentosDisponibles.add(deptId);
                                    departamentosInfo.push({
                                        studentName: student.name,
                                        deptId: deptId,
                                        deptIdType: typeof student.department_id,
                                        deptName: student.department_name
                                    });
                                }
                            });

                            console.log('Departamentos disponibles en los datos:', Array.from(departamentosDisponibles));
                            console.log('Información detallada de departamentos:', departamentosInfo);

                            // Asegurarse de que la comparación sea consistente (string vs string)
                            const filterDeptId = String(filterDepartment);
                            console.log('ID de departamento del filtro (convertido a string):', filterDeptId);

                            // Obtener el nombre del departamento seleccionado para mostrar en el mensaje
                            const departmentSelect = document.getElementById('filter-payment-department-select');
                            const departmentName = departmentSelect ?
                                departmentSelect.options[departmentSelect.selectedIndex].text : 'التخصص المحدد';
                            console.log('Nombre del departamento seleccionado:', departmentName);

                            const estudiantesFiltrados = filteredStudents.filter(student => {
                                // Convertir ambos valores a string para comparación consistente
                                const studentDeptId = student.department_id ? String(student.department_id) : '';

                                // Intentar diferentes formatos de comparación
                                const coincideExacto = studentDeptId === filterDeptId;
                                const coincideNumerico = parseInt(studentDeptId) === parseInt(filterDeptId);

                                // Verificar también por nombre de departamento si está disponible
                                const coincidePorNombre = student.department_name &&
                                    departmentName &&
                                    student.department_name.trim() === departmentName.trim();

                                const coincide = coincideExacto || coincideNumerico || coincidePorNombre;

                                console.log(`Estudiante: ${student.name}, Dept ID: ${studentDeptId} (${typeof student.department_id}), Dept Name: ${student.department_name}`);
                                console.log(`  con Filtro ID: ${filterDeptId}, Filtro Nombre: ${departmentName}`);
                                console.log(`  Coincide: ${coincide} (Exacto: ${coincideExacto}, Numérico: ${coincideNumerico}, Por Nombre: ${coincidePorNombre})`);

                                return coincide;
                            });

                            console.log('Estudiantes después del filtro de departamento:', estudiantesFiltrados.length);

                            // Si no hay resultados después del filtro, mostrar mensaje de "no hay resultados"
                            if (estudiantesFiltrados.length === 0) {
                                console.warn('No se encontraron estudiantes para el departamento:', filterDepartment);

                                // Obtener el nombre del departamento para el log
                                const departmentSelect = document.getElementById('filter-payment-department-select');
                                const departmentName = departmentSelect ?
                                    departmentSelect.options[departmentSelect.selectedIndex].text : 'المحدد';

                                // No mostrar mensaje de advertencia al usuario
                                console.log(`No hay datos para el departamento "${departmentName}". Mostrando mensaje de "no hay resultados".`);

                                // Aplicar el filtro vacío para mostrar "no hay resultados"
                                filteredStudents = [];

                                // Personalizar el mensaje de "no hay resultados"
                                const noResultsMessage = document.getElementById('no-results-message');
                                if (noResultsMessage) {
                                    noResultsMessage.textContent = `لا توجد بيانات متاحة للتخصص "${departmentName}".`;
                                }
                            } else {
                                // Aplicar el filtro si hay resultados
                                filteredStudents = estudiantesFiltrados;
                            }
                        }

                        // Filtrar por semestre
                        if (filterSemester) {
                            console.log('Filtrando por semestre:', filterSemester);
                            console.log('Estudiantes antes del filtro de semestre:', filteredStudents.length);

                            // Mostrar información de semestres disponibles
                            const semestresDisponibles = new Set();

                            // Verificamos si el estudiante tiene un semestre asignado directamente
                            filteredStudents.forEach(student => {
                                if (student.semester) {
                                    semestresDisponibles.add(student.semester);
                                }
                            });

                            console.log('Semestres disponibles en los datos:', Array.from(semestresDisponibles));

                            // Implementamos el filtro por semestre considerando SOLO el semestre del estudiante
                            // y NO los semestres de sus inscripciones
                            filteredStudents = filteredStudents.filter(student => {
                                // Verificar si el estudiante tiene un semestre asignado que coincide con el filtro
                                const coincide = student.semester && student.semester === filterSemester;

                                if (coincide) {
                                    console.log(`Estudiante ${student.name} coincide por semestre: ${student.semester}`);
                                }

                                return coincide;
                            });

                            console.log('Estudiantes después del filtro de semestre:', filteredStudents.length);

                            // Si no hay resultados después del filtro, mostramos un mensaje personalizado
                            if (filteredStudents.length === 0) {
                                console.warn('No se encontraron estudiantes para el semestre:', filterSemester);

                                // Personalizar el mensaje de "no hay resultados"
                                const noResultsMessage = document.getElementById('no-results-message');
                                if (noResultsMessage) {
                                    noResultsMessage.textContent = `لا توجد بيانات متاحة للفصل الدراسي "${filterSemester}".`;
                                }
                            }
                        }

                        // Filtrar por grupo
                        if (filterGroup) {
                            console.log('Filtrando por grupo de estudiante:', filterGroup);
                            console.log('Estudiantes antes del filtro de grupo:', filteredStudents.length);

                            // Mostrar información de grupos disponibles
                            const gruposDisponibles = new Set();
                            filteredStudents.forEach(student => {
                                if (student.group_name) {
                                    gruposDisponibles.add(student.group_name);
                                }
                            });
                            console.log('Grupos disponibles en los datos:', Array.from(gruposDisponibles));

                            // Implementamos un filtro para el grupo considerando SOLO el grupo del estudiante
                            // y NO los grupos de sus inscripciones
                            filteredStudents = filteredStudents.filter(student => {
                                // Verificar coincidencia exacta con el grupo del estudiante
                                const coincideExacto = student.group_name === filterGroup;

                                // Verificar coincidencia ignorando mayúsculas/minúsculas
                                const coincideInsensible = student.group_name &&
                                    filterGroup &&
                                    student.group_name.toLowerCase() === filterGroup.toLowerCase();

                                // Verificar coincidencia parcial (contiene)
                                const coincideParcial = student.group_name &&
                                    filterGroup &&
                                    student.group_name.includes(filterGroup);

                                const coincide = coincideExacto || coincideInsensible || coincideParcial;

                                if (coincide) {
                                    console.log(`Estudiante ${student.name}, grupo: ${student.group_name}, coincide: ${coincide}`);
                                }

                                return coincide;
                            });

                            // Si no hay resultados después del filtro, mostramos un mensaje
                            if (filteredStudents.length === 0) {
                                console.warn('No se encontraron estudiantes para el grupo:', filterGroup);

                                // Personalizar el mensaje de "no hay resultados"
                                const noResultsMessage = document.getElementById('no-results-message');
                                if (noResultsMessage) {
                                    noResultsMessage.textContent = `لا توجد بيانات متاحة للمجموعة "${filterGroup}".`;
                                }
                            }

                            console.log('Estudiantes después del filtro de grupo:', filteredStudents.length);
                        }

                        // Filtrar por estado de pago
                        if (filterPaymentStatus) {
                            console.log('Filtrando por estado de pago:', filterPaymentStatus);
                            console.log('Estudiantes antes del filtro de estado de pago:', filteredStudents.length);

                            // Filtrar estudiantes según el estado de pago de sus inscripciones
                            filteredStudents = filteredStudents.filter(student => {
                                // Si el estudiante no tiene inscripciones, no coincide con ningún filtro de pago
                                if (!student.enrollments || student.enrollments.length === 0) {
                                    return false;
                                }

                                if (filterPaymentStatus === 'خالص') {
                                    // Para "خالص" (pagado), todas las inscripciones deben estar pagadas
                                    return student.enrollments.every(enrollment =>
                                        enrollment.payment_status === 'paid' || enrollment.payment_status === 'خالص'
                                    );
                                } else if (filterPaymentStatus === 'غير خالص') {
                                    // Para "غير خالص" (no pagado), al menos una inscripción debe estar sin pagar
                                    return student.enrollments.some(enrollment =>
                                        enrollment.payment_status === 'unpaid' || enrollment.payment_status === 'غير خالص'
                                    );
                                }

                                // Si el filtro no coincide con ninguno de los valores esperados, no filtrar
                                return true;
                            });

                            console.log('Estudiantes después del filtro de estado de pago:', filteredStudents.length);
                        }

                        // Filtrar por término de búsqueda
                        if (searchTerm) {
                            const searchLower = searchTerm.toLowerCase();
                            filteredStudents = filteredStudents.filter(student =>
                                student.name.toLowerCase().includes(searchLower) ||
                                student.student_id.toLowerCase().includes(searchLower)
                            );

                            console.log('Estudiantes después del filtro de búsqueda:', filteredStudents.length);
                        }

                        // Actualizar la visualización de filtros actuales
                        updateCurrentFiltersDisplay(filterDepartment, filterSemester, filterGroup, filterPaymentStatus, searchTerm);

                        // Verificar si hay resultados después de aplicar todos los filtros
                        if (filteredStudents.length === 0) {
                            console.log('No hay resultados después de aplicar todos los filtros');

                            // Personalizar el mensaje de "no hay resultados" según los filtros aplicados
                            const noResultsMessage = document.getElementById('no-results-message');
                            if (noResultsMessage) {
                                let message = 'لا توجد نتائج مطابقة ';

                                if (searchTerm) {
                                    message += `للبحث عن "${searchTerm}" `;
                                }

                                if (filterDepartment || filterSemester || filterGroup) {
                                    message += 'مع الفلاتر المحددة: ';

                                    if (filterDepartment) {
                                        const departmentSelect = document.getElementById('filter-payment-department-select');
                                        const departmentName = departmentSelect ?
                                            departmentSelect.options[departmentSelect.selectedIndex].text : 'التخصص المحدد';
                                        message += `(${departmentName}) `;
                                    }

                                    if (filterSemester) {
                                        const semesterSelect = document.getElementById('filter-payment-semester-select');
                                        const semesterName = semesterSelect ?
                                            semesterSelect.options[semesterSelect.selectedIndex].text : 'الفصل المحدد';
                                        message += `(${semesterName}) `;
                                    }

                                    if (filterGroup) {
                                        message += `(مجموعة ${filterGroup}) `;
                                    }
                                }

                                noResultsMessage.textContent = message;
                            }

                            // Mostrar mensaje de "no hay resultados"
                            loadingIndicator.classList.add('d-none');
                            studentsContainer.classList.add('d-none');
                            noResults.classList.remove('d-none');
                        } else {
                            // Process and display data
                            displayStudents(filteredStudents);
                        }
                    })
                    .catch(error => {
                        // Hide loading indicator and show error
                        loadingIndicator.classList.add('d-none');
                        errorText.textContent = error.message;
                        errorMessage.classList.remove('d-none');
                    });
            }

            // Actualizar la visualización de filtros actuales
            function updateCurrentFiltersDisplay(filterDepartment, filterSemester, filterGroup, filterPaymentStatus, searchTerm) {
                const currentFilters = document.getElementById('current-payment-filters');
                const currentFilterText = document.getElementById('current-payment-filter-text');

                if (!currentFilters || !currentFilterText) return;

                // Construir la descripción del filtro
                let filterDescription = 'عرض';
                let hasFilters = false;

                if (filterDepartment) {
                    const departmentSelect = document.getElementById('filter-payment-department-select');
                    const departmentName = departmentSelect ?
                        departmentSelect.options[departmentSelect.selectedIndex].text : 'التخصص المحدد';

                    filterDescription += ` طلبة تخصص ${departmentName}`;
                    hasFilters = true;

                    // Resaltar el selector de departamento
                    if (departmentSelect) {
                        departmentSelect.classList.add('border-primary');
                        const groupText = departmentSelect.parentElement.querySelector('.input-group-text');
                        if (groupText) {
                            groupText.classList.add('bg-primary', 'text-white');
                            groupText.classList.remove('bg-light');
                        }
                    }
                } else {
                    // Quitar resaltado si no hay filtro de departamento
                    const departmentSelect = document.getElementById('filter-payment-department-select');
                    if (departmentSelect) {
                        departmentSelect.classList.remove('border-primary');
                        const groupText = departmentSelect.parentElement.querySelector('.input-group-text');
                        if (groupText) {
                            groupText.classList.remove('bg-primary', 'text-white');
                            groupText.classList.add('bg-light');
                        }
                    }
                }

                if (filterSemester) {
                    const semesterSelect = document.getElementById('filter-payment-semester-select');
                    const semesterName = semesterSelect ?
                        semesterSelect.options[semesterSelect.selectedIndex].text : 'الفصل المحدد';

                    if (hasFilters) {
                        filterDescription += ` في ${semesterName}`;
                    } else {
                        filterDescription += ` طلبة ${semesterName}`;
                        hasFilters = true;
                    }

                    // Resaltar el selector de semestre
                    if (semesterSelect) {
                        semesterSelect.classList.add('border-primary');
                        const groupText = semesterSelect.parentElement.querySelector('.input-group-text');
                        if (groupText) {
                            groupText.classList.add('bg-primary', 'text-white');
                            groupText.classList.remove('bg-light');
                        }
                    }
                } else {
                    // Quitar resaltado si no hay filtro de semestre
                    const semesterSelect = document.getElementById('filter-payment-semester-select');
                    if (semesterSelect) {
                        semesterSelect.classList.remove('border-primary');
                        const groupText = semesterSelect.parentElement.querySelector('.input-group-text');
                        if (groupText) {
                            groupText.classList.remove('bg-primary', 'text-white');
                            groupText.classList.add('bg-light');
                        }
                    }
                }

                if (filterGroup) {
                    const groupSelect = document.getElementById('filter-payment-group-select');
                    const groupName = groupSelect ?
                        groupSelect.options[groupSelect.selectedIndex].text : 'المجموعة المحددة';

                    if (hasFilters) {
                        filterDescription += ` (مجموعة ${filterGroup})`;
                    } else {
                        filterDescription += ` طلبة مجموعة ${filterGroup}`;
                        hasFilters = true;
                    }

                    // Resaltar el selector de grupo
                    if (groupSelect) {
                        groupSelect.classList.add('border-primary');
                        const groupText = groupSelect.parentElement.querySelector('.input-group-text');
                        if (groupText) {
                            groupText.classList.add('bg-primary', 'text-white');
                            groupText.classList.remove('bg-light');
                        }
                    }
                } else {
                    // Quitar resaltado si no hay filtro de grupo
                    const groupSelect = document.getElementById('filter-payment-group-select');
                    if (groupSelect) {
                        groupSelect.classList.remove('border-primary');
                        const groupText = groupSelect.parentElement.querySelector('.input-group-text');
                        if (groupText) {
                            groupText.classList.remove('bg-primary', 'text-white');
                            groupText.classList.add('bg-light');
                        }
                    }
                }

                if (filterPaymentStatus) {
                    const paymentStatusSelect = document.getElementById('filter-payment-status-select');
                    const paymentStatusName = paymentStatusSelect ?
                        paymentStatusSelect.options[paymentStatusSelect.selectedIndex].text : filterPaymentStatus;

                    if (hasFilters) {
                        filterDescription += ` (${paymentStatusName})`;
                    } else {
                        filterDescription += ` طلبة بحالة دفع ${paymentStatusName}`;
                        hasFilters = true;
                    }

                    // Resaltar el selector de estado de pago
                    if (paymentStatusSelect) {
                        paymentStatusSelect.classList.add('border-primary');
                        const groupText = paymentStatusSelect.parentElement.querySelector('.input-group-text');
                        if (groupText) {
                            groupText.classList.add('bg-primary', 'text-white');
                            groupText.classList.remove('bg-light');
                        }
                    }
                } else {
                    // Quitar resaltado si no hay filtro de estado de pago
                    const paymentStatusSelect = document.getElementById('filter-payment-status-select');
                    if (paymentStatusSelect) {
                        paymentStatusSelect.classList.remove('border-primary');
                        const groupText = paymentStatusSelect.parentElement.querySelector('.input-group-text');
                        if (groupText) {
                            groupText.classList.remove('bg-primary', 'text-white');
                            groupText.classList.add('bg-light');
                        }
                    }
                }

                if (searchTerm) {
                    if (hasFilters) {
                        filterDescription += ` (بحث: ${searchTerm})`;
                    } else {
                        filterDescription += ` نتائج البحث عن "${searchTerm}"`;
                        hasFilters = true;
                    }
                }

                if (!hasFilters) {
                    filterDescription += ' جميع الطلبة';
                }

                // Actualizar el texto del filtro
                currentFilterText.textContent = filterDescription;

                // Mostrar u ocultar el contenedor de filtros
                if (hasFilters) {
                    currentFilters.classList.remove('d-none');
                } else {
                    currentFilters.classList.add('d-none');
                }
            }

            // Display students and their enrollments
            function displayStudents(students) {
                // Clear container
                studentsContainer.innerHTML = '';

                // Check if there are students
                if (students.length === 0) {
                    noResults.classList.remove('d-none');
                    studentsContainer.classList.add('d-none');
                    return;
                } else {
                    // Asegurarse de que el mensaje "no hay resultados" esté oculto
                    noResults.classList.add('d-none');
                    studentsContainer.classList.remove('d-none');
                }

                // Create HTML for each student
                students.forEach(student => {
                    const studentCard = document.createElement('div');
                    studentCard.className = 'card student-card';
                    studentCard.dataset.studentId = student.id;
                    studentCard.dataset.studentName = student.name;
                    studentCard.dataset.studentRegistration = student.student_id;

                    // Create card header
                    const cardHeader = document.createElement('div');
                    cardHeader.className = 'card-header bg-primary text-white';
                    cardHeader.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">${student.name}</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-light me-2 print-payment-report-btn" data-student-id="${student.id}">
                                    <i class="fas fa-file-invoice-dollar me-1"></i> تقرير الدفع
                                </button>
                                <span class="badge bg-light text-dark">${student.student_id}</span>
                            </div>
                        </div>
                        <div class="student-info mt-1">
                            <span class="student-reg-number"><i class="fas fa-id-card me-1"></i> رقم المنظومة: ${student.registration_number}</span>
                            <span class="student-department ms-3"><i class="fas fa-building me-1"></i> التخصص: ${student.department_name || 'غير محدد'}</span>
                        </div>
                    `;
                    studentCard.appendChild(cardHeader);

                    // Create card body
                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body p-0';

                    // Check if student has enrollments
                    if (!student.enrollments || student.enrollments.length === 0) {
                        cardBody.innerHTML = `
                            <div class="no-courses-message">
                                <i class="fas fa-info-circle me-1"></i>
                                لم يسجل الطالب في أي مادة
                            </div>
                        `;
                    } else {
                        // Create list of courses
                        const coursesList = document.createElement('ul');
                        coursesList.className = 'list-group list-group-flush';

                        student.enrollments.forEach(enrollment => {
                            const courseItem = document.createElement('li');
                            courseItem.className = 'list-group-item course-item';
                            courseItem.dataset.enrollmentId = enrollment.enrollment_id;

                            // Determine payment status and button style
                            const isPaid = enrollment.payment_status === 'خالص';
                            const statusBadgeClass = isPaid ? 'bg-success' : 'bg-danger';
                            const toggleBtnClass = isPaid ? 'btn-outline-danger' : 'btn-outline-success';
                            const toggleBtnIcon = isPaid ? 'fa-times-circle' : 'fa-check-circle';
                            const toggleBtnText = isPaid ? 'غير خالص' : 'خالص';

                            courseItem.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="course-info">
                                        <strong>${enrollment.course_name || enrollment.name || 'غير محدد'}</strong>
                                        <small class="text-muted ms-2">(${enrollment.course_code})</small>
                                        ${enrollment.group_name ? `<span class="badge bg-secondary ms-2">مجموعة ${enrollment.group_name}</span>` : ''}
                                    </div>
                                    <div class="payment-actions d-flex flex-column align-items-end">
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="badge ${statusBadgeClass} payment-status-badge me-2">
                                                <i class="fas ${isPaid ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                                <span>${enrollment.payment_status || 'غير خالص'}</span>
                                            </span>
                                            <button class="btn ${toggleBtnClass} btn-sm payment-toggle-btn"
                                                    data-enrollment-id="${enrollment.enrollment_id}"
                                                    data-current-status="${enrollment.payment_status || 'غير خالص'}"
                                                    data-receipt-number="${enrollment.receipt_number || ''}">
                                                <i class="fas ${toggleBtnIcon}"></i>
                                                <span>${toggleBtnText}</span>
                                            </button>
                                        </div>
                                        ${(function() {
                                            console.log('🏠 MAIN UI SIMPLE CHECK - Student:', '${student.name}', 'Course:', enrollment.course_name, 'Receipt:', enrollment.receipt_number, 'Type:', typeof enrollment.receipt_number);

                                            // Simple validation - just check if it exists and is not empty
                                            const isValid = Boolean(enrollment.receipt_number && String(enrollment.receipt_number).trim() !== '');

                                            console.log('🏠 MAIN UI SIMPLE CHECK - Is valid:', isValid, 'Will display:', isValid ? enrollment.receipt_number : 'nothing');

                                            return isValid;
                                        })() ? `
                                            <div class="receipt-info">
                                                <span class="badge bg-info text-dark">
                                                    <i class="fas fa-receipt me-1"></i>
                                                    رقم الإيصال: ${enrollment.receipt_number}
                                                </span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                            coursesList.appendChild(courseItem);
                        });

                        cardBody.appendChild(coursesList);
                    }

                    studentCard.appendChild(cardBody);
                    studentsContainer.appendChild(studentCard);
                });

                // Show students container
                studentsContainer.classList.remove('d-none');

                // Add event listeners to payment toggle buttons
                document.querySelectorAll('.payment-toggle-btn').forEach(button => {
                    button.addEventListener('click', togglePaymentStatus);
                });

                // Add event listeners to payment report buttons
                document.querySelectorAll('.print-payment-report-btn').forEach(button => {
                    button.addEventListener('click', generatePaymentReport);
                });
            }

            // Variables to store current payment operation
            let currentPaymentButton = null;
            let currentEnrollmentId = null;
            let currentPaymentStatus = null;

            // Function to show success notification
            function showSuccessNotification(message, details = '') {
                // Remove any existing notifications
                const existingNotifications = document.querySelectorAll('.success-notification');
                existingNotifications.forEach(notification => notification.remove());

                // Create notification element
                const notification = document.createElement('div');
                notification.className = 'success-notification position-fixed top-0 end-0 m-3';
                notification.style.zIndex = '9999';
                notification.innerHTML = `
                    <div class="alert alert-success alert-dismissible fade show shadow-lg" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-2 fs-4"></i>
                            <div>
                                <strong>${message}</strong>
                                ${details ? `<br><small class="text-muted">${details}</small>` : ''}
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;

                // Add to page
                document.body.appendChild(notification);

                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (notification && notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }

            // Function to show receipt error
            function showReceiptError(message) {
                const receiptError = document.getElementById('receiptError');
                const receiptErrorText = document.getElementById('receiptErrorText');

                if (receiptError && receiptErrorText) {
                    receiptErrorText.textContent = message;
                    receiptError.classList.remove('d-none');
                }
            }

            // Toggle payment status
            function togglePaymentStatus(event) {
                const button = event.currentTarget;
                const enrollmentId = button.dataset.enrollmentId;
                const currentStatus = button.dataset.currentStatus;
                const newStatus = currentStatus === 'خالص' ? 'غير خالص' : 'خالص';

                // Store current operation details
                currentPaymentButton = button;
                currentEnrollmentId = enrollmentId;
                currentPaymentStatus = newStatus;

                // If changing to paid status, show receipt number modal
                if (newStatus === 'خالص') {
                    // Clear previous input
                    document.getElementById('receiptNumberInput').value = '';
                    document.getElementById('receiptError').classList.add('d-none');

                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('receiptNumberModal'));
                    modal.show();
                } else {
                    // If changing to unpaid, proceed directly
                    updatePaymentStatus(enrollmentId, newStatus, null, button);
                }
            }

            // Update payment status function
            function updatePaymentStatus(enrollmentId, paymentStatus, receiptNumber, button) {
                // Disable button and show loading state
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span><span>جاري...</span>';

                // Prepare request body
                const requestBody = { payment_status: paymentStatus };
                if (receiptNumber) {
                    requestBody.receipt_number = receiptNumber;
                }

                // Update payment status via API
                fetch(`/api/admin/enrollments/${enrollmentId}/payment-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || 'فشل في تحديث حالة الدفع');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Update UI
                    const listItem = button.closest('.course-item');
                    const statusBadge = listItem.querySelector('.payment-status-badge');
                    const paymentActions = listItem.querySelector('.payment-actions');

                    // Update badge
                    statusBadge.className = `badge payment-status-badge me-2 ${paymentStatus === 'خالص' ? 'bg-success' : 'bg-danger'}`;
                    statusBadge.innerHTML = `<i class="fas ${paymentStatus === 'خالص' ? 'fa-check-circle' : 'fa-times-circle'}"></i><span>${paymentStatus}</span>`;

                    // Update or remove receipt number display
                    const existingReceiptDisplay = paymentActions.querySelector('.receipt-info');
                    if (existingReceiptDisplay) {
                        existingReceiptDisplay.remove();
                    }

                    if (paymentStatus === 'خالص' && receiptNumber) {
                        const receiptDisplay = document.createElement('div');
                        receiptDisplay.className = 'receipt-info';
                        receiptDisplay.innerHTML = `
                            <span class="badge bg-info text-dark">
                                <i class="fas fa-receipt me-1"></i>
                                رقم الإيصال: ${receiptNumber}
                            </span>
                        `;
                        paymentActions.appendChild(receiptDisplay);
                    }

                    // Update button
                    button.className = `btn ${paymentStatus === 'خالص' ? 'btn-outline-danger' : 'btn-outline-success'} btn-sm payment-toggle-btn`;
                    button.innerHTML = `<i class="fas ${paymentStatus === 'خالص' ? 'fa-times-circle' : 'fa-check-circle'}"></i><span>${paymentStatus === 'خالص' ? 'غير خالص' : 'خالص'}</span>`;
                    button.dataset.currentStatus = paymentStatus;
                    button.dataset.receiptNumber = receiptNumber || '';
                    button.disabled = false;

                    // Show success message with enhanced styling
                    if (paymentStatus === 'خالص') {
                        // Create a more elegant success notification
                        showSuccessNotification(`تم تحديث حالة الدفع إلى "خالص" بنجاح`, `رقم الإيصال: ${receiptNumber}`);
                    } else {
                        showSuccessNotification('تم تحديث حالة الدفع إلى "غير خالص" بنجاح', '');
                    }
                })
                .catch(error => {
                    // Show error and re-enable button
                    alert('حدث خطأ: ' + error.message);
                    button.disabled = false;
                    const originalStatus = button.dataset.currentStatus;
                    button.innerHTML = `<i class="fas ${originalStatus === 'خالص' ? 'fa-times-circle' : 'fa-check-circle'}"></i><span>${originalStatus === 'خالص' ? 'غير خالص' : 'خالص'}</span>`;
                });
            }

            // Search functionality
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();

                // Obtener los valores actuales de los filtros
                const filterDepartment = document.getElementById('filter-payment-department-select') ?
                    document.getElementById('filter-payment-department-select').value : '';
                const filterSemester = document.getElementById('filter-payment-semester-select') ?
                    document.getElementById('filter-payment-semester-select').value : '';
                const filterGroup = document.getElementById('filter-payment-group-select') ?
                    document.getElementById('filter-payment-group-select').value : '';
                const filterPaymentStatus = document.getElementById('filter-payment-status-select') ?
                    document.getElementById('filter-payment-status-select').value : '';

                // Usar la misma función de carga con filtros para mantener consistencia
                loadStudentsEnrollments(filterDepartment, filterSemester, filterGroup, filterPaymentStatus, searchTerm);
            });

            // Generate payment report for a student
            function generatePaymentReport(event) {
                const button = event.currentTarget;
                const studentId = button.dataset.studentId;
                const studentCard = button.closest('.student-card');
                const studentName = studentCard.dataset.studentName;
                const studentRegistration = studentCard.dataset.studentRegistration;

                // Show loading state
                button.disabled = true;
                const originalButtonHtml = button.innerHTML;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> جاري التحميل...';

                // Fetch student data
                fetch(`/api/admin/students/${studentId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('فشل في الحصول على بيانات الطالب');
                        }
                        return response.json();
                    })
                    .then(studentData => {
                        const student = studentData.student;

                        // Fetch student courses
                        return fetch(`/api/admin/students/${studentId}/courses`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('فشل في الحصول على بيانات المواد');
                                }
                                return response.json();
                            })
                            .then(coursesData => {
                                // Generate report
                                generatePaymentReportPDF(student, coursesData);

                                // Reset button
                                button.disabled = false;
                                button.innerHTML = originalButtonHtml;
                            });
                    })
                    .catch(error => {
                        // Show error and reset button
                        alert('حدث خطأ: ' + error.message);
                        button.disabled = false;
                        button.innerHTML = originalButtonHtml;
                    });
            }

            // Generate PDF report for payment status
            function generatePaymentReportPDF(student, coursesData) {
                // Filter courses by payment status
                const paidCourses = coursesData.enrolledCourses.filter(course => course.payment_status === 'خالص');
                const unpaidCourses = coursesData.enrolledCourses.filter(course => course.payment_status !== 'خالص');

                // Calculate financial summary
                let totalFees = 0;
                let paidFees = 0;
                let remainingFees = 0;

                coursesData.enrolledCourses.forEach(course => {
                    const price = parseFloat(course.price) || 0;
                    totalFees += price;

                    if (course.payment_status === 'خالص') {
                        paidFees += price;
                    } else {
                        remainingFees += price;
                    }
                });

                // Generate report HTML
                let reportHtml = `
                    <div class="student-report-container">
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-user-graduate me-2"></i>
                                        معلومات الطالب
                                    </h5>
                                    <span class="badge bg-light text-dark">
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        ${new Date().toLocaleDateString('ar-LY', {
                                            weekday: 'long',
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric'
                                        })}
                                    </span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="info-group">
                                            <h6 class="text-primary mb-3">
                                                <i class="fas fa-id-card me-2"></i>
                                                البيانات الشخصية
                                            </h6>
                                            <div class="info-item-right">
                                                <span class="info-label">الاسم الكامل:</span>
                                                <span class="info-value fw-bold">${student.name}</span>
                                            </div>
                                            <div class="info-item-right">
                                                <span class="info-label">رقم القيد:</span>
                                                <span class="info-value badge bg-secondary">${student.student_id}</span>
                                            </div>
                                            <div class="info-item-right">
                                                <span class="info-label">رقم المنظومة:</span>
                                                <span class="info-value badge bg-info">${student.registration_number}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-group">
                                            <h6 class="text-success mb-3">
                                                <i class="fas fa-graduation-cap me-2"></i>
                                                البيانات الأكاديمية
                                            </h6>
                                            <div class="info-item-right">
                                                <span class="info-label">التخصص:</span>
                                                <span class="info-value fw-bold">${student.department_name || 'غير محدد'}</span>
                                            </div>
                                            <div class="info-item-right">
                                                <span class="info-label">الفصل الدراسي:</span>
                                                <span class="info-value badge bg-warning text-dark">${student.semester || 'الأول'}</span>
                                            </div>
                                            <div class="info-item-right">
                                                <span class="info-label">المجموعة:</span>
                                                <span class="info-value badge bg-primary">${student.group_name || 'غير محدد'}</span>
                                            </div>
                                            <div class="info-item-right">
                                                <span class="info-label">إجمالي المواد المسجلة:</span>
                                                <span class="info-value badge bg-success">${coursesData.enrolledCourses.length} مادة</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="card-title mb-0">الملخص المالي</h5>
                            </div>
                            <div class="card-body">
                                <!-- Financial Summary Table -->
                                <div class="financial-summary-table">
                                    <table class="table table-bordered table-hover mb-0">
                                        <thead class="table-primary">
                                            <tr>
                                                <th class="text-center" style="width: 25%;">
                                                    <i class="fas fa-chart-line me-2"></i>البيان المالي
                                                </th>
                                                <th class="text-center" style="width: 25%;">
                                                    <i class="fas fa-coins me-2"></i>إجمالي الرسوم
                                                </th>
                                                <th class="text-center" style="width: 25%;">
                                                    <i class="fas fa-check-circle me-2"></i>المدفوع
                                                </th>
                                                <th class="text-center" style="width: 25%;">
                                                    <i class="fas fa-exclamation-circle me-2"></i>المتبقي
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="financial-row">
                                                <td class="text-center fw-bold text-primary">
                                                    <i class="fas fa-money-bill-wave me-2"></i>المبلغ (دينار)
                                                </td>
                                                <td class="text-center">
                                                    <span class="financial-amount total-amount">
                                                        ${totalFees.toLocaleString('ar-LY')}
                                                    </span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="financial-amount paid-amount">
                                                        ${paidFees.toLocaleString('ar-LY')}
                                                    </span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="financial-amount remaining-amount">
                                                        ${remainingFees.toLocaleString('ar-LY')}
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr class="percentage-row">
                                                <td class="text-center fw-bold text-info">
                                                    <i class="fas fa-percentage me-2"></i>النسبة المئوية
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary fs-6">100%</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-success fs-6">
                                                        ${totalFees > 0 ? (paidFees / totalFees * 100).toFixed(1) : 0}%
                                                    </span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-danger fs-6">
                                                        ${totalFees > 0 ? (remainingFees / totalFees * 100).toFixed(1) : 0}%
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Progress Bar -->
                                <div class="mt-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-bold text-muted">
                                            <i class="fas fa-chart-bar me-2"></i>مؤشر التقدم في الدفع
                                        </span>
                                        <span class="badge bg-info">
                                            ${totalFees > 0 ? (paidFees / totalFees * 100).toFixed(1) : 0}% مكتمل
                                        </span>
                                    </div>
                                    <div class="progress progress-enhanced" style="height: 40px;">
                                        <div class="progress-bar bg-gradient progress-bar-striped progress-bar-animated"
                                             role="progressbar"
                                             style="width: ${totalFees > 0 ? (paidFees / totalFees * 100) : 0}%"
                                             aria-valuenow="${totalFees > 0 ? (paidFees / totalFees * 100) : 0}"
                                             aria-valuemin="0"
                                             aria-valuemax="100">
                                            <span class="fw-bold progress-text">
                                                ${paidFees.toLocaleString('ar-LY')} من ${totalFees.toLocaleString('ar-LY')} دينار
                                            </span>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2 text-sm">
                                        <span class="text-success">
                                            <i class="fas fa-check-circle me-1"></i>مدفوع: ${paidFees.toLocaleString('ar-LY')} دينار
                                        </span>
                                        <span class="text-danger">
                                            <i class="fas fa-clock me-1"></i>متبقي: ${remainingFees.toLocaleString('ar-LY')} دينار
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="card-title mb-0">المواد المدفوعة (خالص)</h5>
                            </div>
                            <div class="card-body">
                `;

                if (paidCourses.length === 0) {
                    reportHtml += `<div class="alert alert-info">لا توجد مواد مدفوعة</div>`;
                } else {
                    reportHtml += `
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-success">
                                    <tr>
                                        <th>#</th>
                                        <th>رمز المادة</th>
                                        <th>اسم المادة</th>
                                        <th>الفصل الدراسي</th>
                                        <th>الرسوم</th>
                                        <th>رقم الإيصال</th>
                                        <th>تاريخ التسجيل</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    paidCourses.forEach((course, index) => {
                        console.log('📄 Report - Processing paid course:', course);
                        console.log('📄 Report - Receipt number:', course.receipt_number, 'Type:', typeof course.receipt_number);

                        // Format date
                        const enrollmentDate = new Date(course.created_at);
                        const formattedDate = enrollmentDate.toLocaleDateString('ar-LY');

                        // Get course semester
                        const courseSemester = course.semester || 'غير محدد';

                        // SIMPLIFIED: Check if receipt number is valid
                        console.log('📄 SIMPLE CHECK - Course:', course.course_name, 'Receipt:', course.receipt_number, 'Type:', typeof course.receipt_number);

                        // Simple validation - just check if it exists and is not empty
                        const isValidReceipt = Boolean(course.receipt_number && String(course.receipt_number).trim() !== '');

                        console.log('📄 SIMPLE CHECK - Is valid:', isValidReceipt, 'Will display:', isValidReceipt ? course.receipt_number : 'غير محدد');

                        const coursePrice = parseFloat(course.price) || 0;
                        const formattedPrice = coursePrice.toLocaleString('ar-LY');

                        reportHtml += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${course.course_code}</td>
                                <td>${course.course_name || course.name || 'غير محدد'}</td>
                                <td>${courseSemester}</td>
                                <td><span class="badge bg-success">${formattedPrice} دينار</span></td>
                                <td><span class="badge ${isValidReceipt ? 'bg-info text-white' : 'bg-secondary text-white'}">${isValidReceipt ? course.receipt_number : 'غير محدد'}</span></td>
                                <td>${formattedDate}</td>
                            </tr>
                        `;
                    });

                    reportHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                reportHtml += `
                            </div>
                            <div class="card-footer text-muted text-center">
                                إجمالي المواد المدفوعة: ${paidCourses.length}
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header bg-danger text-white">
                                <h5 class="card-title mb-0">المواد غير المدفوعة (غير خالص)</h5>
                            </div>
                            <div class="card-body">
                `;

                if (unpaidCourses.length === 0) {
                    reportHtml += `<div class="alert alert-info">لا توجد مواد غير مدفوعة</div>`;
                } else {
                    reportHtml += `
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-danger">
                                    <tr>
                                        <th>#</th>
                                        <th>رمز المادة</th>
                                        <th>اسم المادة</th>
                                        <th>الفصل الدراسي</th>
                                        <th>الرسوم</th>
                                        <th>تاريخ التسجيل</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    unpaidCourses.forEach((course, index) => {
                        // Format date
                        const enrollmentDate = new Date(course.created_at);
                        const formattedDate = enrollmentDate.toLocaleDateString('ar-LY');

                        // Get course semester
                        const courseSemester = course.semester || 'غير محدد';

                        const coursePrice = parseFloat(course.price) || 0;
                        const formattedPrice = coursePrice.toLocaleString('ar-LY');

                        reportHtml += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${course.course_code}</td>
                                <td>${course.course_name || course.name || 'غير محدد'}</td>
                                <td>${courseSemester}</td>
                                <td><span class="badge bg-danger">${formattedPrice} دينار</span></td>
                                <td>${formattedDate}</td>
                            </tr>
                        `;
                    });

                    reportHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                reportHtml += `
                            </div>
                            <div class="card-footer text-muted text-center">
                                إجمالي المواد غير المدفوعة: ${unpaidCourses.length}
                            </div>
                        </div>
                    </div>
                `;

                try {
                    // Create a new window for printing
                    const printWindow = window.open('', '_blank');

                    // Check if the window was successfully opened
                    if (!printWindow || printWindow.closed || typeof printWindow.document === 'undefined') {
                        throw new Error('تم حظر النافذة المنبثقة. يرجى السماح بالنوافذ المنبثقة لهذا الموقع وإعادة المحاولة.');
                    }

                    // Try to access document to ensure it's available
                    try {
                        // Write content to the new window
                        printWindow.document.write(`
                            <!DOCTYPE html>
                            <html lang="ar" dir="rtl">
                            <head>
                                <meta charset="UTF-8">
                                <title>تقرير حالة الدفع - ${student.name}</title>
                                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
                                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                                <style>
                                    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');

                                    * {
                                        box-sizing: border-box;
                                    }

                                    body {
                                        font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                        direction: rtl;
                                        text-align: right;
                                        padding: 0;
                                        margin: 0;
                                        color: #2c3e50;
                                        line-height: 1.6;
                                        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                        min-height: 100vh;
                                    }

                                    .container {
                                        max-width: 1200px;
                                        margin: 0 auto;
                                        padding: 20px;
                                        background: white;
                                        box-shadow: 0 0 30px rgba(0,0,0,0.1);
                                        border-radius: 15px;
                                        margin-top: 20px;
                                        margin-bottom: 20px;
                                    }

                                    .report-header {
                                        text-align: center;
                                        margin-bottom: 40px;
                                        padding: 30px 20px;
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        color: white;
                                        border-radius: 15px;
                                        position: relative;
                                        overflow: hidden;
                                    }

                                    .report-header::before {
                                        content: '';
                                        position: absolute;
                                        top: -50%;
                                        left: -50%;
                                        width: 200%;
                                        height: 200%;
                                        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="50" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="30" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
                                        animation: float 20s ease-in-out infinite;
                                        pointer-events: none;
                                    }

                                    @keyframes float {
                                        0%, 100% { transform: translateY(0px) rotate(0deg); }
                                        50% { transform: translateY(-10px) rotate(1deg); }
                                    }

                                    .report-header h1 {
                                        font-size: 32px;
                                        font-weight: 700;
                                        margin-bottom: 10px;
                                        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                                        position: relative;
                                        z-index: 1;
                                    }

                                    .report-header .university-name {
                                        font-size: 18px;
                                        font-weight: 400;
                                        margin-bottom: 5px;
                                        opacity: 0.9;
                                        position: relative;
                                        z-index: 1;
                                    }

                                    .report-header .system-name {
                                        font-size: 14px;
                                        font-weight: 300;
                                        opacity: 0.8;
                                        position: relative;
                                        z-index: 1;
                                    }

                                    .report-date {
                                        text-align: left;
                                        color: #6c757d;
                                        font-size: 12px;
                                        margin-bottom: 20px;
                                        padding: 10px 0;
                                        border-bottom: 1px solid #e9ecef;
                                    }
                                    .card {
                                        margin-bottom: 30px;
                                        border: none;
                                        border-radius: 15px;
                                        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
                                        page-break-inside: avoid;
                                        overflow: hidden;
                                        transition: all 0.3s ease;
                                    }

                                    .card:hover {
                                        transform: translateY(-2px);
                                        box-shadow: 0 12px 35px rgba(0,0,0,0.15);
                                    }

                                    .card-header {
                                        padding: 20px 25px;
                                        border-bottom: none;
                                        font-weight: 600;
                                        font-size: 16px;
                                        position: relative;
                                        overflow: hidden;
                                    }

                                    .card-header::before {
                                        content: '';
                                        position: absolute;
                                        top: 0;
                                        left: 0;
                                        right: 0;
                                        bottom: 0;
                                        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
                                        pointer-events: none;
                                    }

                                    .card-body {
                                        padding: 25px;
                                    }

                                    .card-footer {
                                        padding: 15px 25px;
                                        background-color: rgba(0,0,0,0.02);
                                        border-top: 1px solid rgba(0,0,0,0.05);
                                        font-size: 14px;
                                        font-weight: 500;
                                    }

                                    .bg-primary {
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                                        color: white !important;
                                    }
                                    .bg-success {
                                        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
                                        color: white !important;
                                    }
                                    .bg-danger {
                                        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%) !important;
                                        color: white !important;
                                    }
                                    .bg-info {
                                        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%) !important;
                                        color: white !important;
                                    }
                                    .bg-light {
                                        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
                                        color: #495057 !important;
                                    }
                                    .table-responsive {
                                        border-radius: 10px;
                                        overflow: hidden;
                                        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
                                    }

                                    table {
                                        width: 100%;
                                        border-collapse: collapse;
                                        margin-bottom: 0;
                                        background: white;
                                    }

                                    th, td {
                                        padding: 15px 12px;
                                        border: none;
                                        text-align: right;
                                        vertical-align: middle;
                                        border-bottom: 1px solid rgba(0,0,0,0.05);
                                    }

                                    th {
                                        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                        font-weight: 600;
                                        font-size: 14px;
                                        color: #495057;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                        position: relative;
                                    }

                                    tbody tr {
                                        transition: all 0.2s ease;
                                    }

                                    tbody tr:hover {
                                        background-color: rgba(0,123,255,0.03);
                                        transform: scale(1.01);
                                    }

                                    .badge {
                                        padding: 8px 12px;
                                        border-radius: 20px;
                                        font-weight: 500;
                                        font-size: 12px;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                                        border: none;
                                    }

                                    .financial-item {
                                        background: white;
                                        border-radius: 15px;
                                        padding: 25px;
                                        text-align: center;
                                        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
                                        transition: all 0.3s ease;
                                        border: 1px solid rgba(0,0,0,0.05);
                                    }

                                    .financial-item:hover {
                                        transform: translateY(-3px);
                                        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
                                    }

                                    .financial-item h6 {
                                        font-size: 14px;
                                        font-weight: 500;
                                        margin-bottom: 10px;
                                        text-transform: uppercase;
                                        letter-spacing: 1px;
                                    }

                                    .financial-item h4 {
                                        font-size: 24px;
                                        font-weight: 700;
                                        margin: 0;
                                    }

                                    .progress {
                                        height: 25px;
                                        border-radius: 15px;
                                        background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
                                        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                                        overflow: hidden;
                                    }

                                    .progress-bar {
                                        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                                        border-radius: 15px;
                                        transition: all 0.3s ease;
                                        position: relative;
                                        overflow: hidden;
                                    }

                                    .progress-bar::before {
                                        content: '';
                                        position: absolute;
                                        top: 0;
                                        left: 0;
                                        right: 0;
                                        bottom: 0;
                                        background: linear-gradient(45deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.2) 75%, transparent 75%, transparent);
                                        background-size: 20px 20px;
                                        animation: progress-animation 1s linear infinite;
                                    }

                                    @keyframes progress-animation {
                                        0% { background-position: 0 0; }
                                        100% { background-position: 20px 0; }
                                    }

                                    .text-muted {
                                        color: #6c757d !important;
                                    }
                                    .text-center {
                                        text-align: center !important;
                                    }
                                    .alert {
                                        padding: 20px;
                                        margin-bottom: 25px;
                                        border: none;
                                        border-radius: 15px;
                                        font-weight: 500;
                                        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
                                    }
                                    .alert-info {
                                        color: #055160;
                                        background: linear-gradient(135deg, #d1ecf1 0%, #b8daff 100%);
                                        border-left: 4px solid #0dcaf0;
                                    }
                                    @media print {
                                        .no-print {
                                            display: none !important;
                                        }

                                        * {
                                            -webkit-print-color-adjust: exact !important;
                                            print-color-adjust: exact !important;
                                        }

                                        body {
                                            padding: 0 !important;
                                            margin: 0 !important;
                                            font-size: 10pt !important;
                                            line-height: 1.2 !important;
                                            background: white !important;
                                            color: #000 !important;
                                        }

                                        .container {
                                            max-width: 100% !important;
                                            width: 100% !important;
                                            padding: 8px !important;
                                            margin: 0 !important;
                                            background: white !important;
                                            box-shadow: none !important;
                                            border-radius: 0 !important;
                                        }

                                        .report-header {
                                            background: #667eea !important;
                                            color: white !important;
                                            padding: 8px !important;
                                            margin-bottom: 8px !important;
                                            border-radius: 4px !important;
                                            page-break-inside: avoid !important;
                                            text-align: center !important;
                                        }

                                        .report-header::before {
                                            display: none !important;
                                        }

                                        .report-header h1 {
                                            font-size: 14pt !important;
                                            margin-bottom: 2px !important;
                                            text-shadow: none !important;
                                            margin-top: 0 !important;
                                        }

                                        .report-header .university-name {
                                            font-size: 11pt !important;
                                            margin-bottom: 2px !important;
                                        }

                                        .report-header .system-name {
                                            font-size: 9pt !important;
                                            margin-bottom: 0 !important;
                                        }

                                        .report-date {
                                            font-size: 9pt !important;
                                            padding: 4px 0 !important;
                                            margin-bottom: 8px !important;
                                            text-align: right !important;
                                        }

                                        .card {
                                            border: 1px solid #ddd !important;
                                            box-shadow: none !important;
                                            margin-bottom: 4px !important;
                                            border-radius: 2px !important;
                                            page-break-inside: avoid !important;
                                            background: white !important;
                                        }

                                        .card.mb-4 {
                                            margin-bottom: 3px !important;
                                        }

                                        .card:hover {
                                            transform: none !important;
                                            box-shadow: none !important;
                                        }

                                        .card-header {
                                            padding: 6px 10px !important;
                                            font-size: 11pt !important;
                                            font-weight: bold !important;
                                            border-bottom: 1px solid #ddd !important;
                                        }

                                        .card-header::before {
                                            display: none !important;
                                        }

                                        .bg-primary {
                                            background: #667eea !important;
                                            color: white !important;
                                        }

                                        .bg-success {
                                            background: #28a745 !important;
                                            color: white !important;
                                        }

                                        .bg-danger {
                                            background: #dc3545 !important;
                                            color: white !important;
                                        }

                                        .bg-info {
                                            background: #17a2b8 !important;
                                            color: white !important;
                                        }

                                        .card-body {
                                            padding: 6px !important;
                                        }

                                        .card-footer {
                                            padding: 4px 8px !important;
                                            background: #f8f9fa !important;
                                            border-top: 1px solid #ddd !important;
                                            font-size: 9pt !important;
                                        }

                                        .card-header.bg-info {
                                            background: #17a2b8 !important;
                                            color: white !important;
                                            padding: 6px 10px !important;
                                            font-size: 10pt !important;
                                        }

                                        .card-header h5 {
                                            margin: 0 !important;
                                            font-size: 10pt !important;
                                        }
                                        .table-responsive {
                                            border-radius: 0 !important;
                                            box-shadow: none !important;
                                            overflow: visible !important;
                                        }

                                        table {
                                            border: 2px solid #000 !important;
                                            background: white !important;
                                        }

                                        th, td {
                                            padding: 3px 4px !important;
                                            font-size: 9pt !important;
                                            border: 1px solid #000 !important;
                                            text-align: right !important;
                                            line-height: 1.1 !important;
                                        }

                                        th {
                                            background: #f8f9fa !important;
                                            font-weight: bold !important;
                                            color: #000 !important;
                                            text-transform: none !important;
                                            letter-spacing: normal !important;
                                        }

                                        tbody tr:hover {
                                            background: transparent !important;
                                            transform: none !important;
                                        }

                                        .table-striped tbody tr:nth-of-type(odd) {
                                            background: #f8f9fa !important;
                                        }

                                        .table-success th {
                                            background: #d1e7dd !important;
                                            color: #0f5132 !important;
                                        }

                                        .table-danger th {
                                            background: #f8d7da !important;
                                            color: #842029 !important;
                                        }

                                        .table-info th {
                                            background: #b6effb !important;
                                            color: #055160 !important;
                                        }

                                        .badge {
                                            border: 1px solid #000 !important;
                                            padding: 4px 8px !important;
                                            font-size: 10pt !important;
                                            border-radius: 4px !important;
                                            box-shadow: none !important;
                                            font-weight: bold !important;
                                            text-transform: none !important;
                                            letter-spacing: normal !important;
                                        }

                                        .badge.bg-success {
                                            background: #28a745 !important;
                                            color: white !important;
                                        }

                                        .badge.bg-danger {
                                            background: #dc3545 !important;
                                            color: white !important;
                                        }

                                        .badge.bg-info {
                                            background: #17a2b8 !important;
                                            color: white !important;
                                        }

                                        .badge.bg-secondary {
                                            background: #6c757d !important;
                                            color: white !important;
                                        }

                                        .financial-item {
                                            padding: 4px !important;
                                            border: 1px solid #ddd !important;
                                            border-radius: 2px !important;
                                            margin-bottom: 2px !important;
                                            background: #f8f9fa !important;
                                            box-shadow: none !important;
                                            transform: none !important;
                                            display: inline-block !important;
                                            width: 32% !important;
                                            margin-right: 1% !important;
                                            vertical-align: top !important;
                                            text-align: center !important;
                                        }

                                        .financial-item:hover {
                                            transform: none !important;
                                            box-shadow: none !important;
                                        }

                                        .financial-item h6 {
                                            font-size: 8pt !important;
                                            margin-bottom: 2px !important;
                                            text-transform: none !important;
                                            letter-spacing: normal !important;
                                            font-weight: bold !important;
                                            margin-top: 0 !important;
                                        }

                                        .financial-item h4 {
                                            font-size: 10pt !important;
                                            margin: 0 !important;
                                            line-height: 1.1 !important;
                                        }

                                        .row.text-center {
                                            display: block !important;
                                            text-align: center !important;
                                            margin: 0 !important;
                                        }

                                        .col-md-4 {
                                            display: inline-block !important;
                                            width: 32% !important;
                                            margin-right: 1% !important;
                                            vertical-align: top !important;
                                            padding: 0 !important;
                                        }

                                        .col-md-4:last-child {
                                            margin-right: 0 !important;
                                        }

                                        .progress {
                                            background: #e9ecef !important;
                                            height: 10px !important;
                                            border: 1px solid #000 !important;
                                            border-radius: 2px !important;
                                            box-shadow: none !important;
                                            margin-top: 4px !important;
                                            width: 100% !important;
                                        }

                                        .progress-bar {
                                            background: #28a745 !important;
                                            border-radius: 0 !important;
                                            font-size: 8pt !important;
                                            line-height: 10px !important;
                                        }

                                        .progress-bar::before {
                                            display: none !important;
                                        }

                                        .row.mt-3 {
                                            margin-top: 4px !important;
                                        }

                                        .col-12 {
                                            width: 100% !important;
                                            display: block !important;
                                        }

                                        .mt-3, .my-3 {
                                            margin-top: 4px !important;
                                        }

                                        .mb-3, .my-3 {
                                            margin-bottom: 4px !important;
                                        }

                                        .alert {
                                            border: 2px solid #17a2b8 !important;
                                            border-radius: 8px !important;
                                            background: #d1ecf1 !important;
                                            color: #055160 !important;
                                            box-shadow: none !important;
                                            padding: 15px !important;
                                        }

                                        p {
                                            margin-bottom: 0.5rem !important;
                                        }

                                        .fw-bold {
                                            font-weight: bold !important;
                                        }

                                        .text-primary {
                                            color: #0d6efd !important;
                                        }

                                        .text-success {
                                            color: #198754 !important;
                                        }

                                        .text-danger {
                                            color: #dc3545 !important;
                                        }

                                        .text-muted {
                                            color: #6c757d !important;
                                        }

                                        .info-group {
                                            background: #f8f9fa !important;
                                            border: 1px solid #ddd !important;
                                            border-radius: 2px !important;
                                            padding: 4px !important;
                                            margin-bottom: 2px !important;
                                        }

                                        .info-item {
                                            display: flex !important;
                                            justify-content: space-between !important;
                                            align-items: center !important;
                                            padding: 1px 0 !important;
                                            border-bottom: 1px solid #ddd !important;
                                        }

                                        .info-item:last-child {
                                            border-bottom: none !important;
                                        }

                                        .info-item-right {
                                            display: block !important;
                                            text-align: right !important;
                                            padding: 3px 0 !important;
                                            border-bottom: 1px solid #ddd !important;
                                            direction: rtl !important;
                                        }

                                        .info-item-right:last-child {
                                            border-bottom: none !important;
                                        }

                                        .info-item-right .info-label {
                                            display: inline-block !important;
                                            margin-left: 6px !important;
                                            font-weight: 500 !important;
                                            color: #000 !important;
                                            font-size: 8pt !important;
                                        }

                                        .info-item-right .info-value {
                                            display: inline-block !important;
                                            font-weight: bold !important;
                                            color: #000 !important;
                                            font-size: 8pt !important;
                                        }

                                        .info-label {
                                            font-weight: 500 !important;
                                            color: #000 !important;
                                            font-size: 8pt !important;
                                        }

                                        .info-value {
                                            font-weight: bold !important;
                                            color: #000 !important;
                                            font-size: 8pt !important;
                                        }

                                        .info-value.badge {
                                            background: #6c757d !important;
                                            color: white !important;
                                            padding: 1px 4px !important;
                                            border-radius: 2px !important;
                                            font-size: 7pt !important;
                                        }

                                        .row.g-4 {
                                            margin: 0 !important;
                                        }

                                        .col-md-6 {
                                            width: 48% !important;
                                            display: inline-block !important;
                                            vertical-align: top !important;
                                            margin-right: 2% !important;
                                            padding: 0 !important;
                                        }

                                        .col-md-6:last-child {
                                            margin-right: 0 !important;
                                        }

                                        h6 {
                                            font-size: 9pt !important;
                                            margin-bottom: 2px !important;
                                            margin-top: 0 !important;
                                        }

                                        /* Financial Summary Table Print Styles */
                                        .financial-summary-table {
                                            border-radius: 0 !important;
                                            box-shadow: none !important;
                                            margin-bottom: 8px !important;
                                        }

                                        .financial-summary-table table {
                                            border: 2px solid #000 !important;
                                            margin-bottom: 0 !important;
                                        }

                                        .financial-summary-table th {
                                            background: #667eea !important;
                                            color: white !important;
                                            font-weight: bold !important;
                                            font-size: 9pt !important;
                                            padding: 6px 4px !important;
                                            border: 1px solid #000 !important;
                                            text-align: center !important;
                                        }

                                        .financial-summary-table td {
                                            padding: 8px 6px !important;
                                            border: 1px solid #000 !important;
                                            font-size: 9pt !important;
                                            text-align: center !important;
                                        }

                                        .financial-row {
                                            background: #f8f9fa !important;
                                        }

                                        .percentage-row {
                                            background: #ffffff !important;
                                        }

                                        .financial-amount {
                                            font-size: 10pt !important;
                                            font-weight: bold !important;
                                            padding: 3px 8px !important;
                                            border-radius: 4px !important;
                                            display: inline-block !important;
                                            min-width: auto !important;
                                            text-align: center !important;
                                            box-shadow: none !important;
                                            border: 1px solid #000 !important;
                                        }

                                        .financial-amount:hover {
                                            transform: none !important;
                                            box-shadow: none !important;
                                        }

                                        .total-amount {
                                            background: #667eea !important;
                                            color: white !important;
                                        }

                                        .paid-amount {
                                            background: #28a745 !important;
                                            color: white !important;
                                        }

                                        .remaining-amount {
                                            background: #dc3545 !important;
                                            color: white !important;
                                        }

                                        .progress-enhanced {
                                            border-radius: 3px !important;
                                            background: #d6d8db !important;
                                            box-shadow: none !important;
                                            border: 2px solid #000 !important;
                                            height: 20px !important;
                                            margin-top: 6px !important;
                                            overflow: hidden !important;
                                        }

                                        .progress-enhanced .progress-bar {
                                            background: #198754 !important;
                                            border-radius: 0 !important;
                                            font-size: 9pt !important;
                                            line-height: 20px !important;
                                            overflow: visible !important;
                                            height: 20px !important;
                                            position: relative !important;
                                            border: 1px solid #000 !important;
                                        }

                                        .progress-enhanced .progress-bar::before {
                                            display: none !important;
                                        }

                                        .progress-text {
                                            font-size: 9pt !important;
                                            font-weight: bold !important;
                                            line-height: 20px !important;
                                            display: flex !important;
                                            align-items: center !important;
                                            justify-content: center !important;
                                            text-align: center !important;
                                            white-space: nowrap !important;
                                            overflow: hidden !important;
                                            position: absolute !important;
                                            top: 0 !important;
                                            left: 0 !important;
                                            right: 0 !important;
                                            bottom: 0 !important;
                                            z-index: 15 !important;
                                            text-shadow: 1px 1px 2px rgba(0,0,0,0.8) !important;
                                            color: white !important;
                                            padding: 0 4px !important;
                                            margin: 0 !important;
                                            height: 20px !important;
                                            width: 100% !important;
                                            text-overflow: ellipsis !important;
                                            vertical-align: middle !important;
                                        }

                                        .mt-4 {
                                            margin-top: 8px !important;
                                        }

                                        .mb-2 {
                                            margin-bottom: 4px !important;
                                        }

                                        .mt-2 {
                                            margin-top: 4px !important;
                                        }

                                        .d-flex {
                                            display: flex !important;
                                        }

                                        .justify-content-between {
                                            justify-content: space-between !important;
                                        }

                                        .text-sm {
                                            font-size: 8pt !important;
                                        }

                                        /* إضافة تحسينات للنص في شريط التقدم للطباعة */
                                        .progress {
                                            overflow: hidden !important;
                                            position: relative !important;
                                        }

                                        .progress-bar {
                                            overflow: visible !important;
                                            position: relative !important;
                                        }

                                        .progress-bar span {
                                            overflow: visible !important;
                                            white-space: nowrap !important;
                                            display: flex !important;
                                            align-items: center !important;
                                            justify-content: center !important;
                                            width: 100% !important;
                                            height: 100% !important;
                                            position: absolute !important;
                                            top: 0 !important;
                                            left: 0 !important;
                                            right: 0 !important;
                                            bottom: 0 !important;
                                        }

                                        /* تحسينات خاصة للطباعة */
                                        .mt-4 .progress-enhanced {
                                            page-break-inside: avoid !important;
                                        }

                                        .d-flex.justify-content-between.mt-2 {
                                            margin-top: 4px !important;
                                            font-size: 8pt !important;
                                        }

                                        /* تحسين إضافي للنص في الطباعة */
                                        .progress-enhanced .progress-bar .progress-text {
                                            font-family: Arial, sans-serif !important;
                                            font-weight: 900 !important;
                                            text-rendering: optimizeLegibility !important;
                                        }
                                    }

                                    .info-group {
                                        background: rgba(0,0,0,0.02);
                                        border-radius: 10px;
                                        padding: 20px;
                                        border: 1px solid rgba(0,0,0,0.05);
                                    }

                                    .info-item {
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        padding: 8px 0;
                                        border-bottom: 1px solid rgba(0,0,0,0.05);
                                    }

                                    .info-item:last-child {
                                        border-bottom: none;
                                    }

                                    .info-item-right {
                                        display: block;
                                        text-align: right;
                                        padding: 8px 0;
                                        border-bottom: 1px solid rgba(0,0,0,0.05);
                                        direction: rtl;
                                    }

                                    .info-item-right:last-child {
                                        border-bottom: none;
                                    }

                                    .info-item-right .info-label {
                                        display: inline-block;
                                        margin-left: 10px;
                                        font-weight: 500;
                                        color: #6c757d;
                                        font-size: 14px;
                                    }

                                    .info-item-right .info-value {
                                        display: inline-block;
                                        font-weight: 600;
                                        color: #2c3e50;
                                    }

                                    .info-label {
                                        font-weight: 500;
                                        color: #6c757d;
                                        font-size: 14px;
                                    }

                                    .info-value {
                                        font-weight: 600;
                                        color: #2c3e50;
                                    }

                                    /* Financial Summary Table Styles */
                                    .financial-summary-table {
                                        border-radius: 12px;
                                        overflow: hidden;
                                        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                                        margin-bottom: 0;
                                    }

                                    .financial-summary-table table {
                                        margin-bottom: 0;
                                        border: none;
                                    }

                                    .financial-summary-table th {
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        color: white;
                                        font-weight: 600;
                                        font-size: 14px;
                                        padding: 15px 10px;
                                        border: none;
                                        text-align: center;
                                    }

                                    .financial-summary-table td {
                                        padding: 20px 15px;
                                        border: none;
                                        border-bottom: 1px solid rgba(0,0,0,0.05);
                                        vertical-align: middle;
                                    }

                                    .financial-row {
                                        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
                                    }

                                    .percentage-row {
                                        background: linear-gradient(135deg, #ffffff 0%, #f1f3f4 100%);
                                    }

                                    .financial-amount {
                                        font-size: 20px;
                                        font-weight: 700;
                                        padding: 8px 16px;
                                        border-radius: 25px;
                                        display: inline-block;
                                        min-width: 120px;
                                        text-align: center;
                                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                                        transition: all 0.3s ease;
                                    }

                                    .financial-amount:hover {
                                        transform: translateY(-2px);
                                        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
                                    }

                                    .total-amount {
                                        background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
                                        color: white;
                                        border: 2px solid #0d6efd;
                                    }

                                    .paid-amount {
                                        background: linear-gradient(135deg, #198754 0%, #20c997 100%);
                                        color: white;
                                        border: 2px solid #198754;
                                    }

                                    .remaining-amount {
                                        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
                                        color: white;
                                        border: 2px solid #dc3545;
                                    }

                                    .progress-enhanced {
                                        border-radius: 15px;
                                        background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
                                        box-shadow: inset 0 2px 4px rgba(0,0,0,0.25);
                                        overflow: hidden;
                                        border: 3px solid #495057;
                                    }

                                    .progress-enhanced .progress-bar {
                                        background: linear-gradient(135deg, #198754 0%, #20c997 100%);
                                        border-radius: 15px;
                                        position: relative;
                                        overflow: visible;
                                        box-shadow: 0 2px 8px rgba(25, 135, 84, 0.6);
                                        border: 1px solid #157347;
                                    }

                                    .progress-enhanced .progress-bar::before {
                                        content: '';
                                        position: absolute;
                                        top: 0;
                                        left: 0;
                                        right: 0;
                                        bottom: 0;
                                        background: linear-gradient(45deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.2) 75%, transparent 75%, transparent);
                                        background-size: 20px 20px;
                                        animation: progress-animation 2s linear infinite;
                                    }

                                    .progress-text {
                                        font-size: 15px !important;
                                        font-weight: 800 !important;
                                        line-height: 40px !important;
                                        display: flex !important;
                                        align-items: center !important;
                                        justify-content: center !important;
                                        text-align: center !important;
                                        white-space: nowrap !important;
                                        overflow: hidden !important;
                                        position: absolute !important;
                                        top: 0 !important;
                                        left: 0 !important;
                                        right: 0 !important;
                                        bottom: 0 !important;
                                        z-index: 10 !important;
                                        color: #ffffff !important;
                                        text-shadow:
                                            2px 2px 4px rgba(0,0,0,0.8),
                                            1px 1px 2px rgba(0,0,0,0.9),
                                            0 0 3px rgba(0,0,0,0.7) !important;
                                        letter-spacing: 0.8px !important;
                                        text-stroke: 1px rgba(0,0,0,0.5);
                                        -webkit-text-stroke: 1px rgba(0,0,0,0.3);
                                        padding: 0 8px !important;
                                        margin: 0 !important;
                                        height: 40px !important;
                                        width: 100% !important;
                                    }

                                    @keyframes progress-animation {
                                        0% { background-position: 0 0; }
                                        100% { background-position: 20px 0; }
                                    }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <div class="report-header">
                                        <h1><i class="fas fa-university"></i> تقرير حالة الدفع</h1>
                                        <div class="university-name">جامعة الحاضرة - نظام التسجيل الإلكتروني</div>
                                        <div class="system-name">نظام إدارة الطلاب والمواد الدراسية</div>
                                    </div>

                                    <div class="report-date">
                                        <i class="fas fa-calendar-alt"></i> تاريخ التقرير: ${new Date().toLocaleDateString('ar-LY', {
                                            weekday: 'long',
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric'
                                        })} - ${new Date().toLocaleTimeString('ar-LY', {
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </div>
                                    ${reportHtml}
                                    <div class="no-print text-center mt-4">
                                        <button class="btn btn-primary" onclick="window.print()">طباعة</button>
                                        <button class="btn btn-secondary" onclick="window.close()">إغلاق</button>
                                    </div>
                                </div>
                            </body>
                            </html>
                        `);
                        printWindow.document.close();
                    } catch (docError) {
                        console.error('Error accessing document:', docError);
                        alert('حدث خطأ أثناء إنشاء التقرير. يرجى التأكد من السماح بالنوافذ المنبثقة وإعادة المحاولة.');
                        if (printWindow && !printWindow.closed) {
                            printWindow.close();
                        }
                    }
                } catch (error) {
                    console.error('Error opening print window:', error);
                    alert(error.message || 'حدث خطأ أثناء فتح نافذة الطباعة. يرجى التأكد من السماح بالنوافذ المنبثقة وإعادة المحاولة.');
                }
            }

            // Cargar departamentos en el selector de filtro
            function loadDepartmentsIntoFilterSelect() {
                const departmentSelect = document.getElementById('filter-payment-department-select');
                if (!departmentSelect) return;

                fetch('/api/admin/departments')
                    .then(response => response.json())
                    .then(data => {
                        // Mantener la opción "Todos los departamentos"
                        const allOption = departmentSelect.querySelector('option[value=""]');
                        departmentSelect.innerHTML = '';
                        departmentSelect.appendChild(allOption);

                        // Agregar opciones de departamentos
                        data.departments.forEach(department => {
                            const option = document.createElement('option');
                            option.value = department.id;
                            option.textContent = department.name;
                            departmentSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading departments:', error);
                    });
            }

            // Cargar grupos en el selector de filtro
            function loadGroupsIntoFilterSelect() {
                const groupSelect = document.getElementById('filter-payment-group-select');
                if (!groupSelect) return;

                // Usar la API de students-enrollments para obtener datos más completos
                fetch('/api/admin/students-enrollments')
                    .then(response => response.json())
                    .then(data => {
                        // Mantener la opción "Todos los grupos"
                        const allOption = groupSelect.querySelector('option[value=""]');
                        groupSelect.innerHTML = '';
                        groupSelect.appendChild(allOption);

                        // Crear un conjunto para almacenar grupos únicos
                        const uniqueGroups = new Set();

                        // Recopilar SOLO los grupos únicos de estudiantes (no de inscripciones)
                        data.students.forEach(student => {
                            if (student.group_name && student.group_name.trim() !== '') {
                                uniqueGroups.add(student.group_name);
                            }
                        });

                        console.log('Grupos de estudiantes cargados:', Array.from(uniqueGroups));

                        // Agregar opciones de grupos
                        Array.from(uniqueGroups).sort().forEach(groupName => {
                            const option = document.createElement('option');
                            option.value = groupName;
                            option.textContent = `مجموعة ${groupName}`;
                            groupSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading groups:', error);
                    });
            }

            // Configurar eventos de filtrado
            function setupFilterEvents() {
                const searchInput = document.getElementById('search-input');
                const departmentSelect = document.getElementById('filter-payment-department-select');
                const semesterSelect = document.getElementById('filter-payment-semester-select');
                const groupSelect = document.getElementById('filter-payment-group-select');
                const paymentStatusSelect = document.getElementById('filter-payment-status-select');
                const resetFiltersBtn = document.getElementById('reset-payment-filters');
                const showFilteredReportBtn = document.getElementById('show-filtered-payment-report');

                // Evento de búsqueda
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        const searchTerm = this.value.trim();
                        const filterDepartment = departmentSelect ? departmentSelect.value : '';
                        const filterSemester = semesterSelect ? semesterSelect.value : '';
                        const filterGroup = groupSelect ? groupSelect.value : '';
                        const filterPaymentStatus = paymentStatusSelect ? paymentStatusSelect.value : '';

                        loadStudentsEnrollments(filterDepartment, filterSemester, filterGroup, filterPaymentStatus, searchTerm);
                    });
                }

                // Evento de cambio de departamento
                if (departmentSelect) {
                    departmentSelect.addEventListener('change', function() {
                        const filterDepartment = this.value;
                        const searchTerm = searchInput ? searchInput.value.trim() : '';
                        const filterSemester = semesterSelect ? semesterSelect.value : '';
                        const filterGroup = groupSelect ? groupSelect.value : '';
                        const filterPaymentStatus = paymentStatusSelect ? paymentStatusSelect.value : '';

                        loadStudentsEnrollments(filterDepartment, filterSemester, filterGroup, filterPaymentStatus, searchTerm);
                    });
                }

                // Evento de cambio de semestre
                if (semesterSelect) {
                    semesterSelect.addEventListener('change', function() {
                        const filterSemester = this.value;
                        const searchTerm = searchInput ? searchInput.value.trim() : '';
                        const filterDepartment = departmentSelect ? departmentSelect.value : '';
                        const filterGroup = groupSelect ? groupSelect.value : '';
                        const filterPaymentStatus = paymentStatusSelect ? paymentStatusSelect.value : '';

                        loadStudentsEnrollments(filterDepartment, filterSemester, filterGroup, filterPaymentStatus, searchTerm);
                    });
                }

                // Evento de cambio de grupo
                if (groupSelect) {
                    groupSelect.addEventListener('change', function() {
                        const filterGroup = this.value;
                        const searchTerm = searchInput ? searchInput.value.trim() : '';
                        const filterDepartment = departmentSelect ? departmentSelect.value : '';
                        const filterSemester = semesterSelect ? semesterSelect.value : '';
                        const filterPaymentStatus = paymentStatusSelect ? paymentStatusSelect.value : '';

                        loadStudentsEnrollments(filterDepartment, filterSemester, filterGroup, filterPaymentStatus, searchTerm);
                    });
                }

                // Evento de cambio de estado de pago
                if (paymentStatusSelect) {
                    paymentStatusSelect.addEventListener('change', function() {
                        const filterPaymentStatus = this.value;
                        const searchTerm = searchInput ? searchInput.value.trim() : '';
                        const filterDepartment = departmentSelect ? departmentSelect.value : '';
                        const filterSemester = semesterSelect ? semesterSelect.value : '';
                        const filterGroup = groupSelect ? groupSelect.value : '';

                        loadStudentsEnrollments(filterDepartment, filterSemester, filterGroup, filterPaymentStatus, searchTerm);
                    });
                }

                // Evento de reseteo de filtros
                if (resetFiltersBtn) {
                    resetFiltersBtn.addEventListener('click', function() {
                        if (searchInput) searchInput.value = '';
                        if (departmentSelect) departmentSelect.value = '';
                        if (semesterSelect) semesterSelect.value = '';
                        if (groupSelect) groupSelect.value = '';
                        if (paymentStatusSelect) paymentStatusSelect.value = '';

                        // Ocultar mensaje "no hay resultados" si está visible
                        const noResults = document.getElementById('no-results');
                        if (noResults) {
                            noResults.classList.add('d-none');
                        }

                        // Mostrar indicador de carga
                        const loadingIndicator = document.getElementById('loading-indicator');
                        if (loadingIndicator) {
                            loadingIndicator.classList.remove('d-none');
                        }

                        loadStudentsEnrollments('', '', '', '', '');
                    });
                }

                // Evento para mostrar informe filtrado
                if (showFilteredReportBtn) {
                    showFilteredReportBtn.addEventListener('click', function() {
                        const filterDepartment = departmentSelect ? departmentSelect.value : '';
                        const filterSemester = semesterSelect ? semesterSelect.value : '';
                        const filterGroup = groupSelect ? groupSelect.value : '';
                        const filterPaymentStatus = paymentStatusSelect ? paymentStatusSelect.value : '';

                        openFilteredPaymentReportModal(filterDepartment, filterSemester, filterGroup, filterPaymentStatus);
                    });
                }

                // Configurar evento para imprimir informe filtrado
                const printFilteredReportBtn = document.getElementById('print-filtered-payment-report');
                if (printFilteredReportBtn) {
                    printFilteredReportBtn.addEventListener('click', function() {
                        const reportContent = document.getElementById('filtered-payment-report-content');
                        if (reportContent) {
                            printFilteredPaymentReport(reportContent.innerHTML);
                        }
                    });
                }
            }

            // Abrir modal de informe filtrado
            function openFilteredPaymentReportModal(filterDepartment, filterSemester, filterGroup, filterPaymentStatus) {
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('filteredPaymentReportModal'));
                modal.show();

                // Mostrar carga
                document.getElementById('filtered-payment-report-loading').classList.remove('d-none');
                document.getElementById('filtered-payment-report-error').classList.add('d-none');
                document.getElementById('filtered-payment-report-content').classList.add('d-none');

                // Obtener datos para el informe
                fetch('/api/admin/students-enrollments')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('فشل في تحميل البيانات');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Filtrar los estudiantes según los criterios
                        let filteredStudents = data.students;

                        // Filtrar por departamento
                        if (filterDepartment) {
                            console.log('Informe: Filtrando por departamento:', filterDepartment, 'Tipo:', typeof filterDepartment);

                            // Mostrar información detallada de cada estudiante y su departamento
                            console.log('Información detallada de estudiantes y sus departamentos:');
                            filteredStudents.forEach(student => {
                                console.log(`Estudiante: ${student.name} (ID: ${student.id})`);
                                console.log(`  Department ID: ${student.department_id}, Tipo: ${typeof student.department_id}`);
                                console.log(`  Department Name: ${student.department_name}`);
                            });

                            // Mostrar información de departamentos disponibles
                            const departamentosDisponibles = new Set();
                            filteredStudents.forEach(student => {
                                if (student.department_id) {
                                    departamentosDisponibles.add(String(student.department_id));
                                }
                            });
                            console.log('Informe: Departamentos disponibles en los datos:', Array.from(departamentosDisponibles));

                            // Asegurarse de que la comparación sea consistente (string vs string)
                            const filterDeptId = String(filterDepartment);
                            console.log('ID de departamento a filtrar (convertido a string):', filterDeptId);

                            // Obtener el nombre del departamento seleccionado para mostrar en el mensaje
                            const departmentSelect = document.getElementById('filter-payment-department-select');
                            const departmentName = departmentSelect ?
                                departmentSelect.options[departmentSelect.selectedIndex].text : 'التخصص المحدد';
                            console.log('Nombre del departamento seleccionado:', departmentName);

                            // Verificar si hay estudiantes con este departamento
                            const estudiantesFiltrados = filteredStudents.filter(student => {
                                // Convertir ambos valores a string para comparación consistente
                                const studentDeptId = student.department_id ? String(student.department_id) : '';

                                // Intentar diferentes formatos de comparación
                                const coincideExacto = studentDeptId === filterDeptId;
                                const coincideNumerico = parseInt(studentDeptId) === parseInt(filterDeptId);

                                // Verificar también por nombre de departamento si está disponible
                                const coincidePorNombre = student.department_name &&
                                    departmentName &&
                                    student.department_name.trim() === departmentName.trim();

                                const coincide = coincideExacto || coincideNumerico || coincidePorNombre;

                                console.log(`  Comparando: Estudiante ${student.name}, Dept ID: ${studentDeptId}, Dept Name: ${student.department_name}`);
                                console.log(`    con Filtro ID: ${filterDeptId}, Filtro Nombre: ${departmentName}`);
                                console.log(`    Coincide: ${coincide} (Exacto: ${coincideExacto}, Numérico: ${coincideNumerico}, Por Nombre: ${coincidePorNombre})`);

                                return coincide;
                            });

                            console.log('Informe: Estudiantes después del filtro de departamento:', estudiantesFiltrados.length);

                            // Si no hay resultados, mantener la lista vacía en lugar de mostrar todos los estudiantes
                            if (estudiantesFiltrados.length === 0) {
                                console.log('No se encontraron estudiantes para el departamento seleccionado');
                                filteredStudents = [];
                            } else {
                                console.log(`Se encontraron ${estudiantesFiltrados.length} estudiantes para el departamento seleccionado`);
                                filteredStudents = estudiantesFiltrados;
                            }
                        }

                        // Filtrar por estado de pago
                        if (filterPaymentStatus) {
                            console.log('Informe: Filtrando por estado de pago:', filterPaymentStatus);
                            console.log('Informe: Estudiantes antes del filtro de estado de pago:', filteredStudents.length);

                            // Mostrar información detallada de cada estudiante y sus inscripciones
                            filteredStudents.forEach(student => {
                                console.log(`Estudiante: ${student.name} (ID: ${student.id})`);
                                if (student.enrollments && student.enrollments.length > 0) {
                                    console.log(`  Tiene ${student.enrollments.length} inscripciones:`);
                                    student.enrollments.forEach((enrollment, index) => {
                                        console.log(`    ${index + 1}. Curso: ${enrollment.course_name}, Estado de pago: ${enrollment.payment_status}`);
                                    });

                                    // Verificar si todas las inscripciones están pagadas
                                    const todasPagadas = student.enrollments.every(enrollment =>
                                        enrollment.payment_status === 'paid' || enrollment.payment_status === 'خالص'
                                    );
                                    console.log(`  ¿Todas las inscripciones pagadas? ${todasPagadas ? 'SÍ' : 'NO'}`);

                                    // Verificar si alguna inscripción no está pagada
                                    const algunaNoPageada = student.enrollments.some(enrollment =>
                                        enrollment.payment_status === 'unpaid' || enrollment.payment_status === 'غير خالص'
                                    );
                                    console.log(`  ¿Alguna inscripción no pagada? ${algunaNoPageada ? 'SÍ' : 'NO'}`);
                                } else {
                                    console.log(`  No tiene inscripciones`);
                                }
                            });

                            // Filtrar estudiantes según el estado de pago de sus inscripciones
                            const estudiantesFiltrados = filteredStudents.filter(student => {
                                // Si el estudiante no tiene inscripciones, no coincide con ningún filtro de pago
                                if (!student.enrollments || student.enrollments.length === 0) {
                                    return false;
                                }

                                if (filterPaymentStatus === 'خالص') {
                                    // Para "خالص" (pagado), todas las inscripciones deben estar pagadas
                                    return student.enrollments.every(enrollment =>
                                        enrollment.payment_status === 'paid' || enrollment.payment_status === 'خالص'
                                    );
                                } else if (filterPaymentStatus === 'غير خالص') {
                                    // Para "غير خالص" (no pagado), al menos una inscripción debe estar sin pagar
                                    return student.enrollments.some(enrollment =>
                                        enrollment.payment_status === 'unpaid' || enrollment.payment_status === 'غير خالص'
                                    );
                                }

                                // Si el filtro no coincide con ninguno de los valores esperados, no filtrar
                                return true;
                            });

                            console.log('Informe: Estudiantes después del filtro de estado de pago:', estudiantesFiltrados.length);

                            // Si no hay resultados, mantener la lista vacía
                            if (estudiantesFiltrados.length === 0) {
                                filteredStudents = [];
                            } else {
                                filteredStudents = estudiantesFiltrados;
                            }
                        }

                        // Filtrar por semestre
                        if (filterSemester) {
                            console.log('Informe: Filtrando por semestre:', filterSemester);
                            console.log('Informe: Estudiantes antes del filtro de semestre:', filteredStudents.length);

                            // Mostrar información detallada de cada estudiante y su semestre
                            console.log('Información detallada de estudiantes y sus semestres:');
                            filteredStudents.forEach(student => {
                                console.log(`Estudiante: ${student.name} (ID: ${student.id})`);
                                console.log(`  Semestre: ${student.semester}`);
                            });

                            // Implementamos un filtro para el semestre considerando SOLO el semestre del estudiante
                            // y NO los semestres de sus inscripciones
                            const estudiantesFiltrados = filteredStudents.filter(student => {
                                // Verificar si el estudiante tiene un semestre asignado que coincide con el filtro
                                const coincide = student.semester && student.semester === filterSemester;

                                if (coincide) {
                                    console.log(`  Estudiante ${student.name} coincide por semestre: ${student.semester}`);
                                }

                                return coincide;
                            });

                            console.log('Informe: Estudiantes después del filtro de semestre:', estudiantesFiltrados.length);

                            // Si no hay resultados, mantener la lista vacía
                            if (estudiantesFiltrados.length === 0) {
                                console.log('No se encontraron estudiantes para el semestre seleccionado');
                                filteredStudents = [];
                            } else {
                                console.log(`Se encontraron ${estudiantesFiltrados.length} estudiantes para el semestre seleccionado`);
                                filteredStudents = estudiantesFiltrados;
                            }
                        }

                        // Filtrar por grupo de estudiante
                        if (filterGroup) {
                            console.log('Informe: Filtrando por grupo de estudiante:', filterGroup);

                            // Mostrar información detallada de cada estudiante y su grupo
                            console.log('Información detallada de estudiantes y sus grupos:');
                            filteredStudents.forEach(student => {
                                console.log(`Estudiante: ${student.name} (ID: ${student.id})`);
                                console.log(`  Grupo: ${student.group_name || 'No especificado'}, Tipo: ${typeof student.group_name}`);
                            });

                            // Mostrar información de grupos disponibles
                            const gruposDisponibles = new Set();
                            filteredStudents.forEach(student => {
                                if (student.group_name) {
                                    gruposDisponibles.add(student.group_name);
                                }
                            });
                            console.log('Informe: Grupos de estudiantes disponibles:', Array.from(gruposDisponibles));

                            // Implementamos un filtro para el grupo considerando SOLO el grupo del estudiante
                            // y NO los grupos de sus inscripciones
                            const estudiantesFiltrados = filteredStudents.filter(student => {
                                // Verificar coincidencia exacta
                                const coincideExacto = student.group_name === filterGroup;

                                // Verificar coincidencia ignorando mayúsculas/minúsculas
                                const coincideInsensible = student.group_name &&
                                    filterGroup &&
                                    student.group_name.toLowerCase() === filterGroup.toLowerCase();

                                // Verificar coincidencia parcial (contiene)
                                const coincideParcial = student.group_name &&
                                    filterGroup &&
                                    student.group_name.includes(filterGroup);

                                const coincide = coincideExacto || coincideInsensible || coincideParcial;

                                if (coincide) {
                                    console.log(`Estudiante ${student.name}, grupo: ${student.group_name}, coincide: ${coincide}`);
                                }

                                return coincide;
                            });

                            console.log('Informe: Estudiantes después del filtro de grupo:', estudiantesFiltrados.length);

                            // Si no hay resultados, mantener la lista vacía
                            if (estudiantesFiltrados.length === 0) {
                                console.log('No se encontraron estudiantes para el grupo seleccionado');
                                filteredStudents = [];
                            } else {
                                console.log(`Se encontraron ${estudiantesFiltrados.length} estudiantes para el grupo seleccionado`);
                                filteredStudents = estudiantesFiltrados;
                            }
                        }

                        // Generar el informe
                        generateFilteredPaymentReport(filteredStudents, filterDepartment, filterSemester, filterGroup);
                    })
                    .catch(error => {
                        console.error('Error loading data for report:', error);
                        document.getElementById('filtered-payment-report-loading').classList.add('d-none');
                        const errorElement = document.getElementById('filtered-payment-report-error');
                        errorElement.textContent = error.message || 'حدث خطأ أثناء تحميل البيانات';
                        errorElement.classList.remove('d-none');
                    });
            }

            // Generar informe de pago filtrado
            function generateFilteredPaymentReport(students, filterDepartment, filterSemester, filterGroup) {
                const reportContainer = document.getElementById('filtered-payment-report-content');

                // Ocultar carga y mostrar contenido
                document.getElementById('filtered-payment-report-loading').classList.add('d-none');
                reportContainer.classList.remove('d-none');

                // Si no hay estudiantes, mostrar mensaje
                if (students.length === 0) {
                    reportContainer.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            لا توجد بيانات مطابقة للتصنيف المحدد
                        </div>
                    `;
                    return;
                }

                // Obtener información de filtros para el título
                let filterInfo = '';
                if (filterDepartment) {
                    const departmentSelect = document.getElementById('filter-payment-department-select');
                    const departmentName = departmentSelect ?
                        departmentSelect.options[departmentSelect.selectedIndex].text : 'التخصص المحدد';
                    filterInfo += `تخصص: ${departmentName}`;
                }

                if (filterSemester) {
                    if (filterInfo) filterInfo += ' | ';
                    filterInfo += `الفصل الدراسي: ${filterSemester}`;
                }

                if (filterGroup) {
                    if (filterInfo) filterInfo += ' | ';
                    filterInfo += `المجموعة: ${filterGroup}`;
                }

                if (!filterInfo) {
                    filterInfo = 'جميع الطلبة';
                }

                // Calcular estadísticas
                const totalStudents = students.length;
                let totalPaidCourses = 0;
                let totalUnpaidCourses = 0;

                students.forEach(student => {
                    if (student.enrollments) {
                        student.enrollments.forEach(enrollment => {
                            if (enrollment.payment_status === 'خالص' || enrollment.payment_status === 'paid') {
                                totalPaidCourses++;
                            } else {
                                totalUnpaidCourses++;
                            }
                        });
                    }
                });

                const totalCourses = totalPaidCourses + totalUnpaidCourses;
                const paidPercentage = totalCourses > 0 ? ((totalPaidCourses / totalCourses) * 100).toFixed(2) : 0;

                // Generar HTML del informe
                let reportHtml = `
                    <div class="report-header mb-4">
                        <h4 class="text-center">تقرير حالة الدفع</h4>
                        <p class="text-center text-muted">${filterInfo}</p>
                        <p class="text-center">تاريخ التقرير: ${new Date().toLocaleDateString('ar-LY')}</p>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">عدد الطلبة</h5>
                                    <p class="card-text fs-4">${totalStudents}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">إجمالي المواد</h5>
                                    <p class="card-text fs-4">${totalCourses}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">المواد المدفوعة</h5>
                                    <p class="card-text fs-4">${totalPaidCourses}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">المواد غير المدفوعة</h5>
                                    <p class="card-text fs-4">${totalUnpaidCourses}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="progress mb-4" style="height: 25px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: ${paidPercentage}%;"
                            aria-valuenow="${paidPercentage}" aria-valuemin="0" aria-valuemax="100">
                            ${paidPercentage}% مدفوع
                        </div>
                        <div class="progress-bar bg-danger" role="progressbar" style="width: ${100 - paidPercentage}%;"
                            aria-valuenow="${100 - paidPercentage}" aria-valuemin="0" aria-valuemax="100">
                            ${(100 - paidPercentage).toFixed(2)}% غير مدفوع
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="table-primary">
                                <tr>
                                    <th>#</th>
                                    <th>رقم القيد</th>
                                    <th>اسم الطالب</th>
                                    <th>التخصص</th>
                                    <th>الفصل الدراسي</th>
                                    <th>المجموعة</th>
                                    <th>المواد المسجلة</th>
                                    <th>المواد المدفوعة</th>
                                    <th>المواد غير المدفوعة</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Agregar filas de estudiantes
                students.forEach((student, index) => {
                    // Contar materias pagadas y no pagadas
                    let paidCourses = 0;
                    let unpaidCourses = 0;

                    if (student.enrollments) {
                        student.enrollments.forEach(enrollment => {
                            if (enrollment.payment_status === 'خالص' || enrollment.payment_status === 'paid') {
                                paidCourses++;
                            } else {
                                unpaidCourses++;
                            }
                        });
                    }

                    const totalStudentCourses = paidCourses + unpaidCourses;

                    reportHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${student.student_id}</td>
                            <td>${student.name}</td>
                            <td>${student.department_name || 'غير محدد'}</td>
                            <td>${student.semester || 'غير محدد'}</td>
                            <td>${student.group_name || '-'}</td>
                            <td>${totalStudentCourses}</td>
                            <td><span class="badge bg-success">${paidCourses}</span></td>
                            <td><span class="badge bg-danger">${unpaidCourses}</span></td>
                        </tr>
                    `;
                });

                reportHtml += `
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-5">
                        <h5 class="text-center mb-4">تفاصيل المواد وأرقام الإيصالات</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-info">
                                    <tr>
                                        <th>#</th>
                                        <th>اسم الطالب</th>
                                        <th>رقم القيد</th>
                                        <th>رمز المادة</th>
                                        <th>اسم المادة</th>
                                        <th>حالة الدفع</th>
                                        <th>رقم الإيصال</th>
                                        <th>تاريخ التسجيل</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                // إضافة تفاصيل جميع المواد
                let enrollmentCounter = 1;
                students.forEach(student => {
                    if (student.enrollments && student.enrollments.length > 0) {
                        student.enrollments.forEach(enrollment => {
                            console.log('📊 Group Report - Processing enrollment:', enrollment);
                            console.log('📊 Group Report - Receipt number:', enrollment.receipt_number, 'Type:', typeof enrollment.receipt_number);

                            const paymentStatus = enrollment.payment_status === 'خالص' || enrollment.payment_status === 'paid' ? 'خالص' : 'غير خالص';
                            const paymentBadgeClass = paymentStatus === 'خالص' ? 'bg-success' : 'bg-danger';

                            // SIMPLIFIED: Check if receipt number is valid
                            console.log('📊 GROUP SIMPLE CHECK - Student:', student.name, 'Course:', enrollment.course_name, 'Receipt:', enrollment.receipt_number, 'Type:', typeof enrollment.receipt_number);

                            // Simple validation - just check if it exists and is not empty
                            const isValidReceipt = Boolean(enrollment.receipt_number && String(enrollment.receipt_number).trim() !== '');

                            console.log('📊 GROUP SIMPLE CHECK - Is valid:', isValidReceipt, 'Will display:', isValidReceipt ? enrollment.receipt_number : '-');

                            const receiptNumber = isValidReceipt ? enrollment.receipt_number : '-';
                            const receiptBadgeClass = receiptNumber !== '-' ? 'bg-info text-white' : 'bg-secondary text-white';

                            // تنسيق تاريخ التسجيل
                            const enrollmentDate = new Date(enrollment.created_at);
                            const formattedDate = enrollmentDate.toLocaleDateString('ar-LY');

                            reportHtml += `
                                <tr>
                                    <td>${enrollmentCounter}</td>
                                    <td>${student.name}</td>
                                    <td>${student.student_id}</td>
                                    <td>${enrollment.course_code}</td>
                                    <td>${enrollment.course_name || enrollment.name || 'غير محدد'}</td>
                                    <td><span class="badge ${paymentBadgeClass} text-white">${paymentStatus}</span></td>
                                    <td><span class="badge ${receiptBadgeClass}">${receiptNumber}</span></td>
                                    <td>${formattedDate}</td>
                                </tr>
                            `;
                            enrollmentCounter++;
                        });
                    }
                });

                reportHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                // Actualizar contenido del informe
                reportContainer.innerHTML = reportHtml;
            }

            // Imprimir informe filtrado
            function printFilteredPaymentReport(reportContent) {
                try {
                    // Crear ventana para imprimir
                    const printWindow = window.open('', '_blank');

                    // Check if the window was successfully opened
                    if (!printWindow || printWindow.closed || typeof printWindow.document === 'undefined') {
                        throw new Error('تم حظر النافذة المنبثقة. يرجى السماح بالنوافذ المنبثقة لهذا الموقع وإعادة المحاولة.');
                    }

                    // Try to access document to ensure it's available
                    try {
                        // Write content to the new window
                        printWindow.document.write(`
                            <!DOCTYPE html>
                            <html lang="ar" dir="rtl">
                            <head>
                                <meta charset="UTF-8">
                                <title>تقرير حالة الدفع</title>
                                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
                                <style>
                                    body {
                                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                        direction: rtl;
                                        text-align: right;
                                        padding: 20px;
                                        color: #333;
                                        line-height: 1.6;
                                    }
                                    .container {
                                        max-width: 1200px;
                                        margin: 0 auto;
                                    }
                                    .report-header {
                                        text-align: center;
                                        margin-bottom: 30px;
                                        border-bottom: 2px solid #0d6efd;
                                        padding-bottom: 15px;
                                    }
                                    .report-header h4 {
                                        font-size: 24px;
                                        color: #0d6efd;
                                        margin-bottom: 5px;
                                    }
                                    .report-header p {
                                        color: #6c757d;
                                        font-size: 14px;
                                        margin-top: 0;
                                    }
                                    table {
                                        width: 100%;
                                        border-collapse: collapse;
                                        margin-bottom: 20px;
                                    }
                                    th, td {
                                        padding: 8px;
                                        border: 1px solid #ddd;
                                        text-align: right;
                                    }
                                    th {
                                        background-color: #f2f2f2;
                                    }
                                    .badge {
                                        padding: 5px 10px;
                                        border-radius: 4px;
                                        font-weight: bold;
                                    }
                                    .bg-success {
                                        background-color: #198754 !important;
                                        color: white !important;
                                    }
                                    .bg-danger {
                                        background-color: #dc3545 !important;
                                        color: white !important;
                                    }
                                    .bg-primary {
                                        background-color: #0d6efd !important;
                                        color: white !important;
                                    }
                                    .bg-info {
                                        background-color: #0dcaf0 !important;
                                        color: white !important;
                                    }
                                    .bg-secondary {
                                        background-color: #6c757d !important;
                                        color: white !important;
                                    }
                                    .bg-light {
                                        background-color: #f8f9fa !important;
                                    }
                                    .text-white {
                                        color: white !important;
                                    }
                                    .progress {
                                        display: flex;
                                        height: 25px;
                                        overflow: hidden;
                                        font-size: 0.75rem;
                                        background-color: #e9ecef;
                                        border-radius: 0.25rem;
                                        margin-bottom: 1rem;
                                    }
                                    .progress-bar {
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        overflow: hidden;
                                        color: #fff;
                                        text-align: center;
                                        white-space: nowrap;
                                        transition: width 0.6s ease;
                                    }
                                    @media print {
                                        .no-print {
                                            display: none;
                                        }
                                        body {
                                            padding: 0;
                                            font-size: 11pt;
                                            margin: 0;
                                        }
                                        .container {
                                            max-width: 100%;
                                            width: 100%;
                                            padding: 0;
                                            margin: 0;
                                        }
                                        th, td {
                                            padding: 4px !important;
                                            font-size: 10pt !important;
                                        }
                                        th {
                                            background-color: #f2f2f2 !important;
                                            -webkit-print-color-adjust: exact;
                                            print-color-adjust: exact;
                                        }
                                        .badge {
                                            border: 1px solid #ddd !important;
                                            padding: 2px 5px !important;
                                            font-size: 9pt !important;
                                        }
                                        .bg-success {
                                            background-color: #198754 !important;
                                            color: white !important;
                                            -webkit-print-color-adjust: exact;
                                            print-color-adjust: exact;
                                        }
                                        .bg-danger {
                                            background-color: #dc3545 !important;
                                            color: white !important;
                                            -webkit-print-color-adjust: exact;
                                            print-color-adjust: exact;
                                        }
                                        .bg-primary {
                                            background-color: #0d6efd !important;
                                            color: white !important;
                                            -webkit-print-color-adjust: exact;
                                            print-color-adjust: exact;
                                        }
                                        .bg-info {
                                            background-color: #0dcaf0 !important;
                                            color: white !important;
                                            -webkit-print-color-adjust: exact;
                                            print-color-adjust: exact;
                                        }
                                        .bg-secondary {
                                            background-color: #6c757d !important;
                                            color: white !important;
                                            -webkit-print-color-adjust: exact;
                                            print-color-adjust: exact;
                                        }
                                        .table-info th {
                                            background-color: #cff4fc !important;
                                            color: #055160 !important;
                                            -webkit-print-color-adjust: exact;
                                            print-color-adjust: exact;
                                        }
                                        .progress-bar.bg-success {
                                            background-color: #198754 !important;
                                            color: white !important;
                                            -webkit-print-color-adjust: exact;
                                            print-color-adjust: exact;
                                        }
                                        .progress-bar.bg-danger {
                                            background-color: #dc3545 !important;
                                            color: white !important;
                                            -webkit-print-color-adjust: exact;
                                            print-color-adjust: exact;
                                        }
                                    }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    ${reportContent}
                                    <div class="no-print text-center mt-4">
                                        <button class="btn btn-primary" onclick="window.print()">طباعة</button>
                                        <button class="btn btn-secondary" onclick="window.close()">إغلاق</button>
                                    </div>
                                </div>
                            </body>
                            </html>
                        `);
                        printWindow.document.close();
                    } catch (docError) {
                        console.error('Error accessing document:', docError);
                        alert('حدث خطأ أثناء إنشاء التقرير. يرجى التأكد من السماح بالنوافذ المنبثقة وإعادة المحاولة.');
                        if (printWindow && !printWindow.closed) {
                            printWindow.close();
                        }
                    }
                } catch (error) {
                    console.error('Error opening print window:', error);
                    alert(error.message || 'حدث خطأ أثناء فتح نافذة الطباعة. يرجى التأكد من السماح بالنوافذ المنبثقة وإعادة المحاولة.');
                }
            }



            // Setup receipt number modal functionality
            function setupReceiptNumberModal() {
                console.log('Setting up receipt number modal...');

                const confirmReceiptButton = document.getElementById('confirmReceiptButton');
                const receiptNumberInput = document.getElementById('receiptNumberInput');
                const scanQRButton = document.getElementById('scanQRButton');
                const receiptError = document.getElementById('receiptError');
                const modal = document.getElementById('receiptNumberModal');

                console.log('Modal elements found:', {
                    confirmReceiptButton: !!confirmReceiptButton,
                    receiptNumberInput: !!receiptNumberInput,
                    scanQRButton: !!scanQRButton,
                    receiptError: !!receiptError,
                    modal: !!modal
                });

                // Handle Enter key in receipt input
                if (receiptNumberInput) {
                    receiptNumberInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleConfirmPayment();
                        }
                    });

                    // Clear error when user starts typing
                    receiptNumberInput.addEventListener('input', function() {
                        if (receiptError) {
                            receiptError.classList.add('d-none');
                        }
                    });
                }

                // Handle QR scan button
                if (scanQRButton) {
                    scanQRButton.addEventListener('click', function() {
                        startQRScanner();
                    });
                }

                // Handle modal shown event to focus input
                if (modal) {
                    modal.addEventListener('shown.bs.modal', function() {
                        if (receiptNumberInput) {
                            receiptNumberInput.focus();
                        }
                    });
                }
            }

            // Global function to handle confirm payment (called from onclick)
            window.handleConfirmPayment = function() {
                console.log('handleConfirmPayment called');

                const receiptNumberInput = document.getElementById('receiptNumberInput');
                const receiptError = document.getElementById('receiptError');
                const modal = document.getElementById('receiptNumberModal');

                if (!receiptNumberInput) {
                    console.error('Receipt input not found');
                    alert('خطأ: لم يتم العثور على حقل رقم الإيصال');
                    return;
                }

                const receiptNumber = receiptNumberInput.value.trim();
                console.log('Receipt number:', receiptNumber);

                // Validate receipt number
                if (!receiptNumber) {
                    showReceiptError('رقم الإيصال مطلوب');
                    return;
                }

                if (receiptNumber.length < 3) {
                    showReceiptError('رقم الإيصال يجب أن يكون 3 أرقام على الأقل');
                    return;
                }

                // Hide error if validation passes
                if (receiptError) {
                    receiptError.classList.add('d-none');
                }

                // Update payment status with receipt number
                console.log('Current payment data:', {
                    currentEnrollmentId,
                    currentPaymentStatus,
                    currentPaymentButton: !!currentPaymentButton
                });

                if (currentEnrollmentId && currentPaymentStatus && currentPaymentButton) {
                    // Clear receipt input
                    receiptNumberInput.value = '';

                    updatePaymentStatus(currentEnrollmentId, currentPaymentStatus, receiptNumber, currentPaymentButton);

                    // Hide modal
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }

                    // Clear global variables
                    currentEnrollmentId = null;
                    currentPaymentStatus = null;
                    currentPaymentButton = null;
                } else {
                    console.error('Missing payment data:', {
                        currentEnrollmentId,
                        currentPaymentStatus,
                        currentPaymentButton: !!currentPaymentButton
                    });
                    alert('حدث خطأ: بيانات الدفع غير مكتملة. يرجى إعادة المحاولة.');
                }
            };

            // QR Scanner functionality
            let currentStream = null;
            let currentDeviceIndex = 0;
            let availableDevices = [];

            // Function to start QR scanner
            window.startQRScanner = function() {
                console.log('Starting QR scanner...');

                // Create QR scanner modal
                const qrModalHtml = `
                    <div class="modal fade" id="qrScannerModal" tabindex="-1" aria-labelledby="qrScannerModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title" id="qrScannerModalLabel">
                                        <i class="fas fa-qrcode me-2"></i>
                                        مسح QR Code أو Barcode
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="stopQRCamera()"></button>
                                </div>
                                <div class="modal-body text-center">
                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        وجه الكاميرا نحو QR Code أو Barcode الخاص برقم الإيصال
                                        <br><small>يدعم: QR Code, Code128, Code39, EAN-13, EAN-8, UPC-A, UPC-E</small>
                                    </div>

                                    <div class="camera-container position-relative">
                                        <video id="qr-video" class="w-100" style="max-height: 400px; border-radius: 10px;" autoplay muted playsinline></video>
                                        <div id="qr-overlay" class="position-absolute top-50 start-50 translate-middle" style="border: 2px solid #28a745; width: 200px; height: 200px; border-radius: 10px; pointer-events: none;"></div>
                                    </div>

                                    <div id="qr-status" class="mt-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">جاري البحث عن الكاميرا...</span>
                                        </div>
                                        <p class="mt-2">جاري البحث عن الكاميرا...</p>
                                    </div>

                                    <div id="qr-debug" class="mt-3 d-none">
                                        <div class="alert alert-info">
                                            <small>
                                                <strong>معلومات التشخيص:</strong><br>
                                                <span id="qr-debug-text">جاري التحميل...</span>
                                            </small>
                                        </div>
                                    </div>

                                    <div id="qr-error" class="alert alert-danger d-none mt-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <span id="qr-error-text"></span>
                                        <div class="mt-2">
                                            <button class="btn btn-outline-primary btn-sm" onclick="retryQRCamera()">
                                                <i class="fas fa-redo me-2"></i>إعادة المحاولة
                                            </button>
                                            <button class="btn btn-outline-info btn-sm ms-2" onclick="testQRLibrary()">
                                                <i class="fas fa-flask me-2"></i>اختبار المكتبة
                                            </button>
                                            <button class="btn btn-outline-warning btn-sm ms-2" onclick="openDiagnostic()">
                                                <i class="fas fa-bug me-2"></i>تشخيص متقدم
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="stopQRCamera()">
                                        <i class="fas fa-times me-2"></i>إلغاء
                                    </button>
                                    <button type="button" class="btn btn-outline-success" onclick="manualEntryFromQR()">
                                        <i class="fas fa-keyboard me-2"></i>إدخال يدوي
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="switchCamera()" id="switch-camera-btn" style="display: none;">
                                        <i class="fas fa-camera me-2"></i>تبديل الكاميرا
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing QR modal if any
                const existingQRModal = document.getElementById('qrScannerModal');
                if (existingQRModal) {
                    existingQRModal.remove();
                }

                // Add QR modal to page
                document.body.insertAdjacentHTML('beforeend', qrModalHtml);

                // Show QR modal
                const qrModal = new bootstrap.Modal(document.getElementById('qrScannerModal'));
                qrModal.show();

                // Start camera after modal is shown
                setTimeout(() => {
                    initQRCamera();
                }, 500);
            };

            // Function to test QR and Barcode libraries
            window.testQRLibrary = function() {
                const debugDiv = document.getElementById('qr-debug');
                const debugText = document.getElementById('qr-debug-text');

                if (debugDiv) debugDiv.classList.remove('d-none');

                let debugInfo = '';
                debugInfo += `jsQR متاح: ${typeof jsQR !== 'undefined' ? 'نعم ✅' : 'لا ❌'}<br>`;
                debugInfo += `ZXing متاح: ${typeof ZXing !== 'undefined' ? 'نعم ✅' : 'لا ❌'}<br>`;
                debugInfo += `getUserMedia متاح: ${navigator.mediaDevices && navigator.mediaDevices.getUserMedia ? 'نعم ✅' : 'لا ❌'}<br>`;
                debugInfo += `Canvas متاح: ${document.createElement('canvas').getContext ? 'نعم ✅' : 'لا ❌'}<br>`;
                debugInfo += `المتصفح: ${navigator.userAgent.includes('Chrome') ? 'Chrome' : navigator.userAgent.includes('Firefox') ? 'Firefox' : 'أخرى'}<br>`;

                if (debugText) debugText.innerHTML = debugInfo;

                // Test jsQR
                if (typeof jsQR !== 'undefined') {
                    console.log('jsQR library is available');
                    debugInfo += `اختبار jsQR: نجح ✅<br>`;
                } else {
                    console.error('jsQR library is not available');
                    debugInfo += `اختبار jsQR: فشل ❌<br>`;
                }

                // Test ZXing
                if (typeof ZXing !== 'undefined') {
                    try {
                        const testReader = new ZXing.BrowserMultiFormatReader();
                        console.log('ZXing barcode reader initialized successfully');
                        debugInfo += `اختبار ZXing: نجح ✅<br>`;
                        debugInfo += `أنواع Barcode المدعومة: Code128, Code39, EAN-13, EAN-8, UPC-A, UPC-E<br>`;
                    } catch (error) {
                        console.error('Error testing ZXing:', error);
                        debugInfo += `اختبار ZXing: فشل ❌<br>`;
                    }
                } else {
                    console.error('ZXing library is not available');
                    debugInfo += `اختبار ZXing: غير متاح ❌<br>`;
                }

                if (debugText) debugText.innerHTML = debugInfo;
            };

            // Function to initialize QR camera
            function initQRCamera() {
                console.log('Initializing QR camera...');

                const video = document.getElementById('qr-video');
                const status = document.getElementById('qr-status');
                const errorDiv = document.getElementById('qr-error');

                if (!video) {
                    console.error('Video element not found');
                    return;
                }

                // Test jsQR availability first
                if (typeof jsQR === 'undefined') {
                    showQRError('مكتبة jsQR غير متاحة. يرجى إعادة تحميل الصفحة أو التحقق من الاتصال بالإنترنت.');
                    return;
                }

                // Get available cameras
                navigator.mediaDevices.enumerateDevices()
                    .then(devices => {
                        availableDevices = devices.filter(device => device.kind === 'videoinput');
                        console.log('Available cameras:', availableDevices.length);

                        if (availableDevices.length > 1) {
                            const switchBtn = document.getElementById('switch-camera-btn');
                            if (switchBtn) switchBtn.style.display = 'block';
                        }

                        return startCamera();
                    })
                    .catch(error => {
                        console.error('Error enumerating devices:', error);
                        showQRError('فشل في الوصول للكاميرا: ' + error.message);
                    });
            }

            // Function to start camera
            function startCamera() {
                const video = document.getElementById('qr-video');
                const status = document.getElementById('qr-status');

                const constraints = {
                    video: {
                        facingMode: currentDeviceIndex === 0 ? 'environment' : 'user',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };

                // If specific device is selected
                if (availableDevices.length > 0 && availableDevices[currentDeviceIndex]) {
                    constraints.video.deviceId = { exact: availableDevices[currentDeviceIndex].deviceId };
                }

                return navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        currentStream = stream;
                        video.srcObject = stream;

                        status.innerHTML = `
                            <div class="text-success">
                                <i class="fas fa-camera text-success fs-4"></i>
                                <p class="mt-2 mb-0">الكاميرا جاهزة - وجه الكاميرا نحو الكود</p>
                                <small class="text-muted">
                                    حجم الفيديو: ${video.videoWidth}x${video.videoHeight}<br>
                                    يدعم: QR Code, Code128, Code39, EAN-13, UPC-A
                                </small>
                            </div>
                        `;

                        // Show debug info
                        const debugDiv = document.getElementById('qr-debug');
                        const debugText = document.getElementById('qr-debug-text');
                        if (debugDiv && debugText) {
                            debugDiv.classList.remove('d-none');
                            debugText.innerHTML = `
                                الكاميرا: نشطة ✅<br>
                                حجم الفيديو: ${video.videoWidth}x${video.videoHeight}<br>
                                jsQR: ${typeof jsQR !== 'undefined' ? 'متاح ✅' : 'غير متاح ❌'}<br>
                                ZXing: ${typeof ZXing !== 'undefined' ? 'متاح ✅' : 'غير متاح ❌'}<br>
                                جاري البحث عن الرموز...<br>
                                <small>نصيحة: اقترب من الكود (10-30 سم) وثبت الكاميرا</small>
                            `;
                        }

                        // Start QR code detection
                        startQRDetection();
                    })
                    .catch(error => {
                        console.error('Error accessing camera:', error);
                        let errorMessage = 'فشل في الوصول للكاميرا';

                        if (error.name === 'NotAllowedError') {
                            errorMessage = 'تم رفض الوصول للكاميرا. يرجى السماح بالوصول للكاميرا وإعادة المحاولة.';
                        } else if (error.name === 'NotFoundError') {
                            errorMessage = 'لم يتم العثور على كاميرا. تأكد من وجود كاميرا متصلة.';
                        } else if (error.name === 'NotReadableError') {
                            errorMessage = 'الكاميرا مستخدمة من تطبيق آخر. أغلق التطبيقات الأخرى وحاول مرة أخرى.';
                        }

                        showQRError(errorMessage);
                    });
            }

            // Function to start QR and Barcode detection
            function startQRDetection() {
                const video = document.getElementById('qr-video');

                if (!video) {
                    console.error('Video element not found for QR detection');
                    return;
                }

                console.log('Starting QR and Barcode detection...');
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                let scanCount = 0;
                let lastScanTime = 0;

                function scanFrame() {
                    try {
                        const now = Date.now();

                        // Limit scanning to 10 FPS to improve performance
                        if (now - lastScanTime < 100) {
                            if (currentStream && currentStream.active) {
                                requestAnimationFrame(scanFrame);
                            }
                            return;
                        }
                        lastScanTime = now;

                        if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0 && video.videoHeight > 0) {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;

                            // Draw the video frame to canvas
                            context.drawImage(video, 0, 0, canvas.width, canvas.height);

                            // Try QR Code detection first (most reliable)
                            if (typeof jsQR !== 'undefined') {
                                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

                                // Try multiple inversion attempts for better detection
                                const qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
                                    inversionAttempts: "attemptBoth",
                                });

                                if (qrCode && qrCode.data) {
                                    console.log('QR Code detected:', qrCode.data);
                                    handleCodeResult(qrCode.data, 'QR Code');
                                    return;
                                }

                                // If first attempt failed, try with different settings
                                const qrCode2 = jsQR(imageData.data, imageData.width, imageData.height, {
                                    inversionAttempts: "onlyInvert",
                                });

                                if (qrCode2 && qrCode2.data) {
                                    console.log('QR Code detected (inverted):', qrCode2.data);
                                    handleCodeResult(qrCode2.data, 'QR Code');
                                    return;
                                }
                            }

                            // Try Barcode detection (every 3rd frame to reduce load)
                            if (scanCount % 3 === 0 && typeof ZXing !== 'undefined') {
                                try {
                                    const codeReader = new ZXing.BrowserMultiFormatReader();
                                    const result = codeReader.decodeFromCanvas(canvas);
                                    if (result && result.text) {
                                        console.log('Barcode detected:', result.text, 'Format:', result.format);
                                        handleCodeResult(result.text, result.format || 'Barcode');
                                        return;
                                    }
                                } catch (barcodeError) {
                                    // Barcode not found, continue scanning
                                    if (scanCount % 90 === 0) { // Log barcode errors less frequently
                                        console.log('Barcode scan attempt failed (normal)');
                                    }
                                }
                            }

                            scanCount++;
                            if (scanCount % 50 === 0) { // Log every 50 frames (5 seconds at 10 FPS)
                                console.log('Scanning... Frame:', scanCount, 'Video size:', video.videoWidth, 'x', video.videoHeight);
                                console.log('Libraries available:', {
                                    jsQR: typeof jsQR !== 'undefined',
                                    ZXing: typeof ZXing !== 'undefined'
                                });
                            }
                        }
                    } catch (error) {
                        console.error('Error in code scanning:', error);
                    }

                    // Continue scanning
                    if (currentStream && currentStream.active) {
                        requestAnimationFrame(scanFrame);
                    }
                }

                // Wait for video to be ready
                if (video.readyState >= 2) {
                    console.log('Video ready, starting scan immediately');
                    scanFrame();
                } else {
                    video.addEventListener('loadeddata', () => {
                        console.log('Video loaded, starting scan...');
                        setTimeout(scanFrame, 500); // Small delay to ensure video is fully ready
                    });
                }
            }

            // Function to handle code result (QR Code or Barcode)
            function handleCodeResult(codeData, codeType) {
                console.log(`Processing ${codeType} data:`, codeData);

                const receiptNumber = extractReceiptNumber(codeData);

                if (receiptNumber) {
                    console.log('Receipt number extracted:', receiptNumber, 'from', codeType);

                    // Fill the receipt input
                    const receiptInput = document.getElementById('receiptNumberInput');
                    if (receiptInput) {
                        receiptInput.value = receiptNumber;
                    }

                    // Stop camera and close scanner modal
                    stopQRCamera();

                    // Close scanner modal
                    const scannerModal = document.getElementById('qrScannerModal');
                    if (scannerModal) {
                        const modalInstance = bootstrap.Modal.getInstance(scannerModal);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    }

                    // Show success message
                    showSuccessNotification(`تم مسح ${codeType} بنجاح!`, `رقم الإيصال: ${receiptNumber}`);

                    // Auto-confirm payment
                    setTimeout(() => {
                        handleConfirmPayment();
                    }, 500);
                } else {
                    // Show more helpful error message
                    const errorMessage = `
                        لم يتم العثور على رقم إيصال في ${codeType}.
                        <br><small>البيانات المقروءة: "${codeData}"</small>
                        <br><small>تأكد من أن الكود يحتوي على رقم الإيصال أو أدخل الرقم يدوياً.</small>
                    `;
                    showQRError(errorMessage);

                    // Auto-fill the code data in case user wants to edit it
                    const receiptInput = document.getElementById('receiptNumberInput');
                    if (receiptInput && codeData.trim()) {
                        receiptInput.value = codeData.trim();
                    }
                }
            }

            // Backward compatibility - keep old function name
            function handleQRResult(qrData) {
                handleCodeResult(qrData, 'QR Code');
            }

            // Function to extract receipt number from code data
            function extractReceiptNumber(codeData) {
                console.log('Extracting receipt number from:', codeData);

                // Clean the data
                const cleanData = String(codeData).trim();

                // If empty, return null
                if (!cleanData) {
                    console.log('Empty data provided');
                    return null;
                }

                // If the entire string is just numbers, use it (most common case)
                if (/^\d+$/.test(cleanData)) {
                    console.log('Found direct number:', cleanData);
                    return cleanData;
                }

                // Try to find the first sequence of digits (most flexible)
                const numberMatch = cleanData.match(/\d+/);
                if (numberMatch) {
                    const number = numberMatch[0];
                    console.log('Found first number in text:', number);
                    return number;
                }

                console.log('No valid receipt number found in:', cleanData);
                return null;
            }

            // Function to show QR error
            function showQRError(message) {
                const status = document.getElementById('qr-status');
                const errorDiv = document.getElementById('qr-error');
                const errorText = document.getElementById('qr-error-text');

                if (status) status.style.display = 'none';
                if (errorDiv) errorDiv.classList.remove('d-none');
                if (errorText) errorText.innerHTML = message; // Use innerHTML to support HTML
            }

            // Function to retry QR camera
            window.retryQRCamera = function() {
                const status = document.getElementById('qr-status');
                const errorDiv = document.getElementById('qr-error');

                if (status) status.style.display = 'block';
                if (errorDiv) errorDiv.classList.add('d-none');

                stopQRCamera();
                setTimeout(() => {
                    initQRCamera();
                }, 500);
            };

            // Function to switch camera
            window.switchCamera = function() {
                if (availableDevices.length > 1) {
                    currentDeviceIndex = (currentDeviceIndex + 1) % availableDevices.length;
                    console.log('Switching to camera:', currentDeviceIndex);

                    stopQRCamera();
                    setTimeout(() => {
                        startCamera();
                    }, 500);
                }
            };

            // Function to switch to manual entry from QR scanner
            window.manualEntryFromQR = function() {
                console.log('Switching to manual entry from QR scanner');

                // Stop camera
                stopQRCamera();

                // Close QR modal
                const qrModal = document.getElementById('qrScannerModal');
                if (qrModal) {
                    const modalInstance = bootstrap.Modal.getInstance(qrModal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }

                // Focus on receipt input in main modal
                setTimeout(() => {
                    const receiptInput = document.getElementById('receiptNumberInput');
                    if (receiptInput) {
                        receiptInput.focus();
                    }
                }, 500);
            };

            // Function to open diagnostic page
            window.openDiagnostic = function() {
                console.log('Opening diagnostic page');
                window.open('/simple-qr-test.html', '_blank');
            };

            // Function to stop QR camera
            window.stopQRCamera = function() {
                console.log('Stopping QR camera...');
                if (currentStream) {
                    currentStream.getTracks().forEach(track => {
                        console.log('Stopping track:', track.kind);
                        track.stop();
                    });
                    currentStream = null;
                    console.log('Camera stopped successfully');
                }
            };

            // Clean up camera when modal is closed
            document.addEventListener('hidden.bs.modal', function(event) {
                if (event.target.id === 'qrScannerModal') {
                    console.log('QR Scanner modal closed, cleaning up...');
                    stopQRCamera();

                    // Remove modal from DOM
                    setTimeout(() => {
                        const qrModal = document.getElementById('qrScannerModal');
                        if (qrModal) {
                            qrModal.remove();
                            console.log('QR Scanner modal removed from DOM');
                        }
                    }, 300);
                } else if (event.target.id === 'receiptNumberModal') {
                    console.log('Receipt modal closed, stopping any active camera...');
                    stopQRCamera();

                    // Clear global variables when receipt modal is closed
                    currentEnrollmentId = null;
                    currentPaymentStatus = null;
                    currentPaymentButton = null;
                }
            });

            // Also handle when user clicks the X button
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('btn-close') &&
                    event.target.closest('#qrScannerModal')) {
                    console.log('QR Scanner close button clicked');
                    stopQRCamera();
                }
            });

            // Initial load
            loadDepartmentsIntoFilterSelect();
            loadGroupsIntoFilterSelect();
            setupFilterEvents();
            loadStudentsEnrollments();

            // Setup receipt number modal event handlers after DOM is ready
            setTimeout(() => {
                setupReceiptNumberModal();
            }, 100);






        });
    </script>
</body>
</html>
